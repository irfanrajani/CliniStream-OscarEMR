<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Patient Refill Request</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        /* --- Core Styles --- */
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        h1, h2, h3 { color: #333; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 800px; margin: auto; }

        /* --- Patient Form --- */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input[type="text"], input[type="date"], input[type="number"], select, button {
            padding: 10px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; width: 100%;
        }
        input[readonly] { background-color: #e9ecef; }
        button { cursor: pointer; background-color: #007bff; color: white; border: none; margin-top: 10px; }
        button:hover { background-color: #0056b3; }

        /* --- History Buttons --- */
        #historyContainer { margin-bottom: 20px; }
        .history-section { border-top: 1px solid #eee; padding-top: 10px; margin-top: 15px; }
        .history-title { font-size: 16px; margin-bottom: 8px; color: #555; }
        .history-btn { 
            margin: 4px 4px 4px 0; padding: 8px 12px; font-size: 0.9em; 
            background-color: #e6f7ff; border: 1px solid #b3e0ff; color: #0056b3;
            border-radius: 4px; cursor: pointer; display: inline-block;
        }
        .history-btn:hover { background-color: #d0edff; }

        /* --- Medication Entry --- */
        .medication-entry-row { border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; background-color: #f9f9f9; border-radius: 5px; }
        .medication-fields-grid { display: grid; grid-template-columns: 3fr 2fr; gap: 20px; margin-bottom: 15px; }
        .sig-structured-area { border-top: 1px dashed #ccc; margin-top: 15px; padding-top: 15px; }
        .sig-structured-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; align-items: end; margin-bottom: 10px; }
        .sig-additional-info { margin-top: 10px; }
        .form-hint { color: #6c757d; font-size: 0.85em; margin-top: 3px; font-style: italic; }

        /* --- Suggestion Box --- */
        .suggestion-box { position: absolute; background: #fff; border: 1px solid #aaa; z-index: 9999; max-height: 300px; overflow-y: auto; min-width: 300px; max-width: 500px; display: none; border-radius: 4px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); font-size: 14px; }
        .suggestion-item { padding: 6px 12px; cursor: pointer; border-bottom: 1px solid #eee; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover, .suggestion-item.selected { background-color: #e9ecef; }
        .suggestion-med-name { font-weight: 500; }
        .suggestion-brands { font-size: 0.9em; color: #555; font-style: italic; }
        .more-brands-link { text-decoration: underline; color: #0056b3; cursor: pointer; margin-left: 5px; }
        .manual-entry { background-color: #f8f9fa; border-top: 1px solid #ddd; padding: 8px 12px; }
        .manual-entry strong { color: #007bff; }

        /* --- Medication List --- */
        #medicationsListContainer { margin-top: 20px; border-top: 2px solid #007bff; padding-top: 15px; }
        .added-medication-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 15px; margin-bottom: 12px; border-radius: 4px;
            font-size: 14px; border: 1px solid; position: relative;
        }
        .added-medication-item.single-med { background-color: #e6f7ff; border-color: #b3e0ff; }
        .added-medication-item.combination-med { background-color: #fff3cd; border-color: #ffeeba; }
        .added-medication-item .med-info { flex-grow: 1; padding-right: 15px; }
        .added-medication-item .med-controls { display: flex; gap: 5px; }
        .added-medication-item .remove-btn {
            padding: 4px 8px; font-size: 12px; background-color: #dc3545; 
            width: auto; margin-top: 0; flex-shrink: 0;
        }
        .added-medication-item .remove-btn:hover { background-color: #c82333; }
        .badge {
            display: inline-block; padding: 3px 7px; font-size: 0.75em; 
            border-radius: 3px; margin-right: 8px; font-weight: bold;
        }
        .badge.combo { background: #ffc107; color: #212529; }
        .badge.dosage { background: #17a2b8; color: #fff; }

        /* --- Messages --- */
        #loadingMessage, #errorMessage, #successMessage { padding: 15px; border-radius: 4px; margin-bottom: 20px; text-align: center; display: none; }
        #loadingMessage { background-color: #ffc107; border: 1px solid #dda700; }
        #errorMessage   { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        #successMessage { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        
        /* --- Validation --- */
        .validation-alert {
            background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404;
            padding: 10px; border-radius: 4px; margin: 10px 0; display: none;
        }
        
        /* --- Search Help --- */
        .search-meds-btn {
            background-color: #28a745; 
            margin-top: 5px;
            padding: 5px 10px;
            font-size: 0.9em;
        }
        .search-meds-btn:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Refill Request</h1>

    <!-- Loading / Error / Success Messages -->
    <div id="loadingMessage">Loading medication data…</div>
    <div id="errorMessage">Error loading data. Please try again later.</div>
    <div id="successMessage">Your refill request has been submitted successfully!</div>

    <!-- Patient Info -->
    <h2>Patient Information</h2>
    <form id="patientForm">
        <div class="form-group">
            <label for="firstName">First Name:</label>
            <input type="text" id="firstName" name="firstName" required>
        </div>
        <div class="form-group">
            <label for="lastName">Last Name:</label>
            <input type="text" id="lastName" name="lastName" required>
        </div>
        <div class="form-group">
            <label for="dob">Date of Birth:</label>
            <input type="date" id="dob" name="dob" required>
        </div>

        <!-- History of last meds -->
        <div id="historyContainer"></div>

        <h2>Medication Entry</h2>
        <div id="medicationEntryArea">
            <div class="medication-entry-row" id="medicationRow_0">
                <div class="medication-fields-grid">
                    <div style="position: relative;">
                        <label for="medicationDrugField_0">Medication:</label>
                        <input type="text" id="medicationDrugField_0" class="medication-drug-input" 
                               placeholder="Click to search medications" autocomplete="off" readonly>
                        <div class="form-hint">Click to search medications</div>
                        <button type="button" class="search-meds-btn" id="searchMedsBtn_0">Search Medications</button>
                        <button type="button" class="search-meds-btn" id="manualEntryBtn_0" style="background-color: #6c757d;">Enter Manually</button>
                    </div>
                    <div>
                        <label for="medicationDosageForm_0">Form:</label>
                        <select id="medicationDosageForm_0" class="medication-dosage-form">
                            <option value="" disabled selected>—</option>
                            <option value="tablet">Tablet</option>
                            <option value="capsule">Capsule</option>
                            <option value="liquid">Liquid/Syrup</option>
                            <option value="suspension">Suspension</option>
                            <option value="injection">Injection</option>
                            <option value="inhaler">Inhaler</option>
                            <option value="topical">Topical</option>
                            <option value="patch">Patch</option>
                            <option value="suppository">Suppository</option>
                            <option value="eye drop">Eye Drop</option>
                            <option value="ear drop">Ear Drop</option>
                            <option value="nasal spray">Nasal Spray</option>
                        </select>
                    </div>
                </div>

                <div class="sig-structured-area">
                    <label>Directions / SIG:</label>
                    <div class="validation-alert" id="validationAlert_0"></div>
                    <div class="sig-structured-grid">
                        <div>
                            <label for="sigQuantity_0">Quantity</label>
                            <input type="number" id="sigQuantity_0" class="sig-quantity" min="0" step="0.1">
                        </div>
                        <div>
                            <label for="sigUnit_0">Unit</label>
                            <select id="sigUnit_0" class="sig-unit" disabled>
                                <option>—</option>
                            </select>
                        </div>
                        <div>
                            <label for="sigFrequency_0">Frequency</label>
                            <select id="sigFrequency_0" class="sig-frequency">
                                <option value="" disabled selected>—</option>
                                <option value="once daily">Once daily (QD)</option>
                                <option value="twice daily">Twice daily (BID)</option>
                                <option value="three times daily">Three times daily (TID)</option>
                                <option value="four times daily">Four times daily (QID)</option>
                                <option value="every morning">Every morning (QAM)</option>
                                <option value="every evening">Every evening (QPM)</option>
                                <option value="at bedtime">At bedtime (QHS)</option>
                                <option value="every 4 hours">Every 4 hours</option>
                                <option value="every 6 hours">Every 6 hours</option>
                                <option value="every 8 hours">Every 8 hours</option>
                                <option value="every 12 hours">Every 12 hours</option>
                                <option value="every other day">Every other day</option>
                                <option value="once weekly">Once weekly</option>
                                <option value="as needed">As needed (PRN)</option>
                                <option value="other">Other…</option>
                            </select>
                        </div>
                    </div>
                    <div class="sig-additional-info">
                        <label for="sigAdditional_0">Additional Info</label>
                        <input type="text" id="sigAdditional_0" class="sig-additional" 
                            placeholder="e.g., for pain, with food, etc.">
                    </div>
                </div>

                <button type="button" class="add-current-med-button">Add Medication</button>
            </div>
        </div>

        <h2>Your Medications</h2>
        <div id="medicationsListContainer">
            <p>No medications added.</p>
        </div>

        <hr>
        <button type="submit">Submit Request</button>
    </form>

    <!-- Medication Search Dialog -->
    <div class="suggestion-box" id="medicationSuggestionBox"></div>
</div>

<script>
    // ---------------------------------------------------------
    // CONFIG — replace with your GitHub Pages JSON URL below
    // ---------------------------------------------------------
    const COMPILED_DATA_URL = 'https://yourname.github.io/yourrepo/compiled_drug_data.json';

    // Globals
    let compiledDrugData = [];
    let currentMedications = [];
    const MAX_SUGGESTIONS = 10;
    const MAX_BRANDS_DISPLAY = 3;
    const MAX_HISTORY_ITEMS = 15;
    const dosageFormUnits = {
        tablet: ['tablet(s)'],
        capsule: ['capsule(s)'],
        liquid: ['mL','tsp (5mL)','tbsp (15mL)'],
        suspension: ['mL','tsp (5mL)','tbsp (15mL)'],
        injection: ['mL','unit(s)'],
        inhaler: ['puff(s)','inhalation(s)'],
        topical: ['application(s)','gram(s)'],
        patch: ['patch(es)'],
        suppository: ['suppository(ies)'],
        'eye drop': ['drop(s) in eye(s)','drop(s) in left eye','drop(s) in right eye'],
        'ear drop': ['drop(s) in ear(s)','drop(s) in left ear','drop(s) in right ear'],
        'nasal spray': ['spray(s) in nostril(s)','spray(s) in left nostril','spray(s) in right nostril']
    };

    // ---------------------------------------------------------
    // Utility: History per patient (based on name+DOB)
    // ---------------------------------------------------------
    function historyKey() {
      const first = $('#firstName').val().trim();
      const last = $('#lastName').val().trim();
      const dob  = $('#dob').val();
      if (!first || !dob) return null;
      return `medHistory:${first}_${last || ''}_${dob}`;
    }

    function historyKeyPrevRequests() {
      const first = $('#firstName').val().trim();
      const last = $('#lastName').val().trim();
      const dob  = $('#dob').val();
      if (!first || !dob) return null;
      return `prevRequests:${first}_${last || ''}_${dob}`;
    }

    function saveToHistory(med) {
      const key = historyKey();
      if (!key) return;
      
      let hist = JSON.parse(localStorage.getItem(key) || '[]');
      // Add to top if not exists, or move to top if exists
      hist = [med, ...hist.filter(m => m.drug !== med.drug)].slice(0, MAX_HISTORY_ITEMS);
      localStorage.setItem(key, JSON.stringify(hist));
    }

    function savePreviousRequest() {
      const key = historyKeyPrevRequests();
      if (!key || !currentMedications.length) return;
      
      // Save current medications as a timestamped request
      const request = {
        timestamp: new Date().toISOString(),
        medications: JSON.parse(JSON.stringify(currentMedications))
      };
      
      let prevRequests = JSON.parse(localStorage.getItem(key) || '[]');
      prevRequests.unshift(request);
      // Keep only last 5 requests
      if (prevRequests.length > 5) prevRequests = prevRequests.slice(0, 5);
      
      localStorage.setItem(key, JSON.stringify(prevRequests));
    }

    function loadHistoryList() {
      // Clear history container
      const $cont = $('#historyContainer').empty();
      
      // If no patient identity yet, exit
      if (!$('#firstName').val() || !$('#dob').val()) return;
      
      // 1. Load previous individual medications
      const key = historyKey();
      if (key) {
        const hist = JSON.parse(localStorage.getItem(key) || '[]');
        if (hist.length) {
          $cont.append('<div class="history-section"><div class="history-title">Your Recent Medications</div><div id="recentMedsHistory"></div></div>');
          const $recentMeds = $('#recentMedsHistory');
          
          hist.forEach(med => {
            const $btn = $('<button type="button" class="history-btn">')
              .text(med.drug)
              .on('click', () => {
                $('#medicationDrugField_0').val(med.drug).trigger('change');
                
                // Try to auto-fill other fields if available
                const $row = $('#medicationRow_0');
                if (med.dosageForm) {
                  const $form = $row.find('.medication-dosage-form');
                  $form.val(med.dosageForm);
                  populateUnitOptions($form);
                  
                  if (med.sig_structured) {
                    if (med.sig_structured.quantity) $row.find('.sig-quantity').val(med.sig_structured.quantity);
                    if (med.sig_structured.unit) $row.find('.sig-unit').val(med.sig_structured.unit);
                    if (med.sig_structured.frequency) $row.find('.sig-frequency').val(med.sig_structured.frequency);
                    if (med.sig_structured.additional) $row.find('.sig-additional').val(med.sig_structured.additional);
                  }
                }
                
                // Focus on first empty required field or add button
                const $emptyField = $row.find('input:visible, select:visible').filter(function() {
                  return !this.value && !$(this).prop('disabled');
                }).first();
                
                if ($emptyField.length) {
                  $emptyField.focus();
                } else {
                  $row.find('.sig-quantity').focus();
                }
              });
            $recentMeds.append($btn);
          });
        }
      }
      
      // 2. Load previous complete requests
      const prevKey = historyKeyPrevRequests();
      if (prevKey) {
        const prevRequests = JSON.parse(localStorage.getItem(prevKey) || '[]');
        if (prevRequests.length) {
          $cont.append('<div class="history-section"><div class="history-title">Your Previous Refill Requests</div><div id="previousRequestsList"></div></div>');
          const $prevList = $('#previousRequestsList');
          
          prevRequests.forEach((req, i) => {
            const date = new Date(req.timestamp);
            const dateStr = date.toLocaleDateString();
            const numMeds = req.medications.length;
            const $btn = $('<button type="button" class="history-btn">')
              .html(`${dateStr} (${numMeds} med${numMeds !== 1 ? 's' : ''})`)
              .on('click', () => {
                if (confirm(`Load all ${numMeds} medications from your ${dateStr} request?`)) {
                  // Replace current medications with this previous request
                  currentMedications = JSON.parse(JSON.stringify(req.medications));
                  renderMedicationList();
                }
              });
            $prevList.append($btn);
          });
        }
      }
    }

    // ---------------------------------------------------------
    // Populate units based on form
    // ---------------------------------------------------------
    function populateUnitOptions($sel) {
      const form = $sel.val();
      const $unit = $sel.closest('.medication-entry-row').find('.sig-unit')
                       .empty().prop('disabled', true);
      if (dosageFormUnits[form]) {
        $unit.append('<option disabled selected>—</option>');
        dosageFormUnits[form].forEach(u=> $unit.append($('<option>').val(u).text(u)));
        $unit.prop('disabled',false);
        // AUTO‑SELECT first unit
        $unit.val($unit.find('option:not([disabled])').first().val());
      } else {
        $unit.append('<option>—</option>');
      }
    }

    // ---------------------------------------------------------
    // Validate medication entry
    // ---------------------------------------------------------
    function validateMedicationEntry(medData, $alert) {
      $alert.hide();
      
      // Check required fields
      const { quantity, unit, frequency } = medData.sig_structured;
      if (!medData.drug.trim()) {
        $alert.text("Please select a medication").show();
        return false;
      }
      
      if (!quantity || !unit || !frequency) {
        $alert.text("Please fill in Quantity, Unit, and Frequency").show();
        return false;
      }
      
      // Check reasonable amounts for tablets
      if (unit.includes('tablet') && quantity > 4) {
        $alert.html("⚠️ High dose alert: Taking more than 4 tablets at once may be unsafe.<br>Please confirm this is your prescribed dose.").show();
        return true; // Still allow, but warn
      }
      
      // Warning for high frequency
      if ((frequency.includes('four times') || frequency.includes('every 4 hours')) && 
          (unit.includes('tablet') || unit.includes('capsule'))) {
        $alert.html("⚠️ Frequent dosing: Taking this medication 4+ times per day.<br>Please confirm this is your prescribed frequency.").show();
        return true; // Still allow, but warn
      }
      
      return true;
    }

    // ---------------------------------------------------------
    // Render Med List with badges
    // ---------------------------------------------------------
    function renderMedicationList() {
      const $c = $('#medicationsListContainer').empty();
      if (!currentMedications.length) {
        return $c.html('<p>No medications added.</p>');
      }
      
      currentMedications.forEach((m, i) => {
        const isCombo = m.drug.includes('/');
        const cls = isCombo ? 'combination-med' : 'single-med';
        const $item = $('<div>').addClass('added-medication-item').addClass(cls)
                                .attr('data-index', i);
        
        // Info section
        const $info = $('<div class="med-info">');
        
        // Add badges
        if (isCombo) {
          $info.append('<span class="badge combo">Combo</span>');
        }
        
        // Extract strength if present in the drug name (e.g., "acetaminophen 500mg")
        const strengthMatch = m.drug.match(/\d+\s*(?:mg|mcg|g|ml|%)/i);
        if (strengthMatch) {
          $info.append(`<span class="badge dosage">${strengthMatch[0]}</span>`);
        }
        
        // Main medication text
        $info.append($('<span>').text(`${m.drug} – SIG: ${m.sig_string}`));
        
        // Control buttons
        const $controls = $('<div class="med-controls">');
        const $removeBtn = $('<button type="button" class="remove-btn">Remove</button>').on('click', () => {
          if (confirm("Remove this medication from your list?")) {
            currentMedications.splice(i, 1);
            renderMedicationList();
          }
        });
        
        $controls.append($removeBtn);
        $item.append($info, $controls);
        $c.append($item);
      });
    }

    // ---------------------------------------------------------
    // Add med, with validation hint
    // ---------------------------------------------------------
    function addMedicationToList(medData, $row) {
      const $alert = $row.find('.validation-alert');
      
      // Validate the entry
      if (!validateMedicationEntry(medData, $alert)) {
        return false;
      }
      
      // Build SIG string
      const { quantity, unit, frequency, additional } = medData.sig_structured;
      let action = "Take";
      const f = medData.dosageForm.toLowerCase();
      if (f.includes('topical')) action = "Apply";
      else if (f.includes('drop')) action = "Instill";
      else if (f.includes('inhaler')) action = "Use";
      else if (f.includes('injection')) action = "Inject";
      else if (f.includes('suppository')) action = "Insert";
      
      let sig = `${action} ${quantity} ${unit}`;
      if (frequency === 'other') {
        sig += ` ${additional || 'as directed'}`;
      } else { 
        sig += ` ${frequency}`; 
        if (additional) sig += ` ${additional}`; 
      }
      
      medData.sig_string = sig.trim().replace(/\s+/g, ' ');
      medData.drug = medData.drug.trim();
      
      // Add to medications list
      currentMedications.push(medData);
      saveToHistory(medData);
      renderMedicationList();
      loadHistoryList();
      
      // Reset the form
      $row.find('.medication-drug-input').val('');
      $row.find('.medication-dosage-form').prop('selectedIndex', 0);
      $row.find('.sig-quantity').val('');
      $row.find('.sig-unit').empty().prop('disabled', true).append('<option>—</option>');
      $row.find('.sig-frequency').prop('selectedIndex', 0);
      $row.find('.sig-additional').val('');
      $alert.hide();
      
      return true;
    }

    // ---------------------------------------------------------
    // Medication Search
    // ---------------------------------------------------------
    function setupMedicationSearch() {
      const $searchBox = $('#medicationSuggestionBox');
      let searchResults = [];
      let selectedIndex = -1;
      
      function positionSearchBox($button) {
        const rect = $button[0].getBoundingClientRect();
        const scrollTop = $(window).scrollTop();
        const scrollLeft = $(window).scrollLeft();
        
        $searchBox.css({
          top: (rect.bottom + scrollTop) + "px",
          left: (rect.left + scrollLeft) + "px",
          minWidth: $button.closest('.medication-fields-grid').find('.medication-drug-input').outerWidth() + "px"
        }).show();
      }
      
      function displaySearchResults(query, medications) {
        $searchBox.empty();
        searchResults = [];
        selectedIndex = -1;
        
        // Filter out restricted medications
        const filtered = medications.filter(med => !med.is_restricted);
        
        if (!filtered.length) {
          $searchBox.append('<div class="suggestion-item">No eligible medications found</div>');
          $searchBox.append('<div class="suggestion-item manual-entry">Enter medication manually</div>');
          return;
        }
        
        // Group medications by active ingredient and dosage form
        const groups = new Map();
        
        filtered.forEach(med => {
          const key = (med.ingredients || []).join('|') + "|" + (med.normalized_dosage_form || '');
          if (!groups.has(key)) {
            groups.set(key, { med: med, brands: [] });
          }
          
          // Add brands
          const entry = groups.get(key);
          if (med.brand_name) {
            med.brand_name.split('/').forEach(brand => {
              if (brand && !entry.brands.includes(brand)) {
                entry.brands.push(brand);
              }
            });
          }
        });
        
        // Create a list of unique medications
        const uniqueMeds = Array.from(groups.values());
        
        // Filter by search query if provided
        let results = uniqueMeds;
        if (query && query.trim()) {
          const terms = query.toLowerCase().trim().split(/\s+/);
          results = uniqueMeds.filter(item => {
            const medText = `${item.med.ingredients.join(' ')} ${item.med.dosage_form || ''} ${item.brands.join(' ')}`.toLowerCase();
            return terms.every(term => medText.includes(term));
          });
        }
        
        // Display results
        if (!results.length) {
          $searchBox.append('<div class="suggestion-item">No matching medications found</div>');
        } else {
          // Sort by medication name
          results.sort((a, b) => {
            const nameA = a.med.ingredients.join(' ');
            const nameB = b.med.ingredients.join(' ');
            return nameA.localeCompare(nameB);
          });
          
          // Take top results
          results.slice(0, MAX_SUGGESTIONS).forEach(result => {
            const med = result.med;
            const medName = med.ingredients.join(' / ') + (med.dosage_form ? ` (${med.dosage_form})` : '');
            
            const $item = $('<div class="suggestion-item">')
              .data('medData', med)
              .append($('<span class="suggestion-med-name">').text(medName));
            
            // Add brands if available
            if (result.brands.length) {
              const displayBrands = result.brands.slice(0, MAX_BRANDS_DISPLAY);
              let brandText = 'Brand(s): ' + displayBrands.join(', ');
              if (result.brands.length > MAX_BRANDS_DISPLAY) {
                brandText += ` <span class="more-brands-link">+${result.brands.length - MAX_BRANDS_DISPLAY} more</span>`;
              }
              $item.append($('<span class="suggestion-brands">').html(brandText));
            }
            
            // Add click handler
            $item.on('click', function(e) {
              if ($(e.target).hasClass('more-brands-link')) {
                alert('All brands: ' + result.brands.join(', '));
                return;
              }
              
              const rowId = $searchBox.data('rowId');
              const $row = $(`#medicationRow_${rowId}`);
              const $medInput = $row.find('.medication-drug-input');
              
              $medInput.val(medName).data('medData', med);
              
              // Auto-select form
              const $form = $row.find('.medication-dosage-form');
              const normalized = (med.normalized_dosage_form || '').toLowerCase();
              
              if (normalized) {
                const $match = $form.find('option').filter(function() {
                  return this.value.toLowerCase().includes(normalized);
                }).first();
                
                if ($match.length) {
                  $form.val($match.val());
                }
              }
              
              populateUnitOptions($form);
              $row.find('.sig-quantity').focus();
              $searchBox.hide();
            });
            
            // Add hover handler
            $item.on('mouseenter', function() {
              $searchBox.find('.suggestion-item').removeClass('selected');
              $(this).addClass('selected');
              selectedIndex = $(this).index();
            });
            
            searchResults.push($item);
            $searchBox.append($item);
          });
        }
        
        // Add manual entry option
        $searchBox.append('<div class="suggestion-item manual-entry">Enter medication manually</div>');
      }
      
      // Handle search button click
      $('.search-meds-btn').on('click', function() {
        const rowId = $(this).attr('id').split('_')[1];
        const $row = $(`#medicationRow_${rowId}`);
        const $searchInput = $('<input type="text" placeholder="Search medications..." class="search-medications-input" style="margin-bottom:10px;">');
        
        $searchBox.data('rowId', rowId).empty().append($searchInput);
        
        // Show all medications initially (limited to MAX_SUGGESTIONS)
        displaySearchResults('', compiledDrugData);
        
        // Position the search box below the button
        positionSearchBox($(this));
        
        // Focus on the search input
        $searchInput.focus();
        
        // Handle search input changes
        $searchInput.on('input', function() {
          const query = $(this).val().trim();
          displaySearchResults(query, compiledDrugData);
        });
        
        // Handle keyboard navigation
        $searchInput.on('keydown', function(e) {
          if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
            e.preventDefault();
            
            if (e.key === 'ArrowDown') {
              selectedIndex = Math.min(selectedIndex + 1, searchResults.length - 1);
            } else {
              selectedIndex = Math.max(selectedIndex - 1, 0);
            }
            
            if (selectedIndex >= 0 && selectedIndex < searchResults.length) {
              $searchBox.find('.suggestion-item').removeClass('selected');
              searchResults[selectedIndex].addClass('selected')[0].scrollIntoView({ block: 'nearest' });
            }
          } else if (e.key === 'Enter' && selectedIndex >= 0) {
            e.preventDefault();
            searchResults[selectedIndex].trigger('click');
          } else if (e.key === 'Escape') {
            $searchBox.hide();
          }
        });
      });
      
      // Handle manual entry button
      $('#manualEntryBtn_0').on('click', function() {
        const medName = prompt("Enter medication name:");
        if (medName && medName.trim()) {
          const rowId = $(this).attr('id').split('_')[1];
          const $row = $(`#medicationRow_${rowId}`);
          $row.find('.medication-drug-input').val(medName.trim());
        }
      });
      
      // Handle click on manual entry option in search results
      $searchBox.on('click', '.manual-entry', function() {
        const rowId = $searchBox.data('rowId');
        const medName = prompt("Enter medication name:");
        if (medName && medName.trim()) {
          $(`#medicationRow_${rowId}`).find('.medication-drug-input').val(medName.trim());
        }
        $searchBox.hide();
      });
      
      // Hide search box when clicking outside
      $(document).on('click', function(e) {
        if (!$(e.target).closest('.search-meds-btn, #medicationSuggestionBox').length) {
          $searchBox.hide();
        }
      });
    }

    // ---------------------------------------------------------
    // Setup keyboard navigation within the form
    // ---------------------------------------------------------
    function setupKeyboardNavigation() {
      $('#medicationEntryArea').on('keydown', '.medication-dosage-form', function(e) {
        if (e.key === 'ArrowRight') {
          e.preventDefault();
          $(this).closest('.medication-entry-row').find('.sig-quantity').focus();
        } else if (e.key === 'ArrowLeft') {
          e.preventDefault();
          $(this).closest('.medication-entry-row').find('.medication-drug-input').focus();
        }
      });
      
      $('#medicationEntryArea').on('keydown', '.sig-quantity', function(e) {
        if (e.key === 'ArrowRight') {
          e.preventDefault();
          $(this).closest('.medication-entry-row').find('.sig-unit').focus();
        } else if (e.key === 'ArrowLeft') {
          e.preventDefault();
          $(this).closest('.medication-entry-row').find('.medication-dosage-form').focus();
        }
      });
      
      $('#medicationEntryArea').on('keydown', '.sig-unit', function(e) {
        if (e.key === 'ArrowRight') {
          e.preventDefault();
          $(this).closest('.medication-entry-row').find('.sig-frequency').focus();
        } else if (e.key === 'ArrowLeft') {
          e.preventDefault();
          $(this).closest('.medication-entry-row').find('.sig-quantity').focus();
        }
      });
      
      $('#medicationEntryArea').on('keydown', '.sig-frequency', function(e) {
        if (e.key === 'ArrowRight') {
          e.preventDefault();
          $(this).closest('.medication-entry-row').find('.sig-additional').focus();
        } else if (e.key === 'ArrowLeft') {
          e.preventDefault();
          $(this).closest('.medication-entry-row').find('.sig-unit').focus();
        } else if (e.key === 'Enter') {
          e.preventDefault();
          $(this).closest('.medication-entry-row').find('.add-current-med-button').click();
        }
      });
      
      $('#medicationEntryArea').on('keydown', '.sig-additional', function(e) {
        if (e.key === 'ArrowLeft') {
          e.preventDefault();
          $(this).closest('.medication-entry-row').find('.sig-frequency').focus();
        } else if (e.key === 'Enter') {
          e.preventDefault();
          $(this).closest('.medication-entry-row').find('.add-current-med-button').click();
        }
      });
    }

    // ---------------------------------------------------------
    // Document Ready
    // ---------------------------------------------------------
    $(document).ready(() => {
      $('#loadingMessage').show();
      setupKeyboardNavigation();

      // fetch JSON
      $.getJSON(COMPILED_DATA_URL)
        .done(data => {
          compiledDrugData = Array.isArray(data) ? data : [];
          $('#loadingMessage').hide();
          
          if (!compiledDrugData.length) {
            $('#errorMessage').text("No medication data available.").show();
            return;
          }
          
          // Setup medication search after data is loaded
          setupMedicationSearch();
        })
        .fail(() => {
          $('#loadingMessage').hide();
          $('#errorMessage').show();
        });

      // populate units on form change
      $('#medicationEntryArea').on('change', '.medication-dosage-form', function() {
        populateUnitOptions($(this));
      });

      // add med button
      $('#medicationEntryArea').on('click', '.add-current-med-button', function() {
        const $row = $(this).closest('.medication-entry-row');
        const medData = {
          drug: $row.find('.medication-drug-input').val(),
          dosageForm: $row.find('.medication-dosage-form').val(),
          sig_structured: {
            quantity: $row.find('.sig-quantity').val(),
            unit:     $row.find('.sig-unit').val(),
            frequency: $row.find('.sig-frequency').val(),
            additional: $row.find('.sig-additional').val()
          }
        };
        addMedicationToList(medData, $row);
      });

      // form submit
      $('#patientForm').on('submit', e => {
        e.preventDefault();
        
        // Validation
        if (!$('#firstName').val().trim() || !$('#lastName').val().trim() || !$('#dob').val()) {
          return alert("Please fill in all patient information fields.");
        }
        
        if (!currentMedications.length) {
          return alert("Please add at least one medication to your request.");
        }
        
        // Build payload
        const payload = {
          firstName: $('#firstName').val().trim(),
          lastName: $('#lastName').val().trim(),
          dob: $('#dob').val(),
          medications: currentMedications,
          timestamp: new Date().toISOString()
        };
        
        console.log("Submitting:", payload);
        
        // Save request to history
        savePreviousRequest();
        
        // Show success message (in a real app, you'd send to server here)
        $('#successMessage').fadeIn().delay(3000).fadeOut();
        
        // Clear medications but keep patient info
        currentMedications = [];
        renderMedicationList();
      });

      // reload history when patient info changes
      $('#firstName, #lastName, #dob').on('change', loadHistoryList);
      renderMedicationList();
      loadHistoryList();
    });
</script>
</body>
</html>
