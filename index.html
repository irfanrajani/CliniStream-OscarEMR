<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Patient & Medication Entry (Local JSON - v3 Debug)</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        /* --- Styles --- */
        body { font-family: Arial, sansâ€‘serif; margin: 20px; background-color: #f4f4f4; }
        h1, h2 { color: #333; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 800px; margin: auto; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input[type="text"], input[type="date"], input[type="number"], select, button { padding: 10px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; width: 100%; }
        button { cursor: pointer; background-color: #007bff; color: white; border: none; margin-top: 10px; }
        button:hover { background-color: #0056b3; }
        input[readonly] { background-color: #e9ecef; cursor: not-allowed; }
        hr { border: 0; height: 1px; background-color: #ddd; margin: 25px 0; }
        .medication-entry-row { border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; background-color: #f9f9f9; border-radius: 5px; }
        .medication-fields-grid { display: grid; grid-template-columns: 3fr 2fr; gap: 20px; margin-bottom: 15px; }
        .sig-structured-area { border-top: 1px dashed #ccc; margin-top: 15px; padding-top: 15px; }
        .sig-structured-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; align-items: end; margin-bottom: 10px; }
        .sig-structured-grid label { margin-bottom: 3px; font-size: 0.9em; }
        .sig-structured-grid input[type="number"] { max-width: 100px; }
        .sig-additional-info { margin-top: 10px; }

        /* --- Suggestion Box --- */
        .suggestion-box { position: absolute; background: #fff; border: 1px solid #aaa; z-index: 9999; max-height: 300px; overflow-y: auto; min-width: 300px; max-width: 500px; display: none; border-radius: 4px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); font-family: sans-serif; font-size: 14px; }
        .suggestion-item { padding: 6px 12px; cursor: pointer; border-bottom: 1px solid #eee; line-height: 1.4; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover, .suggestion-item.selected { background-color: #e9ecef; }
        .suggestion-item.selected { background-color: #007bff; color: white; }
        .suggestion-item.selected .suggestion-brands { color: #eee; }
        .suggestion-med-name { display: block; font-weight: 500; white-space: normal; word-wrap: break-word; }
        .suggestion-brands { display: block; font-size: 0.9em; color: #555; font-style: italic; padding-left: 5px; margin-top: 2px; white-space: normal; word-wrap: break-word; }
        .suggestion-brands .more-brands-link { cursor: pointer; text-decoration: underline; color: #0056b3; margin-left: 5px; font-weight: normal; font-style: normal; }
        .suggestion-box .no-results { padding: 8px 12px; color:#666; font-style: italic; cursor: default; }

        /* --- Other styles --- */
        #medicationsListContainer { margin-top: 20px; border-top: 2px solid #007bff; padding-top: 15px; }
        .added-medication-item { background-color: #e6f7ff; border: 1px solid #b3e0ff; padding: 10px 15px; margin-bottom: 8px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
        .added-medication-item span { flex-grow: 1; margin-right: 10px; word-break: break-word; }
        .added-medication-item button { padding: 4px 8px; font-size: 12px; background-color: #dc3545; width: auto; margin-top: 0; flex-shrink: 0; }
        .added-medication-item button:hover { background-color: #c82333; }
        #loadingMessage, #errorMessage { padding: 15px; border-radius: 4px; margin-bottom: 20px; text-align: center; display: none; }
        #loadingMessage { background-color: #ffc107; border: 1px solid #dda700; }
        #errorMessage { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
    </style>
</head>
<body>

<div class="container">
    <!-- Loading/Error Message Area -->
    <div id="loadingMessage">Loading drug data... Please wait.</div>
    <div id="errorMessage">Error loading drug data. Autocomplete disabled. See console.</div>

    <h1>Patient Demographics</h1>
    <form id="patientForm">
         <div class="form-group">
             <label for="firstName">First Name:</label>
             <input type="text" id="firstName" name="firstName">
         </div>
         <div class="form-group">
             <label for="lastName">Last Name:</label>
             <input type="text" id="lastName" name="lastName">
         </div>
         <div class="form-group">
             <label for="dob">Date of Birth:</label>
             <input type="date" id="dob" name="dob">
         </div>
         <div class="form-group">
             <label for="age">Age:</label>
             <input type="number" id="age" name="age" readonly>
         </div>

         <h2>Medication Entry</h2>
         <div id="medicationEntryArea">
             <div class="medication-entry-row" id="medicationRow_0">
                 <div class="medication-fields-grid">
                     <div style="position: relative;">
                         <label for="medicationDrugField_0">Medication:</label>
                         <input type="text" id="medicationDrugField_0" name="medicationDrugField"
                                class="medication-drug-input" autocomplete="off"
                                placeholder="Loading drug data..." disabled>
                         <div class="suggestion-anchor" style="position: relative; height: 0;"></div>
                     </div>
                     <div style="position: relative;">
                         <label for="medicationDosageForm_0">Dosage Form:</label>
                         <select id="medicationDosageForm_0" name="medicationDosageForm"
                                 class="medication-dosage-form">
                             <option value="" disabled selected>-- Select Form --</option>
                             <option value="tablet">Tablet</option>
                             <option value="capsule">Capsule</option>
                             <option value="liquid">Liquid/Syrup</option>
                             <option value="suspension">Suspension</option>
                             <option value="injection">Injection (SC/IM/IV)</option>
                             <option value="inhaler">Inhaler</option>
                             <option value="topical">Topical Cream/Ointment/Gel</option>
                             <option value="patch">Patch</option>
                             <option value="suppository">Suppository</option>
                             <option value="eye drop">Eye Drop</option>
                             <option value="ear drop">Ear Drop</option>
                             <option value="nasal spray">Nasal Spray</option>
                         </select>
                     </div>
                 </div>

                 <div class="sig-structured-area">
                    <label style="font-weight: normal; margin-bottom: 10px; display: block;">
                        Directions / SIG:
                    </label>
                    <div class="sig-structured-grid">
                       <div>
                           <label for="sigQuantity_0">Quantity</label>
                           <input type="number" id="sigQuantity_0" class="sig-quantity"
                                  min="0" step="0.1" placeholder="e.g., 1">
                       </div>
                       <div>
                           <label for="sigUnit_0">Unit</label>
                           <select id="sigUnit_0" class="sig-unit" disabled>
                               <option value="">-- Select Form First --</option>
                           </select>
                       </div>
                       <div>
                           <label for="sigFrequency_0">Frequency</label>
                           <select id="sigFrequency_0" class="sig-frequency">
                               <option value="" disabled selected>-- Select --</option>
                               <option value="once daily">Once daily (QD)</option>
                               <option value="twice daily">Twice daily (BID)</option>
                               <option value="three times daily">Three times daily (TID)</option>
                               <option value="four times daily">Four times daily (QID)</option>
                               <option value="every morning">Every morning (QAM)</option>
                               <option value="every evening">Every evening (QPM)</option>
                               <option value="at bedtime">At bedtime (QHS)</option>
                               <option value="every 4 hours">Every 4 hours</option>
                               <option value="every 6 hours">Every 6 hours</option>
                               <option value="every 8 hours">Every 8 hours</option>
                               <option value="every 12 hours">Every 12 hours</option>
                               <option value="every other day">Every other day</option>
                               <option value="once weekly">Once weekly</option>
                               <option value="as needed">As needed (PRN)</option>
                               <option value="other">Other (Specify Below)</option>
                           </select>
                       </div>
                    </div>
                    <div class="sig-additional-info">
                        <label for="sigAdditional_0">Additional Info / Frequency Detail</label>
                        <input type="text" id="sigAdditional_0" class="sig-additional"
                               placeholder="e.g., for pain, with food, for 7 days, or specify 'Other'">
                    </div>
                 </div>

                 <button type="button" class="add-current-med-button">
                     Add This Medication to List
                 </button>
             </div>
         </div>

         <h2>Current Medication List</h2>
         <div id="medicationsListContainer">
             <p>No medications added yet.</p>
         </div>
         <hr>

         <button type="submit">Submit Patient Data & Medications</button>
    </form>
    <div class="suggestion-box" id="medicationSuggestionBox"></div>
</div>

<script>
    // ======================================================================
    //                    Configuration & Globals
    // ======================================================================
    const COMPILED_DATA_URL = 'compiled_drug_data.json';
    const MAX_SUGGESTIONS = 10;
    const MAX_BRANDS_DISPLAY = 3;
    let compiledDrugData = [];
    let currentMedications = [];
    const dosageFormUnits = {
        tablet: ['tablet(s)'],
        capsule: ['capsule(s)'],
        liquid: ['mL','tsp (5mL)','tbsp (15mL)'],
        suspension: ['mL','tsp (5mL)','tbsp (15mL)'],
        injection: ['mL','unit(s)'],
        inhaler: ['puff(s)','inhalation(s)'],
        topical: ['application(s)','gram(s)'],
        patch: ['patch(es)'],
        suppository: ['suppository(ies)'],
        'eye drop': ['drop(s) in eye(s)','drop(s) in left eye','drop(s) in right eye'],
        'ear drop': ['drop(s) in ear(s)','drop(s) in left ear','drop(s) in right ear'],
        'nasal spray': ['spray(s) in nostril(s)','spray(s) in left nostril','spray(s) in right nostril']
    };

    // ======================================================================
    //                    UI Interaction Functions
    // ======================================================================
    function populateUnitOptions($dosageSelect) {
         const selectedForm = $dosageSelect.val();
         const $unitSelect = $dosageSelect.closest('.medication-entry-row').find('.sig-unit');
         $unitSelect.empty().prop('disabled', true);
         if (selectedForm && dosageFormUnits[selectedForm]) {
             $unitSelect.append('<option value="" disabled selected>-- Select Unit --</option>');
             dosageFormUnits[selectedForm].forEach(u => {
                 $unitSelect.append($('<option>').val(u).text(u));
             });
             $unitSelect.prop('disabled', false);
         } else {
             $unitSelect.append('<option value="">-- Select Form First --</option>');
         }
    }

    function attachMedAutocomplete($input) {
        if (!$input.length || compiledDrugData.length === 0) {
             console.error("Cannot attach autocomplete: no input or no data.");
             return;
        }
        console.log("Attaching autocompleteâ€¦");
        const $box = $('#medicationSuggestionBox');
        let debounceTimer, suggestions = [], suggestionData = [], currentIndex = -1;
        const selectedClass = 'selected';

        function positionBox() {
             if (!$input.is(':visible')) { $box.hide(); return; }
             const r = $input[0].getBoundingClientRect(),
                   st = $(window).scrollTop(),
                   sl = $(window).scrollLeft();
             $box.css({
                 top: (r.bottom + st) + "px",
                 left: (r.left + sl) + "px",
                 minWidth: $input.outerWidth() + "px"
             }).show();
        }

        function displaySuggestions(results) {
             $box.hide().empty();
             suggestions = []; suggestionData = []; currentIndex = -1;
             if (!results.length) {
                 $box.html('<div class="no-results">No matching medications found.</div>');
                 positionBox(); return;
             }

             const nonRestricted = results.filter(i => !i.is_restricted);
             if (!nonRestricted.length) {
                 $box.html('<div class="no-results">No eligible medications (all restricted).</div>');
                 positionBox(); return;
             }

             // group by key
             const group = new Map();
             nonRestricted.forEach(item => {
                 const ingKey = (item.ingredients||[]).map(s=>s.toLowerCase()).sort().join('|'),
                       strKey = item.first_strength?.toLowerCase()||'',
                       formKey = item.normalized_dosage_form?.toLowerCase()||'',
                       key = ingKey+'|'+strKey+'|'+formKey,
                       brand = (item.brand_name||'').trim();
                 if (!ingKey||!formKey) return;
                 if (!group.has(key)) group.set(key,{ primary:item, brands: brand?[brand]:[] });
                 else {
                     const e = group.get(key);
                     if (brand && !e.brands.some(b=>b.toLowerCase()===brand.toLowerCase())) {
                         e.brands.push(brand); e.brands.sort();
                     }
                 }
             });

             let final = Array.from(group.values());
             final.sort((a,b)=>(a.primary.first_ingredient_name||'').localeCompare(b.primary.first_ingredient_name||''));
             final = final.slice(0, MAX_SUGGESTIONS);

             final.forEach((entry,idx) => {
                 const item = entry.primary,
                       ingDisplay = item.ingredients.join(' / '),
                       formDisplay = item.dosage_form,
                       mainText = ingDisplay + (formDisplay?` (${formDisplay})`:'');

                 let brandsText = '';
                 if (entry.brands.length) {
                     const show = entry.brands.slice(0, MAX_BRANDS_DISPLAY);
                     brandsText = 'Brands: '+ show.join(' / ');
                     if (entry.brands.length>MAX_BRANDS_DISPLAY) {
                         brandsText += ` <span class="more-brands-link" data-idx="${idx}">(+
                           ${entry.brands.length-MAX_BRANDS_DISPLAY} more)</span>`;
                     }
                 }

                 const $opt = $('<div class="suggestion-item">')
                     .data('medData', item)
                     .data('allBrands', entry.brands)
                     .append($('<span class="suggestion-med-name">').text(mainText));

                 if (brandsText) {
                     $opt.append($('<span class="suggestion-brands">').html(brandsText));
                 }

                 $opt.on('mousedown', e=>{
                     if ($(e.target).hasClass('more-brands-link')) {
                         e.preventDefault(); e.stopPropagation(); return;
                     }
                     e.preventDefault();
                     const d = $opt.data('medData'),
                           txt = d.ingredients.join(' / ') + (d.dosage_form?` (${d.dosage_form})`: '');
                     $input.val(txt).trigger('change');
                     const $form = $input.closest('.medication-entry-row')
                                         .find('.medication-dosage-form');
                     const match = $form.find('option').filter(o=>
                         o.value?.toLowerCase().includes(d.normalized_dosage_form?.toLowerCase()||'')
                     ).first();
                     if (match.length) {
                         $form.val(match.val());
                         populateUnitOptions($form);
                         $input.closest('.medication-entry-row').find('.sig-quantity').focus();
                     } else {
                         populateUnitOptions($form);
                         $form.focus();
                     }
                     $box.hide().empty();
                 })
                 .on('mouseenter', ()=>{
                     $box.find('.suggestion-item').removeClass(selectedClass);
                     $opt.addClass(selectedClass);
                     currentIndex = $opt.index();
                 });

                 $box.append($opt);
                 suggestions.push($opt);
                 suggestionData.push(item);
             });

             positionBox();
        }

        function findMatchingDrugs(q) {
            const terms = q.toLowerCase().split(/\s+/).filter(Boolean);
            if (!terms.length) { displaySuggestions([]); return; }
            const matches = compiledDrugData.filter(item=>{
                const text = `${item._search_brand} ${item._search_ingredients} ${item.first_strength}`.toLowerCase();
                return terms.every(t=>text.includes(t));
            });
            displaySuggestions(matches);
        }

        $input.on('input',()=>{
            clearTimeout(debounceTimer);
            const q = $input.val().trim();
            if (q.length<2) { $box.hide().empty(); return; }
            debounceTimer = setTimeout(()=> findMatchingDrugs(q),150);
        });

        $input.on('keydown', e=>{
            if ($box.is(':visible') && suggestions.length) {
                let prevent=true, scrollNeeded=false;
                if (e.key==='ArrowDown') { currentIndex=(currentIndex+1)%suggestions.length; scrollNeeded=true; }
                else if (e.key==='ArrowUp') { currentIndex=(currentIndex-1+suggestions.length)%suggestions.length; scrollNeeded=true; }
                else if (e.key==='Enter' || e.key==='Tab') {
                    if (currentIndex>=0 && suggestions[currentIndex]) {
                        suggestions[currentIndex].trigger('mousedown');
                    } else {
                        $box.hide().empty();
                        prevent = (e.key==='Enter');
                    }
                }
                else if (e.key==='Escape') { $box.hide().empty(); }
                else prevent=false;

                if (prevent) e.preventDefault();
                $box.find('.suggestion-item').removeClass(selectedClass);
                if (currentIndex>=0 && suggestions[currentIndex]) {
                    suggestions[currentIndex].addClass(selectedClass);
                    if (scrollNeeded) suggestions[currentIndex][0]
                        .scrollIntoView({block:'nearest'});
                }
            }
        });

        $input.on('focus',()=> {
            const v=$input.val().trim();
            if (v.length>=2) findMatchingDrugs(v);
        });

        $input.on('blur',()=> {
            setTimeout(()=>{
                if (!$box.is(':hover')) $box.hide().empty();
            },200);
        });

        $(document).on('click', e=>{
            if (!$input.is(e.target) && !$box.is(e.target)
                && !$box.has(e.target).length && !$input.has(e.target).length)
            {
                $box.hide().empty();
            }
        });

        $box.on('click','.more-brands-link', e=>{
            e.preventDefault(); e.stopPropagation();
            const $item=$(e.currentTarget).closest('.suggestion-item'),
                  all = $item.data('allBrands'),
                  $span = $item.find('.suggestion-brands');
            if (all?.length) $span.html('Brands: '+ all.join(' / '));
        });
    }

    // ======================================================================
    //             Medication List & SIG Management
    // ======================================================================
    function renderMedicationList() {
        const $c = $('#medicationsListContainer').empty();
        if (!currentMedications.length) {
            $c.html('<p>No medications added yet.</p>');
        } else {
            currentMedications.forEach((m,i)=>{
                const txt=`${m.drug}Â â€“Â SIG:Â ${m.sig_string}`,
                      $item=$('<div class="added-medication-item">')
                        .attr('data-index',i),
                      $span=$('<span>').text(txt),
                      $btn=$('<button type="button">Remove</button>')
                        .on('click',()=> removeMedication(i));
                $item.append($span,$btn);
                $c.append($item);
            });
        }
    }

    function addMedicationToList(m) {
        const {quantity,unit,frequency,additional} = m.sig_structured;
        if (!quantity||!unit||!frequency) {
            alert("Please fill in Quantity, Unit, and Frequency."); return false;
        }
        const f = (m.dosageForm||'').toLowerCase();
        let action="Take";
        if (f.includes('topical')||f.includes('patch')) action="Apply";
        else if (f.includes('drop')) action="Instill";
        else if (f.includes('inhaler')||f.includes('spray')) action="Use";
        else if (f.includes('injection')) action="Inject";
        else if (f.includes('suppository')) action="Insert";

        let sig=`${action} ${quantity} ${unit}`;
        if (frequency==='other') sig+=` ${additional||'as directed'}`;
        else { sig+=` ${frequency}`; if (additional) sig+=` ${additional}`; }
        m.sig_string=sig.trim().replace(/\s+/g,' ');
        if (!m.drug?.trim()) { alert("Please select a medication."); return false; }

        currentMedications.push(m);
        renderMedicationList();
        return true;
    }

    function removeMedication(i) {
        currentMedications.splice(i,1);
        renderMedicationList();
    }

    // ======================================================================
    //                       Document Ready
    // ======================================================================
    $(document).ready(function(){
        console.log("ðŸ“¥ Document ready. Loading compiled drug data from", COMPILED_DATA_URL);
        $('#loadingMessage').show();

        $.getJSON(COMPILED_DATA_URL)
         .done(function(data){
            console.log("ðŸ“Š Raw data loaded:", data);
            if (!Array.isArray(data)) {
                console.error("âŒ JSON format invalidâ€”expected array.");
                $('#loadingMessage').hide();
                $('#errorMessage').show();
                return;
            }
            compiledDrugData = data;
            console.log(`âœ”ï¸ Successfully loaded ${data.length} entries.`);
            if (!data.length) {
                console.warn("âš ï¸ compiled_drug_data.json is empty!");
                $('#errorMessage')
                  .text("Drug data loaded but contains 0 entries. See console.")
                  .show();
                $('#loadingMessage').hide();
                return;
            }
            $('#loadingMessage').hide();
            $('#medicationDrugField_0')
                .prop('disabled', false)
                .attr('placeholder','Start typing medicationâ€¦');
            attachMedAutocomplete($('#medicationDrugField_0'));
         })
         .fail(function(jq,ts,err){
            console.error("âŒ Failed to load JSON:", ts, err);
            $('#loadingMessage').hide();
            $('#errorMessage').show();
         });

        // Age calc
        $('#dob').on('change',function(){
            const dob=$(this).val();
            if (!dob) return $('#age').val('');
            const bd=new Date(dob), today=new Date();
            if (isNaN(bd) || bd>today) return $('#age').val('');
            let age=today.getFullYear()-bd.getFullYear();
            const m=today.getMonth()-bd.getMonth();
            if (m<0|| (m===0 && today.getDate()<bd.getDate())) age--;
            $('#age').val(age>=0?age:'');
        });

        // Unit options on form change
        $('#medicationEntryArea').on('change','.medication-dosage-form',function(){
            populateUnitOptions($(this));
        });

        // Add med to list
        $('#medicationEntryArea').on('click','.add-current-med-button',function(){
            const $row=$(this).closest('.medication-entry-row');
            const sigData={
                quantity:$row.find('.sig-quantity').val(),
                unit:$row.find('.sig-unit').val(),
                frequency:$row.find('.sig-frequency').val(),
                additional:$row.find('.sig-additional').val()
            };
            const medData={
                drug:$row.find('.medication-drug-input').val(),
                dosageForm:$row.find('.medication-dosage-form').val(),
                sig_structured:sigData
            };
            if (addMedicationToList(medData)) {
                $row.find('.medication-drug-input').val('').focus();
                $row.find('.medication-dosage-form').prop('selectedIndex',0);
                $row.find('.sig-quantity').val('');
                $row.find('.sig-unit')
                    .empty()
                    .append('<option value="">-- Select Form First --</option>')
                    .prop('disabled',true);
                $row.find('.sig-frequency').prop('selectedIndex',0);
                $row.find('.sig-additional').val('');
            }
        });

        // Submit
        $('#patientForm').submit(function(e){
            e.preventDefault();
            const formData={
                firstName:$('#firstName').val(),
                lastName:$('#lastName').val(),
                dob:$('#dob').val(),
                age:$('#age').val(),
                medications:currentMedications
            };
            console.log("SUBMITTING:",JSON.stringify(formData,null,2));
            alert("Form data readyâ€”see console.");
        });

        renderMedicationList();
        populateUnitOptions($('#medicationDosageForm_0'));
    });
</script>

</body>
</html>
