<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Patient Refill Request</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Added Pako.js for gzip decompression -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <style>
        /* --- Core Styles --- */
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        h1, h2, h3 { color: #333; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 800px; margin: auto; }
        /* --- Patient Form --- */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input[type="text"], input[type="date"], input[type="number"], select, button {
            padding: 10px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; width: 100%;
        }
        input[readonly] { background-color: #e9ecef; }
        button { cursor: pointer; background-color: #007bff; color: white; border: none; margin-top: 10px; }
        button:hover { background-color: #0056b3; }
        /* --- History Buttons --- */
        #historyContainer { margin-bottom: 20px; }
        .history-section { border-top: 1px solid #eee; padding-top: 10px; margin-top: 15px; }
        .history-title { font-size: 16px; margin-bottom: 8px; color: #555; }
        .history-btn {
            margin: 4px 4px 4px 0; padding: 8px 12px; font-size: 0.9em;
            background-color: #e6f7ff; border: 1px solid #b3e0ff; color: #0056b3;
            border-radius: 4px; cursor: pointer; display: inline-block;
        }
        .history-btn:hover { background-color: #d0edff; }
        /* --- Medication Entry --- */
        .medication-entry-row { border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; background-color: #f9f9f9; border-radius: 5px; }
        .medication-fields-grid { display: grid; grid-template-columns: 3fr 2fr; gap: 20px; margin-bottom: 15px; }
        .sig-structured-area { border-top: 1px dashed #ccc; margin-top: 15px; padding-top: 15px; }
        .sig-structured-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; align-items: end; margin-bottom: 10px; }
        .sig-additional-info { margin-top: 10px; }
        .form-hint { color: #6c757d; font-size: 0.85em; margin-top: 3px; font-style: italic; }
        /* --- Suggestion Box --- */
        .suggestion-box { position: absolute; background: #fff; border: 1px solid #aaa; z-index: 9999; max-height: 300px; overflow-y: auto; min-width: 300px; max-width: 500px; display: none; border-radius: 4px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); font-size: 14px; }
        .suggestion-item { padding: 6px 12px; cursor: pointer; border-bottom: 1px solid #eee; position: relative; /* Needed for absolute child */ }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover, .suggestion-item.selected { background-color: #e9ecef; }
        .suggestion-med-name { font-weight: 500; display: block; /* Ensure block for badge positioning */ margin-bottom: 2px;}
        .suggestion-brands { font-size: 0.9em; color: #555; font-style: italic; display: block; }
        .more-brands-link { text-decoration: underline; color: #0056b3; cursor: pointer; margin-left: 5px; }
        .manual-entry { background-color: #f8f9fa; border-top: 1px solid #ddd; padding: 8px 12px; }
        .manual-entry strong { color: #007bff; }
        .suggestion-box .no-results { padding: 8px 12px; color:#666; font-style: italic; cursor: default; }
        /* Styling for additional brand items */
         .additional-brands-container .additional-brand-item {
            padding-left: 25px !important; /* Indent more */
            background-color: #f8f9fa !important; /* Different background */
            border-top: 1px dashed #eee; /* Separator */
         }
         .additional-brands-container .additional-brand-item .suggestion-med-name { font-weight: 400; } /* Less emphasis */
         .additional-brands-container .additional-brand-item .suggestion-brands { color: #333; }
          .additional-brands-container { /* Container itself */
              border-left: 3px solid #007bff; /* Indicate relation */
              margin-left: 5px;
           }
        /* --- Medication List --- */
        #medicationsListContainer { margin-top: 20px; border-top: 2px solid #007bff; padding-top: 15px; }
        .added-medication-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 15px; margin-bottom: 12px; border-radius: 4px;
            font-size: 14px; border: 1px solid; position: relative;
        }
         /* Added list: Diff color */
        .added-medication-item.single-med { background-color: #e6f7ff; border-color: #b3e0ff; }
        .added-medication-item.combination-med { background-color: #fff3cd; border-color: #ffeeba; }
        .added-medication-item .med-info { flex-grow: 1; padding-right: 15px; word-break: break-word; }
        .added-medication-item .med-controls { display: flex; gap: 5px; flex-shrink: 0; }
        .added-medication-item .remove-btn {
            padding: 4px 8px; font-size: 12px; background-color: #dc3545;
            width: auto; margin-top: 0; flex-shrink: 0;
        }
        .added-medication-item .remove-btn:hover { background-color: #c82333; }
        .badge {
            display: inline-block; padding: 3px 7px; font-size: 0.75em;
            border-radius: 3px; margin-right: 8px; font-weight: bold; vertical-align: middle;
        }
        .badge.combo { background: #ffc107; color: #212529; } /* Added list badge */
        .badge.dosage { background: #17a2b8; color: #fff; }
        /* --- Messages --- */
        #loadingMessage, #errorMessage, #successMessage { padding: 15px; border-radius: 4px; margin-bottom: 20px; text-align: center; display: none; }
        #loadingMessage { background-color: #ffc107; border: 1px solid #dda700; } /* Use this for loading indication */
        #errorMessage   { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        #successMessage { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        /* --- Validation --- */
        .validation-alert {
            background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404;
            padding: 10px; border-radius: 4px; margin: 10px 0; display: none;
        }
        /* --- Badges & Coloring in Suggestion Box --- */
        .suggestion-box .combination-medication {
             /* NEW: Subtle background for combo drugs in suggestions */
             background-color: #f0f8ff; /* AliceBlue - adjust as needed */
        }
        /* Ensure selected style overrides combo background */
        .suggestion-box .combination-medication.selected {
            background-color: #e9ecef; /* Default selected color */
        }
        .restricted-badge { /* Suggestion box badge */
          display: inline-block;
          background-color: #dc3545;
          color: white;
          font-size: 0.7em;
          padding: 1px 4px;
          border-radius: 3px;
          margin-left: 5px;
          font-weight: bold;
          vertical-align: text-top; /* Align better with text */
        }
        .combo-badge { /* Suggestion box badge */
          display: inline-block;
          background-color: #17a2b8; /* Suggestion: distinct color from list badge */
          color: white;
          font-size: 0.7em;
          padding: 1px 4px;
          border-radius: 3px;
          margin-left: 5px;
          font-weight: bold;
           vertical-align: text-top; /* Align better with text */
        }
         /* Ensure suggestion box badges are visible on selected items */
        .suggestion-item.selected .restricted-badge,
        .suggestion-item.selected .combo-badge {
          color: white; /* Keep text white */
          /* Background might need adjustment if selected color is dark */
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Refill Request</h1>
    <!-- Loading / Error / Success Messages -->
    <div id="loadingMessage">Loading medication data…</div>
    <div id="errorMessage">Error loading data. Please try again later.</div>
    <div id="successMessage">Your refill request has been submitted successfully!</div>
    <!-- Patient Info -->
    <h2>Patient Information</h2>
    <form id="patientForm">
        <div class="form-group">
            <label for="firstName">First Name:</label>
            <input type="text" id="firstName" name="firstName" required>
        </div>
        <div class="form-group">
            <label for="lastName">Last Name:</label>
            <input type="text" id="lastName" name="lastName" required>
        </div>
        <div class="form-group">
            <label for="dob">Date of Birth:</label>
            <input type="date" id="dob" name="dob" required>
        </div>
        <div class="form-group">
            <label for="age">Age:</label>
            <input type="number" id="age" name="age" readonly>
        </div>
        <!-- History of last meds -->
        <div id="historyContainer"></div>
        <h2>Medication Entry</h2>
        <div id="medicationEntryArea">
            <div class="medication-entry-row" id="medicationRow_0">
                <div class="medication-fields-grid">
                    <div style="position: relative;">
                        <label for="medicationDrugField_0">Medication:</label>
                        <!-- ADDED ARIA attributes for Combobox role -->
                        <input type="text" id="medicationDrugField_0" class="medication-drug-input"
                               autocomplete="off"
                               placeholder="Loading drug data..." disabled
                               role="combobox"
                               aria-autocomplete="list"
                               aria-haspopup="listbox"
                               aria-expanded="false"
                               aria-controls="medicationSuggestionBox"
                               aria-activedescendant="">
                        <div class="form-hint">Begin typing 3+ characters to see suggestions</div>
                        <div class="suggestion-anchor" style="position: relative; height: 0;"></div>
                    </div>
                    <div>
                        <label for="medicationDosageForm_0">Form:</label>
                        <select id="medicationDosageForm_0" class="medication-dosage-form">
                            <option value="" disabled selected>-- Select Form --</option>
                            <!-- Keep static options, data matching is primary -->
                            <option value="tablet">Tablet</option>
                            <option value="capsule">Capsule</option>
                            <option value="liquid">Liquid/Syrup</option> <!-- Combined for broader match -->
                            <option value="solution">Solution</option>
                            <option value="suspension">Suspension</option>
                            <option value="injection">Injection</option>
                            <option value="inhaler">Inhaler</option>
                            <option value="topical">Topical</option>
                            <option value="cream">Cream</option>
                            <option value="ointment">Ointment</option>
                            <option value="lotion">Lotion</option>
                            <option value="gel">Gel</option>
                            <option value="patch">Patch</option>
                            <option value="suppository">Suppository</option>
                            <option value="eye drop">Eye Drop</option>
                            <option value="ear drop">Ear Drop</option>
                            <option value="nasal spray">Nasal Spray</option>
                            <option value="powder">Powder</option>
                            <option value="lozenge">Lozenge</option>
                        </select>
                    </div>
                </div>
                <div class="sig-structured-area">
                    <label>Directions / SIG:</label>
                    <div class="validation-alert" id="validationAlert_0"></div>
                    <div class="sig-structured-grid">
                        <div>
                            <label for="sigQuantity_0">Quantity</label>
                            <input type="number" id="sigQuantity_0" class="sig-quantity" min="0" step="0.01"> <!-- Allow decimals -->
                        </div>
                        <div>
                            <label for="sigUnit_0">Unit</label>
                            <select id="sigUnit_0" class="sig-unit" disabled>
                                <option>-- Select Form First --</option>
                            </select>
                        </div>
                        <div>
                            <label for="sigFrequency_0">Frequency</label>
                            <select id="sigFrequency_0" class="sig-frequency">
                                <option value="" disabled selected>-- Select --</option>
                                <option value="once daily">Once daily (QD)</option>
                                <option value="twice daily">Twice daily (BID)</option>
                                <option value="three times daily">Three times daily (TID)</option>
                                <option value="four times daily">Four times daily (QID)</option>
                                <option value="every morning">Every morning (QAM)</option>
                                <option value="every evening">Every evening (QPM)</option>
                                <option value="at bedtime">At bedtime (QHS)</option>
                                <option value="every 4 hours">Every 4 hours</option>
                                <option value="every 6 hours">Every 6 hours</option>
                                <option value="every 8 hours">Every 8 hours</option>
                                <option value="every 12 hours">Every 12 hours</option>
                                <option value="every other day">Every other day</option>
                                <option value="once weekly">Once weekly</option>
                                <option value="twice weekly">Twice weekly</option>
                                <option value="as needed">As needed (PRN)</option>
                                <option value="other">Other (Specify Below)</option>
                            </select>
                        </div>
                    </div>
                    <div class="sig-additional-info">
                        <label for="sigAdditional_0">Additional Info</label>
                        <input type="text" id="sigAdditional_0" class="sig-additional"
                            placeholder="e.g., for pain, with food, etc.">
                    </div>
                </div>
                <button type="button" class="add-current-med-button">Add Medication</button>
            </div>
        </div>
        <h2>Your Medications</h2>
        <div id="medicationsListContainer">
            <p>No medications added.</p>
        </div>
        <hr>
        <button type="submit">Submit Request</button>
    </form>
    <!-- Autocomplete Suggestions - ADDED role="listbox" -->
    <div class="suggestion-box" id="medicationSuggestionBox" role="listbox"></div>
</div>
<script>
    // IIFE to encapsulate code
    (function($) {
    // ---------------------------------------------------------
    // CONFIG
    // ---------------------------------------------------------
    const COMPILED_DATA_URL = 'https://raw.githubusercontent.com/irfanrajani/CliniStream-OscarEMR/main/compiled_drug_data.json.gz';
    let compiledDrugData = [];
    let currentMedications = [];
    const MAX_SUGGESTIONS = 10;
    const MAX_BRANDS_DISPLAY = 3;
    const MAX_HISTORY_ITEMS = 15;

    // Updated dosageFormUnits with explicit lowercase keys and added 'syrup'
    const dosageFormUnits = {
        'tablet': ['tablet(s)'], 'capsule': ['capsule(s)'], 'lozenge': ['lozenge(s)'],
        'powder': ['packet(s)', 'scoop(s)', 'gram(s)', 'mg'],
        'liquid': ['mL','tsp (5mL)','tbsp (15mL)'], // Primary key for liquids
        'solution': ['mL','tsp (5mL)','tbsp (15mL)'],
        'suspension': ['mL','tsp (5mL)','tbsp (15mL)'],
        'syrup': ['mL','tsp (5mL)','tbsp (15mL)'], // Explicitly add syrup units
        'injection': ['mL','unit(s)'], 'inhaler': ['puff(s)','inhalation(s)'],
        'nasal spray': ['spray(s) in nostril(s)','spray(s) in left nostril','spray(s) in right nostril'],
        'topical': ['application(s)','gram(s)','mL'], 'cream': ['application(s)','gram(s)'],
        'ointment': ['application(s)','gram(s)'], 'lotion': ['application(s)','mL'],
        'gel': ['application(s)','gram(s)'], 'patch': ['patch(es)'],
        'suppository': ['suppository(ies)'],
        'eye drop': ['drop(s)','drop(s) in eye(s)','drop(s) in left eye','drop(s) in right eye'],
        'ear drop': ['drop(s)','drop(s) in ear(s)','drop(s) in left ear','drop(s) in right ear']
    };

    // Enhanced form mappings for better matching
     const formMappings = {
            'tablet': 'tablet', 'tab': 'tablet','tabs': 'tablet', 'tbl': 'tablet', 'chew tab': 'tablet', 'odt': 'tablet', 'dr tab': 'tablet', 'er tab': 'tablet',
            'capsule': 'capsule', 'cap': 'capsule','caps': 'capsule', 'gelcap': 'capsule', 'dr cap': 'capsule', 'er cap': 'capsule',
            'liquid': 'liquid', 'liq': 'liquid', 'oral liq': 'liquid',
            'solution': 'solution', 'soln': 'solution', 'sol': 'solution', 'oral soln': 'solution',
            'suspension': 'suspension', 'susp': 'suspension', 'oral susp': 'suspension',
            'syrup': 'liquid', // Map syrup to the combined liquid/syrup option
            'elixir': 'liquid', // Map elixir to liquid/syrup option
            'injection': 'injection', 'inj': 'injection', 'sc': 'injection', 'im': 'injection', 'iv': 'injection',
            'inhaler': 'inhaler', 'inhaln': 'inhaler', 'mdi': 'inhaler', 'dpi': 'inhaler', 'neb': 'solution', // Neb solution might be 'solution'
            'topical': 'topical', 'topic': 'topical',
            'cream': 'cream', 'crm': 'cream',
            'ointment': 'ointment', 'oint': 'ointment', 'ung': 'ointment',
            'lotion': 'lotion', 'lot': 'lotion',
            'gel': 'gel',
            'patch': 'patch', 'td patch': 'patch',
            'suppository': 'suppository', 'supp': 'suppository',
            'eye drop': 'eye drop', 'ophth drop': 'eye drop', 'eye drops': 'eye drop',
            'ear drop': 'ear drop', 'otic drop': 'ear drop', 'ear drops': 'ear drop',
            'nasal spray': 'nasal spray', 'nas spray': 'nasal spray',
            'powder': 'powder', 'pwd': 'powder', 'for soln': 'powder', 'for susp': 'powder',
            'lozenge': 'lozenge', 'loz': 'lozenge'
            // Add more mappings as needed based on your specific data
        };

    // ---------------------------------------------------------
    // **** NEW: Function to load and decompress data ****
    // ---------------------------------------------------------
    async function loadCompiledDrugData() {
        console.log("Attempting to load compiled drug data...");
        $('#loadingMessage').text('Loading medication data... Please wait.').show();
        $('#errorMessage').hide();
        $('.medication-drug-input').prop('disabled', true).attr('placeholder', 'Loading drug data...'); // Disable input during load

        try {
            const response = await fetch(COMPILED_DATA_URL);
            console.log("Fetch response status:", response.status);
            if (!response.ok) {
                throw new Error(`Failed to fetch drug data: ${response.status} ${response.statusText}`);
            }
            const compressedData = await response.arrayBuffer();
            console.log(`Fetched ${compressedData.byteLength} bytes (compressed).`);
            if (compressedData.byteLength === 0) {
                 throw new Error("Downloaded data file is empty.");
            }
            console.log("Decompressing data...");
            const decompressed = pako.inflate(compressedData, { to: 'string' });
            console.log(`Decompressed data length: ${decompressed.length} characters.`);
            console.log("Parsing JSON...");
            const data = JSON.parse(decompressed);
            console.log("JSON parsed successfully.");

            // Basic validation: Check if it's an array
             if (!Array.isArray(data)) {
                 throw new Error("Parsed data is not an array.");
             }
             // Optional: Check first item structure
             /* if (data.length > 0 && (typeof data[0].drug_code === 'undefined' || typeof data[0].brand_name === 'undefined')) {
                 console.warn("Parsed data structure might be unexpected.");
             } */

            $('#loadingMessage').hide();
            // Enable input ONLY on successful parse and non-empty array
            if (data.length > 0) {
                 $('.medication-drug-input')
                     .prop('disabled', false)
                     .attr('placeholder', 'Start typing medication name…');
                console.log(`Successfully loaded ${data.length} drug records.`);
            } else {
                 throw new Error("Loaded data is an empty array.");
            }
            return data; // Return the validated data
        } catch (error) {
            console.error('Error loading or processing compiled drug data:', error);
            const userMessage = `Unable to load medication data. Please check your internet connection or refresh the page. Error: ${error.message}`;
            $('#errorMessage').text(userMessage).show();
            $('#loadingMessage').hide();
            $('.medication-drug-input').prop('disabled', true).attr('placeholder', 'Error loading drug data'); // Keep disabled
            return []; // Return empty array on failure
        }
    }
    // ---------------------------------------------------------
    // Utility: History per patient
    // ---------------------------------------------------------
    function historyKeyBase() {
        const first = $('#firstName').val().trim().toLowerCase();
        const last = $('#lastName').val().trim().toLowerCase();
        const dob = $('#dob').val();
        if (!first || !dob) return null; // Require first name and DOB
        return `${first}_${last}_${dob}`;
    }
    function historyKey() {
        const base = historyKeyBase();
        return base ? `medHistory:${base}` : null;
    }
    function historyKeyPrevRequests() {
         const base = historyKeyBase();
        return base ? `prevRequests:${base}` : null;
    }
    function saveToHistory(med) {
        const key = historyKey();
        if (!key) return;
        try {
            let hist = JSON.parse(localStorage.getItem(key) || '[]');
            const medLower = med.drug.toLowerCase();
            // Remove existing entry for the same drug (case-insensitive) and add new one to front
            hist = [med, ...hist.filter(m => m.drug.toLowerCase() !== medLower)].slice(0, MAX_HISTORY_ITEMS);
            localStorage.setItem(key, JSON.stringify(hist));
        } catch (e) {
            console.error("Error saving to history:", e);
        }
    }
    function savePreviousRequest() {
        const key = historyKeyPrevRequests();
        if (!key || !currentMedications.length) return;
        const request = {
            timestamp: new Date().toISOString(),
            medications: JSON.parse(JSON.stringify(currentMedications)) // Deep copy
        };
        try {
            let prevRequests = JSON.parse(localStorage.getItem(key) || '[]');
            prevRequests.unshift(request);
            if (prevRequests.length > 5) prevRequests = prevRequests.slice(0, 5); // Limit to 5 previous requests
            localStorage.setItem(key, JSON.stringify(prevRequests));
        } catch (e) {
            console.error("Error saving previous request:", e);
        }
    }
    function loadHistoryList() {
        const $cont = $('#historyContainer').empty();
        if (!$('#firstName').val() || !$('#dob').val()) return;

        const medKey = historyKey();
        if (medKey) {
            try {
                const hist = JSON.parse(localStorage.getItem(medKey) || '[]');
                if (hist.length) {
                    $cont.append('<div class="history-section"><div class="history-title">Recently Used Medications</div><div id="recentMedsHistory"></div></div>');
                    const $recentMeds = $('#recentMedsHistory');
                    hist.forEach(med => {
                        const displaySig = med.sig_string || 'Click to fill';
                        const $btn = $('<button type="button" class="history-btn">')
                            .text(med.drug)
                            .attr('title', displaySig) // Show SIG on hover
                            .on('click', () => {
                                const $row = $('#medicationRow_0');
                                $row.find('.medication-drug-input').val(med.drug).data('selectedMedData', null);
                                $row.find('.sig-quantity').val( med.sig_structured?.quantity || '');
                                $row.find('.sig-frequency').val( med.sig_structured?.frequency || '');
                                $row.find('.sig-additional').val( med.sig_structured?.additional || '');
                                const $form = $row.find('.medication-dosage-form');
                                let selectedFormValue = '';
                                if (med.dosageForm) {
                                    selectedFormValue = med.dosageForm.toLowerCase();
                                    const match = $form.find('option').filter(function() {
                                        return this.value.toLowerCase() === selectedFormValue;
                                    });
                                     if(match.length) {
                                        $form.val(match.val());
                                        selectedFormValue = match.val(); // Use the matched value
                                     } else {
                                        // Try mapping it if direct match fails
                                        const mapped = formMappings[selectedFormValue];
                                        const mappedMatch = $form.find('option').filter(function() { return this.value === mapped; });
                                        if (mappedMatch.length) {
                                            $form.val(mappedMatch.val());
                                            selectedFormValue = mappedMatch.val();
                                        } else {
                                            $form.prop('selectedIndex', 0); // Fallback
                                            selectedFormValue = '';
                                        }
                                     }
                                } else {
                                     $form.prop('selectedIndex', 0);
                                }
                                populateUnitOptions($form); // Populate units FIRST
                                // Now try to set the unit
                                if (med.sig_structured?.unit) {
                                    if ($row.find('.sig-unit option[value="' + med.sig_structured.unit + '"]').length > 0) {
                                      $row.find('.sig-unit').val(med.sig_structured.unit);
                                    } else {
                                      $row.find('.sig-unit').prop('selectedIndex', 0); // Fallback
                                    }
                                } else {
                                   // If no unit saved, try to default based on form
                                   setDefaultUnit($row, selectedFormValue); // Use helper to set default
                                }
                                $row.find('.sig-quantity').focus();
                            });
                        $recentMeds.append($btn);
                    });
                }
            } catch(e){ console.error("Error loading medication history:", e); }
        }

        const reqKey = historyKeyPrevRequests();
        if (reqKey) {
           try {
               const prevRequests = JSON.parse(localStorage.getItem(reqKey) || '[]');
               if (prevRequests.length) {
                    $cont.append('<div class="history-section"><div class="history-title">Previous Refill Requests</div><div id="previousRequestsList"></div></div>');
                    const $prevList = $('#previousRequestsList');
                    prevRequests.forEach((req, i) => {
                        const date = new Date(req.timestamp);
                        const dateStr = date.toLocaleDateString();
                        const numMeds = req.medications.length;
                        const $btn = $('<button type="button" class="history-btn">')
                            .html(`${dateStr} (${numMeds} med${numMeds !== 1 ? 's' : ''})`)
                            .on('click', () => {
                                if (confirm(`Replace your current list with the ${numMeds} medication(s) from your ${dateStr} request?`)) {
                                    currentMedications = JSON.parse(JSON.stringify(req.medications)); // Deep copy
                                    renderMedicationList();
                                    clearMedicationEntryForm($('#medicationRow_0'));
                                }
                            });
                        $prevList.append($btn);
                    });
                }
            } catch(e){ console.error("Error loading previous requests:", e); }
        }
    }
    // ---------------------------------------------------------
    // Populate units based on form
    // ---------------------------------------------------------
    function populateUnitOptions($formSelect) {
        const selectedFormValue = ($formSelect.val() || "").toLowerCase(); // Use lowercase form value from dropdown
        const $row = $formSelect.closest('.medication-entry-row');
        const $unitSelect = $row.find('.sig-unit');
        const currentUnitVal = $unitSelect.val();
        $unitSelect.empty().prop('disabled', true);

        // Find units - direct match or check liquid variations
        let units = dosageFormUnits[selectedFormValue];
         if (!units && ['liquid', 'solution', 'suspension', 'syrup'].includes(selectedFormValue)) {
             units = dosageFormUnits['liquid']; // Fallback to 'liquid' units for variations
         }

        if (units && units.length > 0) {
            $unitSelect.append('<option value="" disabled selected>-- Select Unit --</option>');
            units.forEach(u => $unitSelect.append($('<option>').val(u).text(u)));
            $unitSelect.prop('disabled', false);
             // Reselect previous value if valid
             if (currentUnitVal && units.includes(currentUnitVal)) {
                 $unitSelect.val(currentUnitVal);
             }
        } else {
            $unitSelect.append('<option>-- Select Form First --</option>');
        }
    }

    // ---------------------------------------------------------
    // Helper: Set Default Unit based on form
    // ---------------------------------------------------------
     function setDefaultUnit($row, formValueLower) {
         if (!formValueLower) return; // Exit if no form selected
         const $unitSelect = $row.find('.sig-unit');
         const availableUnits = dosageFormUnits[formValueLower] ||
                                (['liquid', 'solution', 'suspension', 'syrup'].includes(formValueLower) ? dosageFormUnits['liquid'] : []);

         if (availableUnits.length === 0) return; // No units for this form

         let unitToSelect = null;
         // --- Enhanced Default Unit Logic ---
         if (formValueLower.includes('tablet')) unitToSelect = 'tablet(s)';
         else if (formValueLower.includes('capsule')) unitToSelect = 'capsule(s)';
         else if (['liquid', 'solution', 'suspension', 'syrup'].includes(formValueLower)) unitToSelect = 'mL';
         else if (['cream', 'ointment', 'gel', 'topical'].includes(formValueLower)) unitToSelect = 'application(s)';
         else if (formValueLower.includes('lotion')) unitToSelect = 'application(s)';
         else if (formValueLower.includes('inhaler')) unitToSelect = 'puff(s)';
         else if (formValueLower.includes('eye drop')) unitToSelect = 'drop(s) in eye(s)'; // Be more specific
         else if (formValueLower.includes('ear drop')) unitToSelect = 'drop(s) in ear(s)'; // Be specific
         else if (formValueLower.includes('nasal spray')) unitToSelect = 'spray(s) in nostril(s)';
         else if (formValueLower.includes('patch')) unitToSelect = 'patch(es)';
         else if (formValueLower.includes('lozenge')) unitToSelect = 'lozenge(s)';
         else if (formValueLower.includes('powder')) unitToSelect = 'packet(s)'; // Default powder unit
         else if (formValueLower.includes('suppository')) unitToSelect = 'suppository(ies)';
         else if (formValueLower.includes('injection')) unitToSelect = 'mL'; // Default injection unit

         // Set the default if found and exists in dropdown
         if (unitToSelect && $unitSelect.find(`option[value="${unitToSelect}"]`).length) {
             $unitSelect.val(unitToSelect);
         } else if (availableUnits.length > 0 && $unitSelect.find('option').length > 1) {
             // Fallback: select the first *actual* unit option if no specific default matches
             $unitSelect.prop('selectedIndex', 1); // Select the first non-placeholder option
         }
     }


    // ---------------------------------------------------------
    // Auto-select form/unit based on selected medication data - REVISED
    // ---------------------------------------------------------
    function autoSelectFormAndUnits(medData, $inputField) {
        if (!medData || !$inputField || !$inputField.length) return;
        const $row = $inputField.closest('.medication-entry-row');
        const $form = $row.find('.medication-dosage-form');
        const $unit = $row.find('.sig-unit');
        const $quantity = $row.find('.sig-quantity');

        // --- Prioritize `forms` array from medData ---
        const primaryForms = medData.forms || [];
        let formFromData = null;
        if (primaryForms.length > 0) {
             formFromData = primaryForms[0]; // Use the first form from the list
             console.log("Form from data:", formFromData);
        }

        // --- Fallback: Try to extract form from names ONLY IF formFromData is missing ---
        if (!formFromData) {
            console.log("No form in data, trying name match...");
            // Simplified regex for common forms as a LAST resort
            const nameFormMatch = medData.brand_name ? medData.brand_name.match(/\b(tab|cap|crm|oin|gel|sol|sus|syr|inj|inh|lot|pat|dro|spr|pow|loz)\b/i) : null;
             if (nameFormMatch) {
                 formFromData = nameFormMatch[1]; // Use the matched abbreviation/word
                 console.log("Form from name match:", formFromData);
             }
            // Consider drug name/descriptor too if needed
             /* if (!formFromData && medData.drug) { ... } */
        }

        // --- Normalize and attempt to match to dropdown options ---
        const normalizedForm = (formFromData || '').trim().toLowerCase();
        let finalSelectedFormValue = ''; // Track the value actually set in the dropdown
        let formSelected = false;

       // Clear previous selections but keep quantity
        $unit.empty().append('<option>-- Select Form First --</option>').prop('disabled', true);
        $form.prop('selectedIndex', 0); // Reset form dropdown

       if (normalizedForm) {
            console.log("Normalized form to match:", normalizedForm);
            let bestMatchValue = null;

            // 1. Try direct case-insensitive match with dropdown option values
            $form.find('option').each(function() {
                if (this.value.toLowerCase() === normalizedForm) {
                    bestMatchValue = this.value;
                    return false; // Found exact match
                }
            });

            // 2. If no direct match, try the enhanced `formMappings`
            if (!bestMatchValue) {
                const mappedFormValue = formMappings[normalizedForm];
                if (mappedFormValue) {
                     console.log("Mapped form:", mappedFormValue);
                     // Check if the mapped value exists in the dropdown
                     if ($form.find(`option[value="${mappedFormValue}"]`).length) {
                         bestMatchValue = mappedFormValue;
                     }
                }
            }

             // 3. If still no match, try partial matching (less reliable, use cautiously)
             /* if (!bestMatchValue) {
                 $form.find('option').each(function() { ... });
             } */

            // --- Set the form and proceed if a match was found ---
             if (bestMatchValue) {
                 console.log("Selecting form:", bestMatchValue);
                 $form.val(bestMatchValue);
                 finalSelectedFormValue = bestMatchValue.toLowerCase(); // Store the actual selected value (lowercase)
                 populateUnitOptions($form); // IMPORTANT: Populate units AFTER setting form
                 formSelected = true;

                // Set default quantity if empty
                 if (!$quantity.val()) {
                    $quantity.val('1');
                 }

                 // --- Set Default Unit ---
                 // Use setTimeout to ensure DOM update for units dropdown
                 setTimeout(() => {
                     setDefaultUnit($row, finalSelectedFormValue); // Use helper function
                     console.log("Default unit potentially set for:", finalSelectedFormValue);
                 }, 50); // Small delay

            } else {
                 console.warn("Could not reliably map data form '" + normalizedForm + "' to a dropdown option.");
            }
        }

        // If no form was successfully selected from data, ensure units are reset based on the placeholder
        if (!formSelected) {
             populateUnitOptions($form);
        }
    }

    // ---------------------------------------------------------
    // Validate medication entry
    // ---------------------------------------------------------
    function validateMedicationEntry(medData, $alert) {
        $alert.hide().empty();
        let isValid = true;
        let warnings = [];
        const { quantity, unit, frequency, additional } = medData.sig_structured;

        if (!medData.drug.trim()) {
            $alert.text("Please select or enter a medication name.").show();
            return false; // Hard stop
        }
        if ((!quantity && quantity !== 0 && quantity !== '0') || !unit || !frequency) {
            $alert.html("Please fill in <strong>Quantity</strong>, <strong>Unit</strong>, and <strong>Frequency</strong>.").show();
             isValid = false;
        }
        // More specific warnings based on data
        if (unit && quantity && (unit.includes('tablet') || unit.includes('capsule')) && parseFloat(quantity) > 4) {
             warnings.push("High dose: Taking more than 4 tablets/capsules at once may be unusual.");
        }
        if (unit && frequency && (frequency.includes('four times') || frequency.includes('every 4 hours') || frequency.includes('every 6 hours')) &&
           (unit.includes('tablet') || unit.includes('capsule')) ) {
             warnings.push("Frequent dosing: Taking tablets/capsules 4+ times/day. Please confirm.");
        }
         if (frequency === 'as needed' && !additional?.trim()) {
            warnings.push("Consider adding reason for 'as needed' use (e.g., 'for pain').");
         }
        if (frequency === 'other' && !additional?.trim()) {
             warnings.push("Please specify frequency in 'Additional Info' when 'Other' is selected.");
             // Consider making this a hard fail depending on workflow
             // isValid = false;
        }
        if (warnings.length > 0) {
           const warningHtml = warnings.map(w => `<li>⚠️ ${w}</li>`).join('');
           // Append warnings to the existing message if validation failed
           const currentHtml = $alert.html();
           const message = (currentHtml ? currentHtml + '<br>' : '') + `<strong>Warnings:</strong><ul>${warningHtml}</ul>`;
           $alert.html(message).show();
        }
        return isValid;
    }
    // ---------------------------------------------------------
    // Render Med List with badges
    // ---------------------------------------------------------
    function renderMedicationList() {
        const $c = $('#medicationsListContainer').empty();
        if (!currentMedications.length) {
            return $c.html('<p>No medications added.</p>');
        }
        // Group medications for display (based on base name, show multiple strengths)
        const medicationGroups = {};
        currentMedications.forEach(med => {
             // More robust base name extraction (handles decimals, common units better)
            let baseName = med.drug.replace(/\s+\d+(\.\d+)?\s*(mg|mcg|g|ml|%|unit[s]?|meq|iu)(?:\/\w+)?(\s*\(.*\))?$/i, '') // Remove strength/unit and trailing parenthetical if any
                                   .replace(/\s+(tab|cap|soln|susp|syr|inj|oint|crm|lot|gel|inh)\.?$/i,'').trim(); // Remove trailing form abbrev.
            if (!baseName) baseName = med.drug; // Fallback if regex strips everything

            if (!medicationGroups[baseName]) {
                medicationGroups[baseName] = { base: baseName, meds: [], strengths: new Set() }; // Use Set for uniqueness
            }
            medicationGroups[baseName].meds.push(med);
            // Extract strength for display badge
            let strengthText = '';
            if (Array.isArray(med.ingredients) && med.ingredients.length > 0 && med.ingredients[0]?.strength) {
                strengthText = `${med.ingredients[0].strength}${med.ingredients[0].unit || ''}`;
            } else { // Fallback to regex on drug name
                const strengthMatch = med.drug.match(/\d+(\.\d+)?\s*(mg|mcg|g|ml|%|unit[s]?|meq|iu)(?:\/\w+)?/i);
                if (strengthMatch) strengthText = strengthMatch[0];
            }
            if (strengthText) medicationGroups[baseName].strengths.add(strengthText); // Add to Set
        });

        // Render each group
        Object.values(medicationGroups).forEach(group => {
            const m = group.meds[0]; // Use first med in group as representative for info
            const i = currentMedications.indexOf(m); // Index for removal logic
            const isCombo = Array.isArray(m.ingredients) && m.ingredients.length > 1;
            const cls = isCombo ? 'combination-med' : 'single-med';
            const $item = $('<div>').addClass('added-medication-item').addClass(cls).attr('data-index', i); // Store index of first item in group
            const $info = $('<div class="med-info">');

            if (isCombo) $info.append('<span class="badge combo">Combo</span>');

            // Add unique strength badges
            group.strengths.forEach(strength => $info.append(`<span class="badge dosage">${strength}</span>`));

            // Display base name and SIG
            $info.append($('<span>').text(`${group.base} – SIG: ${m.sig_string || 'N/A'}`));

            const $controls = $('<div class="med-controls">');
            const $removeBtn = $('<button type="button" class="remove-btn">Remove</button>').on('click', () => {
                if (confirm(`Remove "${group.base}" (all strengths) from your list?`)) {
                    // Remove ALL medications matching this base name from the original list
                     currentMedications = currentMedications.filter(med => {
                         // Re-calculate base name for comparison logic
                         let medBaseName = med.drug.replace(/\s+\d+(\.\d+)?\s*(mg|mcg|g|ml|%|unit[s]?|meq|iu)(?:\/\w+)?(\s*\(.*\))?$/i, '')
                                                   .replace(/\s+(tab|cap|soln|susp|syr|inj|oint|crm|lot|gel|inh)\.?$/i,'').trim();
                         if (!medBaseName) medBaseName = med.drug;
                         return medBaseName !== group.base;
                     });
                    renderMedicationList(); // Re-render
                }
            });
            $controls.append($removeBtn);
            $item.append($info, $controls);
            $c.append($item);
        });
    }
    // ---------------------------------------------------------
    // Clear Medication Entry Form
    // ---------------------------------------------------------
    function clearMedicationEntryForm($row) {
        $row.find('.medication-drug-input').val('').data('selectedMedData', null).attr('aria-activedescendant', ''); // Clear ARIA too
        $row.find('.medication-dosage-form').prop('selectedIndex', 0);
        $row.find('.sig-quantity').val('');
        $row.find('.sig-unit').empty().prop('disabled', true).append('<option>-- Select Form First --</option>');
        $row.find('.sig-frequency').prop('selectedIndex', 0);
        $row.find('.sig-additional').val('');
        $row.find('.validation-alert').hide().empty();
        $row.find('.medication-drug-input').focus();
    }
    // ---------------------------------------------------------
    // Add med, with validation
    // ---------------------------------------------------------
    function addMedicationToList(medData, $row) {
        const $alert = $row.find('.validation-alert');
        if (!validateMedicationEntry(medData, $alert)) {
            return false;
        }
        // Build SIG string
        const { quantity, unit, frequency, additional } = medData.sig_structured;
        let action = "Take";
        const formVal = medData.dosageForm || "";
        const fLower = formVal.toLowerCase();
        if (['apply','topical','cream','ointment','lotion','gel','patch'].some(t => fLower.includes(t))) action = "Apply";
        else if (['instill','drop'].some(t => fLower.includes(t))) action = "Instill";
        else if (['inhale','inhaler','spray'].some(t => fLower.includes(t))) action = "Use";
        else if (['inject','injection'].some(t => fLower.includes(t))) action = "Inject";
        else if (['insert','suppository'].some(t => fLower.includes(t))) action = "Insert";

        let sigParts = [action];
        if (quantity) sigParts.push(quantity);
        if (unit) sigParts.push(unit);
        if (frequency && frequency !== 'other') sigParts.push(frequency);
        if (additional?.trim()) {
            // If freq is 'other', additional *is* the frequency, otherwise it's extra info
            if (frequency === 'other') {
                 sigParts.push(`(${additional.trim()})`); // Indicate it replaces 'other'
            } else {
                sigParts.push(`(${additional.trim()})`); // Add as extra info
            }
        } else if (frequency === 'other') {
             sigParts.push('(as specified)'); // Placeholder if 'Other' selected but no text
        }

        medData.sig_string = sigParts.join(' ').replace(/\s+/g, ' ').trim(); // Consolidate whitespace
        medData.drug = medData.drug.trim();
        medData.dosageForm = formVal; // Ensure dosage form is stored

        const selectedData = $row.find('.medication-drug-input').data('selectedMedData');
         if (selectedData) {
             // Use structured data if available
             medData.ingredients = selectedData.active_ingredients;
             medData.forms = selectedData.forms;
             medData.drug_code = selectedData.drug_code;
             medData.is_restricted = selectedData.is_restricted;
         } else {
             // Handle manually entered data: assume single ingredient unless '/' present, clear other fields
             medData.ingredients = [{ name: medData.drug, strength: null, unit: null }]; // Basic structure
             medData.forms = [];
             medData.drug_code = null;
             medData.is_restricted = false; // Assume not restricted if entered manually
             console.log("Manual entry - creating basic ingredient structure");
         }

        currentMedications.push(medData);
        saveToHistory(medData);
        renderMedicationList();
        loadHistoryList();
        clearMedicationEntryForm($row);
        return true;
    }
    // --- Helper to handle selecting a suggestion ---
    function selectSuggestion(medData, targetInput, nameToSet) {
        if (!medData || !targetInput || !targetInput.length) return;
        targetInput.val(nameToSet).trigger('change'); // Use trigger('change') for other listeners
        targetInput.data('selectedMedData', medData);
        autoSelectFormAndUnits(medData, targetInput); // Use the improved function
        targetInput.closest('.medication-entry-row').find('.sig-quantity').focus();
        $('#medicationSuggestionBox').hide();
         targetInput.attr('aria-expanded', 'false').attr('aria-activedescendant', ''); // Update ARIA on selection
    }
    // ---------------------------------------------------------
    // Autocomplete - Setup and Event Handlers
    // ---------------------------------------------------------
    function attachMedAutocomplete($input) {
        // Initial check, but rely on load function to enable/disable input
        if (compiledDrugData.length === 0) return;

        const $box = $('#medicationSuggestionBox');
        const inputId = $input.attr('id');
        let suggestions = [], dataArr = [], idx = -1, debounce;

        function positionBox() {
            const inputRect = $input[0].getBoundingClientRect();
            const scrollTop = $(window).scrollTop();
            const scrollLeft = $(window).scrollLeft();
            const inputWidth = $input.outerWidth();
            $box.css({
                top: (inputRect.bottom + scrollTop) + "px",
                left: (inputRect.left + scrollLeft) + "px",
                minWidth: inputWidth + "px"
            }).show();
            $input.attr('aria-expanded', 'true'); // Update ARIA when showing
        }
        // --- Displays the suggestion list (with ARIA) ---
        function displaySuggestions(results) {
            $box.empty();
            suggestions = [];
            dataArr = [];
            idx = -1;
            $input.attr('aria-activedescendant', ''); // Clear active descendant

            if (!results || results.length === 0) {
                $box.html('<div class="no-results" role="option">No eligible medications found.</div>'); // Role option for no results too
                positionBox();
                return;
            }
           // Grouping logic (remains similar, based on ingredients + strength + form)
            function normalizeStrength(strength, unit) { /* ... (keep existing) ... */
                if (strength === undefined || strength === null) return '';
                let strVal = String(strength).trim();
                if (strVal.startsWith('.')) strVal = '0' + strVal;
                const numVal = parseFloat(strVal);
                return isNaN(numVal) ? strVal : numVal + (unit || '');
            }
            const map = new Map();
            results.forEach(item => {
                const ingKey = (item.active_ingredients || []).map(ing => `${ing.name.toLowerCase()}:${normalizeStrength(ing.strength, ing.unit)}`).sort().join('|');
                const firstForm = ((item.forms || [])[0] || '').toLowerCase();
                const key = `${ingKey}::${firstForm}`;
                if (!map.has(key)) {
                    const allBrandsForCombo = results.filter(fItem => {
                        const fIngKey = (fItem.active_ingredients || []).map(ing => `${ing.name.toLowerCase()}:${normalizeStrength(ing.strength, ing.unit)}`).sort().join('|');
                        const fFirstForm = ((fItem.forms || [])[0] || '').toLowerCase();
                        return `${fIngKey}::${fFirstForm}` === key;
                    }).map(fItem => fItem.brand_name).filter(brand => brand && brand.trim() !== '');
                    /* Add generic name if no brands exist */
                     if (allBrandsForCombo.length === 0 && Array.isArray(item.active_ingredients) && item.active_ingredients.length > 0) {
                        const genericNameAsBrand = item.active_ingredients.map(ing => ing.name).join(' / ');
                        if (genericNameAsBrand && !allBrandsForCombo.includes(genericNameAsBrand)) {
                            allBrandsForCombo.push(genericNameAsBrand);
                        }
                     }
                    map.set(key, { representativeItem: item, brands: [...new Set(allBrandsForCombo)] });
                }
            });
            const list = Array.from(map.values()).slice(0, MAX_SUGGESTIONS);
            list.forEach((group, i) => {
                const item = group.representativeItem;
                const brands = group.brands;
                let mainText = ''; // Construct display name (Ingredient + Strength + Form)
                if (Array.isArray(item.active_ingredients) && item.active_ingredients.length > 0) {
                     mainText = item.active_ingredients.map(ing => `${ing.name}${ing.strength ? ' ' + ing.strength + (ing.unit || '') : ''}`).join(' / ');
                } else { mainText = item.drug || 'Unknown'; }
                const firstForm = (item.forms || [])[0];
                if (firstForm) mainText += ` (${firstForm})`;

                const suggestionId = `${inputId}-suggestion-${i}`; // Unique ID for ARIA
                const $opt = $('<div class="suggestion-item" role="option">') // Added role="option"
                    .attr('id', suggestionId)
                    .data('medData', item)
                    .data('allBrands', brands);

                const isCombo = (item.active_ingredients || []).length > 1;
                if (isCombo) $opt.addClass('combination-medication'); // Class for styling

                const $nameSpan = $('<span class="suggestion-med-name">').text(mainText);
                if (isCombo) $nameSpan.append($('<span class="combo-badge">').text('Combo'));
                if (item.is_restricted) $nameSpan.append($('<span class="restricted-badge">').text('Restricted'));
                $opt.append($nameSpan);

                // Brand display logic (unchanged, but check ARIA implications if needed)
                 if (brands.length > 0) {
                     const displayableBrands = brands.filter(b => b !== mainText); // Don't list generic name as brand if it's the main text
                     const limitedBrands = displayableBrands.slice(0, MAX_BRANDS_DISPLAY);
                     if (limitedBrands.length > 0) {
                         let brandHtml = 'Brands: ' + limitedBrands.join(', ');
                         if (displayableBrands.length > MAX_BRANDS_DISPLAY) {
                             // Clicking this doesn't change selection, so ARIA might not be critical for the link itself
                             brandHtml += `<span class="more-brands-link" data-group-index="${i}">(+${displayableBrands.length - MAX_BRANDS_DISPLAY} more)</span>`;
                         }
                         $opt.append($('<span class="suggestion-brands">').html(brandHtml));
                     }
                 }
                // Event handlers for selection
                $opt.on('mousedown', (ev) => {
                    if ($(ev.target).hasClass('more-brands-link')) return;
                    ev.preventDefault();
                    selectSuggestion($(ev.currentTarget).data('medData'), $input, mainText);
                });
                $opt.on('mouseenter', () => {
                    $box.find('.suggestion-item').removeClass('selected').attr('aria-selected', 'false'); // Update ARIA on others
                    $opt.addClass('selected').attr('aria-selected', 'true'); // Update ARIA on current
                    idx = $box.find('.suggestion-item:not(.additional-brand-item)').index($opt);
                    $input.attr('aria-activedescendant', suggestionId); // Set active descendant
                });
                $box.append($opt);
                suggestions.push($opt);
                dataArr.push(item);
            });
            // Add manual entry option (consider making focusable/selectable via keyboard?)
            $box.append('<div class="suggestion-item manual-entry" role="option" id="' + inputId + '-manual-entry">Can\'t find it? <strong>Enter manually</strong></div>');
            positionBox();
        }
        // --- Event handler for clicking "more brands" --- logic unchanged ---
        // --- Find matching drugs (includes filtering restricted) --- logic unchanged ---
        // --- Input field event handlers with ARIA updates ---
        $input.on('input', () => {
            clearTimeout(debounce);
            const value = $input.val().trim();
            // Clear data if user types something different than what was selected
            const selectedData = $input.data('selectedMedData');
            const currentDisplayValue = $input.val(); // Raw value
             // Simplier check: if data exists and value changes, clear data.
              if (selectedData && currentDisplayValue !== selectedData._lastSetInputValue) { // Use a stored value if exact name mapping is complex
                 $input.data('selectedMedData', null);
                 $input.removeData('_lastSetInputValue'); // Clean up
                 console.log("Input changed after selection, clearing stored data.");
              }
            if (value.length < 3) {
                $box.hide();
                 $input.attr('aria-expanded', 'false'); // Update ARIA
                 $input.attr('aria-activedescendant', ''); // Clear active
                return;
            }
            debounce = setTimeout(() => findMatching(value), 150);
        });
        // --- Keydown handler with ARIA ---
        $input.on('keydown', (e) => {
            if (!$box.is(':visible')) return;
            // Include manual entry in navigable items
            const $items = $box.find('.suggestion-item:not(.additional-brand-item)');
            if ($items.length === 0) return;

            if (['ArrowDown', 'ArrowUp', 'Enter', 'Escape', 'Tab'].includes(e.key)) {
                e.preventDefault();
                if (e.key === 'Escape' || e.key === 'Tab') {
                    $box.hide();
                    $input.attr('aria-expanded', 'false').attr('aria-activedescendant', '');
                    return;
                }
                if (e.key === 'Enter') {
                    const $selectedItem = $items.filter('.selected');
                     if ($selectedItem.length) {
                         // Check if it's the manual entry item
                         if ($selectedItem.hasClass('manual-entry')) {
                             $('.manual-entry').trigger('mousedown'); // Simulate click
                         } else {
                              $selectedItem.trigger('mousedown'); // Simulate click
                         }
                     } // else: do nothing if no item selected? Or select first?
                     $box.hide(); // Hide on enter
                    $input.attr('aria-expanded', 'false').attr('aria-activedescendant', '');
                    return;
                }
                // Arrow navigation
                 let currentIdx = $items.index($items.filter('.selected'));
                 let newIdx = currentIdx;
                 if (e.key === 'ArrowDown') newIdx = (currentIdx + 1) % $items.length;
                 else if (e.key === 'ArrowUp') newIdx = (currentIdx - 1 + $items.length) % $items.length;

                 if (newIdx !== currentIdx) {
                     $items.removeClass('selected').attr('aria-selected', 'false'); // Update ARIA on all
                     const $newItem = $($items[newIdx]);
                     $newItem.addClass('selected').attr('aria-selected', 'true'); // Update ARIA on new
                     const newItemId = $newItem.attr('id'); // Get ID of new item
                     if (newItemId) {
                         $input.attr('aria-activedescendant', newItemId); // Update active descendant
                     }
                     // Scroll into view
                     const boxNode = $box[0]; const itemNode = $newItem[0];
                     if (itemNode.offsetTop < boxNode.scrollTop || itemNode.offsetTop + itemNode.offsetHeight > boxNode.scrollTop + boxNode.clientHeight) {
                         itemNode.scrollIntoView({ block: 'nearest', inline: 'nearest' });
                     }
                     idx = newIdx;
                 }
            }
        });
        // --- Focus/Blur handlers with ARIA ---
        $input.on('focus', () => {
            $('.medication-drug-input').data('has-focus', false);
            $input.data('has-focus', true);
            const value = $input.val().trim();
            if (value.length >= 3) {
                 // Don't re-show immediately on focus if it was just hidden by blur, let input handler do it
                 // findMatching(value);
            }
        });
        $input.on('blur', () => {
            setTimeout(() => {
                const activeElement = document.activeElement;
                if (activeElement !== $input[0] && !$box[0].contains(activeElement)) {
                    $box.hide();
                     $input.attr('aria-expanded', 'false'); // Update ARIA
                      // Don't clear active descendant here, might be needed if focus moves to related element
                }
                 if (activeElement !== $input[0]) { $input.data('has-focus', false); }
            }, 250);
        });
         // --- 'More Brands' click handler (remains same, largely visual) ---
         $(document).off('mousedown.morebrands').on('mousedown.morebrands', '.more-brands-link', function(e) { /* ... */ });
         // --- Manual Entry click handler (modified slightly) ---
          $(document).off('mousedown.manualentry').on('mousedown.manualentry', '.manual-entry', function(e) {
             e.preventDefault();
             e.stopPropagation();
              // Find the input that likely triggered this
              // It *should* be the one with focus or the one associated with the box clicked
             const $targetInput = $input; // Assume $input context is correct here
              const custom = prompt("Enter full medication name (e.g., Metformin 500mg Tablet):");
             if (custom && custom.trim()) {
                 $targetInput.val(custom.trim()).trigger('change');
                 $targetInput.data({ selectedMedData: null, hasFocus: false });
                 // Reset form/unit selectors
                 const $row = $targetInput.closest('.medication-entry-row');
                 $row.find('.medication-dosage-form').prop('selectedIndex', 0);
                 populateUnitOptions($row.find('.medication-dosage-form'));
                 $row.find('.sig-quantity').val('').focus(); // Focus quantity
             }
             $box.hide();
             $targetInput.attr('aria-expanded', 'false').attr('aria-activedescendant', '');
          });
           // --- FindMatching Function (Optimized slightly) ---
            function findMatching(query) {
                const terms = query.toLowerCase().split(/\s+/).filter(Boolean);
                if (terms.length === 0) {
                    displaySuggestions([]);
                    return;
                }
                console.time("Filtering Time");
                 // Pre-filter restricted items first for efficiency
                 const eligibleDrugs = compiledDrugData.filter(item => item.is_restricted !== true);

                const results = eligibleDrugs.filter(item => {
                    // Cache search string on first use per item
                     if (!item._search_string) {
                        const ingredientsText = (item.active_ingredients || []).map(ing => ing.name).join(' ').toLowerCase();
                        const formsText = (item.forms || []).join(' ').toLowerCase();
                          // Include brand name, ingredients, and forms in search string
                        item._search_string = `${item.brand_name || ''} ${ingredientsText} ${formsText}`.toLowerCase();
                     }
                    return terms.every(term => item._search_string.includes(term));
                });
                console.timeEnd("Filtering Time");
                // Limit results *after* filtering
                const limitedResults = results.slice(0, 50); // Process top 50 for display mapping
                displaySuggestions(limitedResults);
            }

    } // End of attachMedAutocomplete

    // ---------------------------------------------------------
    // Keyboard Nav within Form Row (Unchanged)
    // ---------------------------------------------------------
    function setupKeyboardNavigation() { /* ... keep existing logic ... */
         $('#medicationEntryArea').on('keydown', '.medication-drug-input, .medication-dosage-form, .sig-quantity, .sig-unit, .sig-frequency, .sig-additional, .add-current-med-button', function(e) {
              if (!['ArrowRight', 'ArrowLeft', 'Enter'].includes(e.key)) return;
              if ($(this).hasClass('medication-drug-input') && $('#medicationSuggestionBox').is(':visible')) {
                  if (e.key === 'Enter') return; // Let suggestion handler take Enter
                  if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                      e.preventDefault(); return; // Prevent nav when suggestions open
                  }
              }
             const $row = $(this).closest('.medication-entry-row');
             const fields = [ /* Define fields including button */
                 $row.find('.medication-drug-input'), $row.find('.medication-dosage-form'),
                 $row.find('.sig-quantity'), $row.find('.sig-unit'),
                 $row.find('.sig-frequency'), $row.find('.sig-additional'),
                 $row.find('.add-current-med-button')
             ];
             const currentIndex = fields.findIndex($el => $el.is(this));
             let targetIndex = -1;

             if (e.key === 'ArrowRight') { /* Find next enabled */
                  if (currentIndex < fields.length - 1) {
                     e.preventDefault();
                     for (let i = currentIndex + 1; i < fields.length; i++) {
                         if (fields[i].length && fields[i].is(':visible') && !fields[i].prop('disabled')) {
                             targetIndex = i; break;
                         }
                     }
                  }
             } else if (e.key === 'ArrowLeft') { /* Find previous enabled */
                  if (currentIndex > 0) {
                     e.preventDefault();
                     for (let i = currentIndex - 1; i >= 0; i--) {
                         if (fields[i].length && fields[i].is(':visible') && !fields[i].prop('disabled')) {
                             targetIndex = i; break;
                         }
                     }
                  }
             } else if (e.key === 'Enter') {
                  if ($(this).is('.add-current-med-button')) return; // Allow button click
                   if ($(this).is('.sig-frequency, .sig-additional')) { // Trigger add from last fields
                        e.preventDefault();
                        $row.find('.add-current-med-button').trigger('click');
                        return;
                   }
                   // Optional: Move to next field on Enter for text/number inputs
                   if ($(this).is('input[type="text"], input[type="number"]') && currentIndex < fields.length -1) {
                          e.preventDefault();
                          for (let i = currentIndex + 1; i < fields.length; i++) { // Find next focusable like ArrowRight
                              if (fields[i].length && fields[i].is(':visible') && !fields[i].prop('disabled')) {
                                   targetIndex = i; break;
                              }
                          }
                   }
             }
             if (targetIndex !== -1 && targetIndex < fields.length) {
                  fields[targetIndex].focus().select();
             }
         });
    }

    // ---------------------------------------------------------
    // Document Ready - Main Initialization
    // ---------------------------------------------------------
    $(document).ready(() => {
        // Don't show loading message here, loadCompiledDrugData handles it
        setupKeyboardNavigation();

        $('#dob').on('change', function() {
            const dob = new Date(this.value);
            const today = new Date();
            if (!isNaN(dob) && dob < today) {
                let age = today.getFullYear() - dob.getFullYear();
                const m = today.getMonth() - dob.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) age--;
                $('#age').val(age >= 0 ? age : '');
            } else { $('#age').val(''); }
            loadHistoryList(); // Reload history
        });
        $('#dob').trigger('change'); // Initial age calc

        // Load medication data
        loadCompiledDrugData()
            .then(data => {
                compiledDrugData = data; // Already validated to be array by loader
                // Attach autocomplete only if data loaded successfully (input will be enabled by loader)
                if (compiledDrugData.length > 0) {
                    attachMedAutocomplete($('#medicationDrugField_0'));
                } else {
                    // Loader already showed error message and disabled input
                    console.error("Autocomplete not attached: Compiled drug data is empty or failed to load.");
                }
            })
            .catch(error => {
                // Catch unexpected errors during the promise chain (less likely now)
                console.error("Unexpected error during data loading sequence:", error);
                $('#errorMessage').text('An critical error occurred setting up the page. Please refresh.').show();
                 $('.medication-drug-input').prop('disabled', true).attr('placeholder', 'Setup Error');
            });

        // Populate units when form is manually changed
        $('#medicationEntryArea').on('change', '.medication-dosage-form', function() {
            populateUnitOptions($(this));
             // Reset unit selection and try setting default for the manually chosen form
             const $row = $(this).closest('.medication-entry-row');
             $row.find('.sig-unit').prop('selectedIndex', 0); // Reset selection first
             setDefaultUnit($row, $(this).val()?.toLowerCase()); // Set default based on new form
        });

        // Add medication button click
        $('#medicationEntryArea').on('click', '.add-current-med-button', function() {
            const $row = $(this).closest('.medication-entry-row');
            const medData = {
                drug: $row.find('.medication-drug-input').val(),
                dosageForm: $row.find('.medication-dosage-form').val(),
                sig_structured: {
                    quantity: $row.find('.sig-quantity').val(),
                    unit:     $row.find('.sig-unit').val(),
                    frequency: $row.find('.sig-frequency').val(),
                    additional: $row.find('.sig-additional').val()
                }
                // Actual ingredient/form data added in addMedicationToList based on selectedData
            };
            addMedicationToList(medData, $row); // Function handles validation, SIG string, etc.
        });

        // Form submission
        $('#patientForm').on('submit', e => {
            e.preventDefault();
             // Validation
            if (!$('#firstName').val().trim() || !$('#lastName').val().trim() || !$('#dob').val()) {
                alert("Please fill in First Name, Last Name, and Date of Birth.");
                $('#firstName, #lastName, #dob').filter((_, el) => !$.trim(el.value)).first().focus();
                return;
            }
            if (currentMedications.length === 0) {
                alert("Please add at least one medication to the request.");
                $('#medicationDrugField_0').focus();
                return;
            }
             // Check for unsaved data in entry row
             const $row = $('#medicationRow_0');
             const drugInput = $.trim($row.find('.medication-drug-input').val());
             const quantityInput = $.trim($row.find('.sig-quantity').val());
             const unitSelected = $row.find('.sig-unit').val();
             const freqSelected = $row.find('.sig-frequency').val();
             const additionalInput = $.trim($row.find('.sig-additional').val());
             if (drugInput || quantityInput || unitSelected || freqSelected || additionalInput) {
                  if(!confirm("The current medication entry fields have data that hasn't been added. Submit without adding it?")) {
                      $row.find('.add-current-med-button').focus();
                      return;
                  }
             }
            // Build payload
            const payload = { /* ... (payload structure unchanged) ... */
                firstName: $('#firstName').val().trim(),
                lastName: $('#lastName').val().trim(),
                dob: $('#dob').val(),
                age: $('#age').val(),
                medications: currentMedications,
                requestTimestamp: new Date().toISOString()
            };
            // --- SIMULATE SUBMISSION ---
            console.log("Submitting Payload:", JSON.stringify(payload, null, 2));
            savePreviousRequest();
            $('#successMessage').text(`Request for ${payload.firstName} ${payload.lastName} submitted.`).fadeIn().delay(4000).fadeOut();
            // --- END SIMULATION ---
            currentMedications = [];
            renderMedicationList();
            clearMedicationEntryForm($('#medicationRow_0'));
            loadHistoryList(); // Refresh history
            $('#firstName').focus();
        });

        // Load history when patient identifiers change
        $('#firstName, #lastName').on('change', loadHistoryList); // DOB change also calls it

        // Initial setup
        renderMedicationList();
        loadHistoryList(); // Load history initially (if name/DOB pre-filled)
        $('#firstName').focus();
    });
    })(jQuery);
</script>
</body>
</html>
