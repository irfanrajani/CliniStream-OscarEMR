<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Patient Refill Request</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Added Pako.js for gzip decompression -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <style>
        /* --- Core Styles --- */
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        h1, h2, h3 { color: #333; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 800px; margin: auto; }
        /* --- Patient Form --- */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input[type="text"], input[type="date"], input[type="number"], select, button {
            padding: 10px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; width: 100%;
        }
        input[readonly] { background-color: #e9ecef; }
        button { cursor: pointer; background-color: #007bff; color: white; border: none; margin-top: 10px; }
        button:hover { background-color: #0056b3; }
        /* --- History Buttons --- */
        #historyContainer { margin-bottom: 20px; }
        .history-section { border-top: 1px solid #eee; padding-top: 10px; margin-top: 15px; }
        .history-title { font-size: 16px; margin-bottom: 8px; color: #555; }
        .history-btn {
            margin: 4px 4px 4px 0; padding: 8px 12px; font-size: 0.9em;
            background-color: #e6f7ff; border: 1px solid #b3e0ff; color: #0056b3;
            border-radius: 4px; cursor: pointer; display: inline-block;
        }
        .history-btn:hover { background-color: #d0edff; }
        /* --- Medication Entry --- */
        .medication-entry-row { border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; background-color: #f9f9f9; border-radius: 5px; }
        .medication-fields-grid { display: grid; grid-template-columns: 3fr 2fr; gap: 20px; margin-bottom: 15px; }
        .sig-structured-area { border-top: 1px dashed #ccc; margin-top: 15px; padding-top: 15px; }
        .sig-structured-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; align-items: end; margin-bottom: 10px; }
        .sig-additional-info { margin-top: 10px; }
        .form-hint { color: #6c757d; font-size: 0.85em; margin-top: 3px; font-style: italic; }
        /* --- Suggestion Box --- */
        .suggestion-box { position: absolute; background: #fff; border: 1px solid #aaa; z-index: 9999; max-height: 300px; overflow-y: auto; min-width: 300px; max-width: 500px; display: none; border-radius: 4px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); font-size: 14px; }
        .suggestion-item { padding: 6px 12px; cursor: pointer; border-bottom: 1px solid #eee; position: relative; /* Needed for absolute child */ }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover, .suggestion-item.selected { background-color: #e9ecef; }
        .suggestion-med-name { font-weight: 500; display: block; /* Ensure block for badge positioning */ margin-bottom: 2px;}
        .suggestion-brands { font-size: 0.9em; color: #555; font-style: italic; display: block; }
        .more-brands-link { text-decoration: underline; color: #0056b3; cursor: pointer; margin-left: 5px; }
        .manual-entry { background-color: #f8f9fa; border-top: 1px solid #ddd; padding: 8px 12px; }
        .manual-entry strong { color: #007bff; }
        .suggestion-box .no-results { padding: 8px 12px; color:#666; font-style: italic; cursor: default; }
        /* Styling for additional brand items */
         .additional-brands-container .additional-brand-item {
            padding-left: 25px !important; /* Indent more */
            background-color: #f8f9fa !important; /* Different background */
            border-top: 1px dashed #eee; /* Separator */
         }
         .additional-brands-container .additional-brand-item .suggestion-med-name { font-weight: 400; } /* Less emphasis */
         .additional-brands-container .additional-brand-item .suggestion-brands { color: #333; }
          .additional-brands-container { /* Container itself */
              border-left: 3px solid #007bff; /* Indicate relation */
              margin-left: 5px;
           }
        /* --- Medication List --- */
        #medicationsListContainer { margin-top: 20px; border-top: 2px solid #007bff; padding-top: 15px; }
        .added-medication-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 15px; margin-bottom: 12px; border-radius: 4px;
            font-size: 14px; border: 1px solid; position: relative;
        }
        .added-medication-item.single-med { background-color: #e6f7ff; border-color: #b3e0ff; }
        .added-medication-item.combination-med { background-color: #fff3cd; border-color: #ffeeba; }
        .added-medication-item .med-info { flex-grow: 1; padding-right: 15px; word-break: break-word; }
        .added-medication-item .med-controls { display: flex; gap: 5px; flex-shrink: 0; }
        .added-medication-item .remove-btn {
            padding: 4px 8px; font-size: 12px; background-color: #dc3545;
            width: auto; margin-top: 0; flex-shrink: 0;
        }
        .added-medication-item .remove-btn:hover { background-color: #c82333; }
        .badge {
            display: inline-block; padding: 3px 7px; font-size: 0.75em;
            border-radius: 3px; margin-right: 8px; font-weight: bold; vertical-align: middle;
        }
        .badge.combo { background: #ffc107; color: #212529; }
        .badge.dosage { background: #17a2b8; color: #fff; }
        /* --- Messages --- */
        #loadingMessage, #errorMessage, #successMessage { padding: 15px; border-radius: 4px; margin-bottom: 20px; text-align: center; display: none; }
        #loadingMessage { background-color: #ffc107; border: 1px solid #dda700; } /* Use this for loading indication */
        #errorMessage   { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        #successMessage { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        /* --- Validation --- */
        .validation-alert {
            background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404;
            padding: 10px; border-radius: 4px; margin: 10px 0; display: none;
        }
        /* --- Badges in Suggestion Box --- */
        .combination-medication {
          /* Highlight is now in added list, maybe subtle border here? */
          /* border-left: 3px solid #ffc107; */
        }
        .restricted-badge {
          display: inline-block;
          background-color: #dc3545;
          color: white;
          font-size: 0.7em;
          padding: 1px 4px;
          border-radius: 3px;
          margin-left: 5px;
          font-weight: bold;
          vertical-align: text-top; /* Align better with text */
        }
        .combo-badge {
          display: inline-block;
          background-color: #17a2b8; /* distinct color from list badge */
          color: white;
          font-size: 0.7em;
          padding: 1px 4px;
          border-radius: 3px;
          margin-left: 5px;
          font-weight: bold;
           vertical-align: text-top; /* Align better with text */
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Refill Request</h1>
    <!-- Loading / Error / Success Messages -->
    <div id="loadingMessage">Loading medication data…</div>
    <div id="errorMessage">Error loading data. Please try again later.</div>
    <div id="successMessage">Your refill request has been submitted successfully!</div>

    <!-- Patient Info -->
    <h2>Patient Information</h2>
    <form id="patientForm">
        <div class="form-group">
            <label for="firstName">First Name:</label>
            <input type="text" id="firstName" name="firstName" required>
        </div>
        <div class="form-group">
            <label for="lastName">Last Name:</label>
            <input type="text" id="lastName" name="lastName" required>
        </div>
        <div class="form-group">
            <label for="dob">Date of Birth:</label>
            <input type="date" id="dob" name="dob" required>
        </div>
        <div class="form-group">
            <label for="age">Age:</label>
            <input type="number" id="age" name="age" readonly>
        </div>
        <!-- History of last meds -->
        <div id="historyContainer"></div>

        <h2>Medication Entry</h2>
        <div id="medicationEntryArea">
            <div class="medication-entry-row" id="medicationRow_0">
                <div class="medication-fields-grid">
                    <div style="position: relative;">
                        <label for="medicationDrugField_0">Medication:</label>
                        <input type="text" id="medicationDrugField_0" class="medication-drug-input" autocomplete="off"
                               placeholder="Loading drug data..." disabled>
                        <div class="form-hint">Begin typing 3+ characters to see suggestions</div> <!-- Updated hint -->
                        <div class="suggestion-anchor" style="position: relative; height: 0;"></div>
                    </div>
                    <div>
                        <label for="medicationDosageForm_0">Form:</label>
                        <select id="medicationDosageForm_0" class="medication-dosage-form">
                            <option value="" disabled selected>-- Select Form --</option>
                            <!-- Dynamic options can be added later if needed -->
                            <option value="tablet">Tablet</option>
                            <option value="capsule">Capsule</option>
                            <option value="liquid">Liquid/Syrup</option>
                            <option value="suspension">Suspension</option>
                            <option value="injection">Injection</option>
                            <option value="inhaler">Inhaler</option>
                            <option value="topical">Topical</option>
                            <option value="cream">Cream</option>
                            <option value="ointment">Ointment</option>
                            <option value="lotion">Lotion</option>
                            <option value="gel">Gel</option>
                            <option value="patch">Patch</option>
                            <option value="suppository">Suppository</option>
                            <option value="eye drop">Eye Drop</option>
                            <option value="ear drop">Ear Drop</option>
                            <option value="nasal spray">Nasal Spray</option>
                             <option value="solution">Solution</option>
                             <option value="powder">Powder</option>
                             <option value="lozenge">Lozenge</option>
                        </select>
                    </div>
                </div>
                <div class="sig-structured-area">
                    <label>Directions / SIG:</label>
                    <div class="validation-alert" id="validationAlert_0"></div>
                    <div class="sig-structured-grid">
                        <div>
                            <label for="sigQuantity_0">Quantity</label>
                            <input type="number" id="sigQuantity_0" class="sig-quantity" min="0" step="0.01" <!-- Allow decimals -->
                                   placeholder="e.g., 1">
                        </div>
                        <div>
                            <label for="sigUnit_0">Unit</label>
                            <select id="sigUnit_0" class="sig-unit" disabled>
                                <option>-- Select Form First --</option>
                            </select>
                        </div>
                        <div>
                            <label for="sigFrequency_0">Frequency</label>
                            <select id="sigFrequency_0" class="sig-frequency">
                                <option value="" disabled selected>-- Select --</option>
                                <option value="once daily">Once daily (QD)</option>
                                <option value="twice daily">Twice daily (BID)</option>
                                <option value="three times daily">Three times daily (TID)</option>
                                <option value="four times daily">Four times daily (QID)</option>
                                <option value="every morning">Every morning (QAM)</option>
                                <option value="every evening">Every evening (QPM)</option>
                                <option value="at bedtime">At bedtime (QHS)</option>
                                <option value="every 4 hours">Every 4 hours</option>
                                <option value="every 6 hours">Every 6 hours</option>
                                <option value="every 8 hours">Every 8 hours</option>
                                <option value="every 12 hours">Every 12 hours</option>
                                <option value="every other day">Every other day</option>
                                <option value="once weekly">Once weekly</option>
                                <option value="twice weekly">Twice weekly</option>
                                <option value="as needed">As needed (PRN)</option>
                                <option value="other">Other (Specify Below)</option>
                            </select>
                        </div>
                    </div>
                    <div class="sig-additional-info">
                        <label for="sigAdditional_0">Additional Info</label>
                        <input type="text" id="sigAdditional_0" class="sig-additional"
                            placeholder="e.g., for pain, with food, etc.">
                    </div>
                </div>
                <button type="button" class="add-current-med-button">Add Medication</button>
            </div>
        </div>

        <h2>Your Medications</h2>
        <div id="medicationsListContainer">
            <p>No medications added.</p>
        </div>
        <hr>
        <button type="submit">Submit Request</button>
    </form>

    <!-- Autocomplete Suggestions -->
    <div class="suggestion-box" id="medicationSuggestionBox"></div>

</div>

<script>
    // IIFE to encapsulate code
    (function($) {
    // ---------------------------------------------------------
    // CONFIG
    // ---------------------------------------------------------
    // **** UPDATED URL to point to the compressed file ****
    const COMPILED_DATA_URL = 'https://raw.githubusercontent.com/irfanrajani/CliniStream-OscarEMR/main/compiled_drug_data.json.gz';
    // Globals
    let compiledDrugData = [];
    let currentMedications = [];
    const MAX_SUGGESTIONS = 10;
    const MAX_BRANDS_DISPLAY = 3;
    const MAX_HISTORY_ITEMS = 15;
    const dosageFormUnits = {
        // Define units for lowercase form names
        tablet: ['tablet(s)'], capsule: ['capsule(s)'], lozenge: ['lozenge(s)'],
        powder: ['packet(s)', 'scoop(s)', 'gram(s)', 'mg'],
        liquid: ['mL','tsp (5mL)','tbsp (15mL)'], solution: ['mL','tsp (5mL)','tbsp (15mL)'],
        suspension: ['mL','tsp (5mL)','tbsp (15mL)'], syrup: ['mL','tsp (5mL)','tbsp (15mL)'],
        injection: ['mL','unit(s)'], inhaler: ['puff(s)','inhalation(s)'],
        'nasal spray': ['spray(s) in nostril(s)','spray(s) in left nostril','spray(s) in right nostril'],
        topical: ['application(s)','gram(s)','mL'], cream: ['application(s)','gram(s)'],
        ointment: ['application(s)','gram(s)'], lotion: ['application(s)','mL'],
        gel: ['application(s)','gram(s)'], patch: ['patch(es)'],
        suppository: ['suppository(ies)'], 'eye drop': ['drop(s)','drop(s) in eye(s)','drop(s) in left eye','drop(s) in right eye'],
        'ear drop': ['drop(s)','drop(s) in ear(s)','drop(s) in left ear','drop(s) in right ear']
    };

    // ---------------------------------------------------------
    // **** NEW: Function to load and decompress data ****
    // ---------------------------------------------------------
    async function loadCompiledDrugData() {
        console.log("Attempting to load compiled drug data...");
        $('#loadingMessage').text('Loading medication data... Please wait.').show(); // Use existing message div
        $('#errorMessage').hide(); // Hide previous errors

        try {
            const response = await fetch(COMPILED_DATA_URL);
            console.log("Fetch response status:", response.status);

            if (!response.ok) {
                throw new Error(`Failed to fetch drug data: ${response.status} ${response.statusText}`);
            }

            // Check content type (optional, but good practice if possible)
            // console.log("Response Content-Type:", response.headers.get('Content-Type'));

            // Fetch as ArrayBuffer for Pako
            const compressedData = await response.arrayBuffer();
            console.log(`Fetched ${compressedData.byteLength} bytes (compressed).`);

            if (compressedData.byteLength === 0) {
                 throw new Error("Downloaded data file is empty.");
            }

            // Decompress using pako.js
            console.log("Decompressing data...");
            const decompressed = pako.inflate(compressedData, { to: 'string' });
            console.log(`Decompressed data length: ${decompressed.length} characters.`);

            // Parse the JSON
            console.log("Parsing JSON...");
            const data = JSON.parse(decompressed);
            console.log("JSON parsed successfully.");

            // Hide loading message ONLY on successful parse
            $('#loadingMessage').hide();
            return data;

        } catch (error) {
            console.error('Error loading or processing compiled drug data:', error);
            // **** UPDATED Error Message ****
            $('#errorMessage').text(`Unable to load medication data. Please check your internet connection or refresh the page. Error: ${error.message}`).show();
            $('#loadingMessage').hide(); // Hide loading message on error too
            return []; // Return empty array on failure
        }
    }


    // ---------------------------------------------------------
    // Utility: History per patient (Unchanged)
    // ---------------------------------------------------------
    function historyKeyBase() { /* ... unchanged ... */ }
    function historyKey() { /* ... unchanged ... */ }
    function historyKeyPrevRequests() { /* ... unchanged ... */ }
    function saveToHistory(med) { /* ... unchanged ... */ }
    function savePreviousRequest() { /* ... unchanged ... */ }
    function loadHistoryList() { /* ... unchanged ... */ }
     // [Paste the full unchanged code for these 5 history functions here]
      function historyKeyBase() {
        const first = $('#firstName').val().trim().toLowerCase();
        const last = $('#lastName').val().trim().toLowerCase();
        const dob = $('#dob').val();
        if (!first || !dob) return null;
        return `${first}_${last}_${dob}`;
    }
    function historyKey() {
        const base = historyKeyBase();
        return base ? `medHistory:${base}` : null;
    }
    function historyKeyPrevRequests() {
         const base = historyKeyBase();
        return base ? `prevRequests:${base}` : null;
    }
    function saveToHistory(med) {
        const key = historyKey();
        if (!key) return;
        try {
            let hist = JSON.parse(localStorage.getItem(key) || '[]');
            // More robust check for existing item (case-insensitive drug name?)
            const medLower = med.drug.toLowerCase();
            // Prioritize exact match + sig if possible? For now, just name match
            hist = [med, ...hist.filter(m => m.drug.toLowerCase() !== medLower)].slice(0, MAX_HISTORY_ITEMS);
            localStorage.setItem(key, JSON.stringify(hist));
        } catch (e) {
            console.error("Error saving to history:", e);
        }
    }
    function savePreviousRequest() {
        const key = historyKeyPrevRequests();
        if (!key || !currentMedications.length) return;
        const request = {
            timestamp: new Date().toISOString(),
            medications: JSON.parse(JSON.stringify(currentMedications)) // Deep copy
        };
        try {
            let prevRequests = JSON.parse(localStorage.getItem(key) || '[]');
            prevRequests.unshift(request);
            if (prevRequests.length > 5) prevRequests = prevRequests.slice(0, 5);
            localStorage.setItem(key, JSON.stringify(prevRequests));
        } catch (e) {
            console.error("Error saving previous request:", e);
        }
    }
     function loadHistoryList() {
        const $cont = $('#historyContainer').empty();
        if (!$('#firstName').val() || !$('#dob').val()) return; // Need patient info

        // 1. Load individual medications history
        const medKey = historyKey();
        if (medKey) {
            try {
                const hist = JSON.parse(localStorage.getItem(medKey) || '[]');
                if (hist.length) {
                    $cont.append('<div class="history-section"><div class="history-title">Recently Used Medications</div><div id="recentMedsHistory"></div></div>');
                    const $recentMeds = $('#recentMedsHistory');
                    hist.forEach(med => {
                        const $btn = $('<button type="button" class="history-btn">')
                            .text(med.drug) // Display the saved drug name
                            .attr('title', med.sig_string || 'Click to fill')
                            .on('click', () => {
                                const $row = $('#medicationRow_0');
                                $row.find('.medication-drug-input').val(med.drug).data('selectedMedData', null); // Clear any previous full data object
                                $row.find('.sig-quantity').val( med.sig_structured?.quantity || '');
                                $row.find('.sig-frequency').val( med.sig_structured?.frequency || '');
                                $row.find('.sig-additional').val( med.sig_structured?.additional || '');

                                // Set form and populate units based on saved data
                                const $form = $row.find('.medication-dosage-form');
                                if (med.dosageForm) {
                                    const formValLower = med.dosageForm.toLowerCase();
                                    const match = $form.find('option').filter(function() {
                                        return this.value.toLowerCase() === formValLower;
                                    });
                                     if(match.length) {
                                      $form.val(match.val());
                                     } else {
                                        // Maybe add the option if it doesn't exist? Or just select blank?
                                        $form.prop('selectedIndex', 0);
                                     }
                                } else {
                                     $form.prop('selectedIndex', 0);
                                }
                                populateUnitOptions($form); // Populate units based on the selected form

                                if (med.sig_structured?.unit) { // Now try to set the unit
                                    // Ensure the unit option exists before setting
                                    if ($row.find('.sig-unit option[value="' + med.sig_structured.unit + '"]').length > 0) {
                                      $row.find('.sig-unit').val(med.sig_structured.unit);
                                    } else {
                                      $row.find('.sig-unit').prop('selectedIndex', 0); // Fallback to placeholder
                                    }
                                } else {
                                   $row.find('.sig-unit').prop('selectedIndex', 0); // Fallback to placeholder
                                }

                                $row.find('.sig-quantity').focus(); // Focus quantity field
                            });
                        $recentMeds.append($btn);
                    });
                }
            } catch(e){ console.error("Error loading medication history:", e); }
        }

        // 2. Load previous complete requests
        const reqKey = historyKeyPrevRequests();
        if (reqKey) {
           try {
               const prevRequests = JSON.parse(localStorage.getItem(reqKey) || '[]');
               if (prevRequests.length) {
                    $cont.append('<div class="history-section"><div class="history-title">Previous Refill Requests</div><div id="previousRequestsList"></div></div>');
                    const $prevList = $('#previousRequestsList');
                    prevRequests.forEach((req, i) => {
                        const date = new Date(req.timestamp);
                        const dateStr = date.toLocaleDateString();
                        const numMeds = req.medications.length;
                        const $btn = $('<button type="button" class="history-btn">')
                            .html(`${dateStr} (${numMeds} med${numMeds !== 1 ? 's' : ''})`)
                            .on('click', () => {
                                if (confirm(`Replace your current list with the ${numMeds} medication(s) from your ${dateStr} request?`)) {
                                    currentMedications = JSON.parse(JSON.stringify(req.medications)); // Deep copy
                                    renderMedicationList();
                                    // Clear entry form?
                                    clearMedicationEntryForm($('#medicationRow_0'));
                                }
                            });
                        $prevList.append($btn);
                    });
                }
            } catch(e){ console.error("Error loading previous requests:", e); }
        }
    }

    // ---------------------------------------------------------
    // Populate units based on form & Select specific defaults (Unchanged)
    // ---------------------------------------------------------
    function populateUnitOptions($formSelect) { /* ... unchanged ... */ }
      function populateUnitOptions($formSelect) {
        const selectedFormValue = ($formSelect.val() || "").toLowerCase(); // Get value and lowercase
        const $row = $formSelect.closest('.medication-entry-row');
        const $unitSelect = $row.find('.sig-unit');
        const currentUnitVal = $unitSelect.val(); // Preserve current value if possible
        $unitSelect.empty().prop('disabled', true); // Clear and disable initially
        const units = dosageFormUnits[selectedFormValue]; // Lookup units using lowercase form value
        if (units && units.length > 0) {
            $unitSelect.append('<option value="" disabled selected>-- Select Unit --</option>'); // Add placeholder first
            units.forEach(u => $unitSelect.append($('<option>').val(u).text(u)));
            $unitSelect.prop('disabled', false);
             // Try to reselect previous value if it's still valid for the new form
             if (currentUnitVal && units.includes(currentUnitVal)) {
                 $unitSelect.val(currentUnitVal);
             } else  {
                // Auto-select FIRST unit as a fallback if no specific logic overrides it later
                // $unitSelect.val(units[0]); // REMOVED - Selection happens in mousedown handler
             }
        } else {
            $unitSelect.append('<option>-- Select Form First --</option>');
        }
    }
    // ---------------------------------------------------------
    // Auto-select form/unit based on selected medication data (Unchanged)
    // ---------------------------------------------------------
    function autoSelectFormAndUnits(medData, $inputField) { /* ... unchanged ... */ }
     function autoSelectFormAndUnits(medData, $inputField) {
        if (!medData || !$inputField || !$inputField.length) return;
        const $row = $inputField.closest('.medication-entry-row');
        const $form = $row.find('.medication-dosage-form');
        const $unit = $row.find('.sig-unit');
        const $quantity = $row.find('.sig-quantity');
        // Use the primary form list potentially added in Python, fallback to parsing
        const primaryForms = medData.forms || [];
        let formToMatch = null;
        if(primaryForms.length > 0) {
            formToMatch = primaryForms[0]; // Use the first form from the list
        } else {
            // Fallback to trying to parse from descriptor or name if needed (less reliable)
            // Example: const nameFormMatch = medData.brand_name.match(/\((.*?)\)/); formToMatch = nameFormMatch ? nameFormMatch[1] : null;
        }
         const normalizedForm = (formToMatch || '').toLowerCase();
        // Clear quantity and keep unit disabled initially
        //$quantity.val(''); // Keep quantity potentially
        $unit.empty().append('<option>-- Select Form First --</option>').prop('disabled', true);
        $form.prop('selectedIndex', 0); // Reset form selection
        if (normalizedForm) {
            let bestMatch = null;
             let exactMatch = false;
            // Try exact match first (case-insensitive)
            $form.find('option').each(function() {
                if (this.value.toLowerCase() === normalizedForm) {
                    bestMatch = $(this);
                     exactMatch = true;
                    return false; // break loop
                }
            });
            // If no exact match, try partial match (e.g., "liquid/syrup" contains "liquid")
            if (!bestMatch) {
                 $form.find('option').each(function() {
                    const optValLower = this.value.toLowerCase();
                     // More robust partial matching: check both directions
                    if (optValLower && (normalizedForm.includes(optValLower) || optValLower.includes(normalizedForm))) {
                        bestMatch = $(this);
                        return false; // break loop
                    }
                });
            }
            if (bestMatch && bestMatch.length) {
                $form.val(bestMatch.val()); // Set the form dropdown
                populateUnitOptions($form); // Populate units based on the matched form
                 // Set default quantity to 1 (can be overridden by specific logic)
                 if (!$quantity.val()) { // Only set if quantity is empty
                      $quantity.val('1');
                 }
                // --- Select specific unit based on form ---
                const matchedFormValLower = bestMatch.val().toLowerCase();
                const availableUnits = dosageFormUnits[matchedFormValLower] || [];
                if (availableUnits.length > 0) {
                    let unitToSelect = null;
                    // Prioritized selection logic
                    if (matchedFormValLower.includes('liquid') || matchedFormValLower.includes('solution') || matchedFormValLower.includes('suspension') || matchedFormValLower.includes('syrup')) {
                        if (availableUnits.includes('mL')) unitToSelect = 'mL';
                        else if (availableUnits.includes('tsp (5mL)')) unitToSelect = 'tsp (5mL)';
                    } else if (matchedFormValLower.includes('cream') || matchedFormValLower.includes('ointment') || matchedFormValLower.includes('gel') || matchedFormValLower.includes('topical')) {
                        if (availableUnits.includes('application(s)')) unitToSelect = 'application(s)';
                        else if (availableUnits.includes('gram(s)')) unitToSelect = 'gram(s)';
                    } else if (matchedFormValLower.includes('lotion')) {
                         if (availableUnits.includes('application(s)')) unitToSelect = 'application(s)';
                         else if (availableUnits.includes('mL')) unitToSelect = 'mL';
                    } else if (matchedFormValLower.includes('drop')) {
                        if ($unit.find('option[value*="eye(s)"]').length) unitToSelect = $unit.find('option[value*="eye(s)"]').first().val();
                        else if ($unit.find('option[value*="ear(s)"]').length) unitToSelect = $unit.find('option[value*="ear(s)"]').first().val();
                        else if (availableUnits.includes('drop(s)')) unitToSelect = 'drop(s)';
                    } else if (matchedFormValLower.includes('inhaler') || matchedFormValLower.includes('spray')) {
                         if ($unit.find('option[value*="puff(s)"]').length) unitToSelect = $unit.find('option[value*="puff(s)"]').first().val();
                         else if ($unit.find('option[value*="inhalation(s)"]').length) unitToSelect = $unit.find('option[value*="inhalation(s)"]').first().val();
                         else if ($unit.find('option[value*="spray(s)"]').length) unitToSelect = $unit.find('option[value*="spray(s)"]').first().val();
                         else if (matchedFormValLower.includes('spray') && availableUnits.includes('spray(s)')) unitToSelect = 'spray(s)'; // Generic spray
                    } else if (matchedFormValLower.includes('tablet')) {
                         if (availableUnits.includes('tablet(s)')) unitToSelect = 'tablet(s)';
                    } else if (matchedFormValLower.includes('capsule')) {
                         if (availableUnits.includes('capsule(s)')) unitToSelect = 'capsule(s)';
                    } else if (matchedFormValLower.includes('patch')) {
                         if (availableUnits.includes('patch(es)')) unitToSelect = 'patch(es)';
                    } // Add more specific logic...

                    // Fallback to the first available unit if no specific logic matched
                    if (!unitToSelect && availableUnits.length > 0) {
                        unitToSelect = $unit.find('option').eq(1).val(); // Get first actual unit option (index 1)
                    }

                    // Set the selected unit
                    if (unitToSelect && $unit.find(`option[value="${unitToSelect}"]`).length) {
                        $unit.val(unitToSelect);
                    } else if (availableUnits.length>0) {
                        // Last resort: select the first item in the populated list if specific selection failed but list isn't empty
                         $unit.prop('selectedIndex', 1); // Index 1 is first non-placeholder option
                    }
                }
                // --- End unit selection ---
            } else {
                // No form match found, just populate units for the empty selection
                populateUnitOptions($form); // Will show "-- Select Form First --" or similar
            }
        } else {
             // No normalized form in data, just populate units for empty selection
             populateUnitOptions($form);
        }
    }
    // ---------------------------------------------------------
    // Validate medication entry (Unchanged)
    // ---------------------------------------------------------
    function validateMedicationEntry(medData, $alert) { /* ... unchanged ... */ }
     function validateMedicationEntry(medData, $alert) {
        $alert.hide().empty(); // Clear previous messages
        let isValid = true;
        let warnings = [];

        // Check required fields
        const { quantity, unit, frequency } = medData.sig_structured;

        if (!medData.drug.trim()) {
            $alert.text("Please select or enter a medication name.").show();
            return false; // Hard stop
        }

        // Allow quantity 0, but require unit & freq
         if ((!quantity && quantity !== 0 && quantity !== '0') || !unit || !frequency) {
            $alert.text("Please fill in Quantity, Unit, and Frequency.").show();
             isValid = false; // Can still show warnings below
             // Don't return yet, allow warnings to show
        }

        // Check reasonable amounts for tablets/capsules only if unit is set
        if (unit && quantity && (unit.includes('tablet') || unit.includes('capsule')) && parseFloat(quantity) > 4) {
             warnings.push("High dose: Taking more than 4 tablets/capsules at once may be unusual.");
        }

        // Check for frequent dosing only if unit is set
        if (unit && frequency && (frequency.includes('four times') || frequency.includes('every 4 hours') || frequency.includes('every 6 hours')) &&
           (unit.includes('tablet') || unit.includes('capsule')) ) {
             warnings.push("Frequent dosing: Taking tablets/capsules 4+ times/day. Please confirm.");
        }

         // Check for PRN without additional info
         if (frequency === 'as needed' && !medData.sig_structured.additional?.trim()) {
            warnings.push("Consider adding reason for 'as needed' use (e.g., 'for pain').");
         }

        // Check if 'Other' frequency is selected but additional info is empty
        if (frequency === 'other' && !medData.sig_structured.additional?.trim()) {
             warnings.push("Please specify frequency in 'Additional Info' when 'Other' is selected.");
             // Consider making this a hard fail? Depends on workflow.
             // isValid = false;
        }


        if (warnings.length > 0) {
           const warningHtml = warnings.map(w => `<li>⚠️ ${w}</li>`).join('');
           const message = (isValid ? '' : '<p>Please fix required fields.</p>') + `<ul>${warningHtml}</ul>`;
           $alert.html(message).show();
        }

        return isValid; // Return true only if required fields are met
    }
    // ---------------------------------------------------------
    // Render Med List with badges (Unchanged)
    // ---------------------------------------------------------
    function renderMedicationList() { /* ... unchanged ... */ }
     function renderMedicationList() {
        const $c = $('#medicationsListContainer').empty();
        if (!currentMedications.length) {
            return $c.html('<p>No medications added.</p>');
        }

        currentMedications.forEach((m, i) => {
            // Improved Combo Check: Use ingredients array length if available and > 1
            const isCombo = Array.isArray(m.ingredients) ? m.ingredients.length > 1 : m.drug.includes('/');
            const cls = isCombo ? 'combination-med' : 'single-med';
            const $item = $('<div>').addClass('added-medication-item').addClass(cls)
                                  .attr('data-index', i);

            const $info = $('<div class="med-info">');

            if (isCombo) {
                $info.append('<span class="badge combo">Combo</span>');
            }

            // Use pre-calculated strength/unit from data if available (more reliable)
             // Prefer data from active_ingredients structure
             let strengthText = '';
             if (Array.isArray(m.ingredients) && m.ingredients.length > 0) {
                 // Usually take the first ingredient's strength for the badge
                 const firstIng = m.ingredients[0];
                 if (firstIng && firstIng.strength && firstIng.unit) {
                      strengthText = `${firstIng.strength}${firstIng.unit}`;
                 }
             }
             // Fallback to previous regex method if needed (less reliable)
             if (!strengthText) {
                  const strengthMatch = m.drug.match(/\d+(\.\d+)?\s*(?:mg|mcg|g|ml|%|unit(?:s)?)(?:\/\w+)?/i); // Added 'units'
                  if (strengthMatch) strengthText = strengthMatch[0];
             }

            if(strengthText) {
                $info.append(`<span class="badge dosage">${strengthText}</span>`);
            }

            // Display drug name and SIG
            $info.append($('<span>').text(`${m.drug} – SIG: ${m.sig_string || 'N/A'}`));

            const $controls = $('<div class="med-controls">');
            const $removeBtn = $('<button type="button" class="remove-btn">Remove</button>').on('click', () => {
                if (confirm(`Remove "${m.drug}" from your list?`)) {
                    currentMedications.splice(i, 1);
                    renderMedicationList(); // Re-render the list
                }
            });

            $controls.append($removeBtn);
            $item.append($info, $controls);
            $c.append($item);
        });
    }
    // ---------------------------------------------------------
    // Clear Medication Entry Form (Unchanged)
    // ---------------------------------------------------------
    function clearMedicationEntryForm($row) { /* ... unchanged ... */ }
     function clearMedicationEntryForm($row) {
        $row.find('.medication-drug-input').val('').data('selectedMedData', null); // Clear stored data too
        $row.find('.medication-dosage-form').prop('selectedIndex', 0);
        $row.find('.sig-quantity').val('');
        $row.find('.sig-unit').empty().prop('disabled', true).append('<option>-- Select Form First --</option>');
        $row.find('.sig-frequency').prop('selectedIndex', 0);
        $row.find('.sig-additional').val('');
        $row.find('.validation-alert').hide().empty();
        $row.find('.medication-drug-input').focus(); // Focus back on drug input
    }
    // ---------------------------------------------------------
    // Add med, with validation (Unchanged)
    // ---------------------------------------------------------
    function addMedicationToList(medData, $row) { /* ... unchanged ... */ }
     function addMedicationToList(medData, $row) {
        const $alert = $row.find('.validation-alert');
        if (!validateMedicationEntry(medData, $alert)) {
            return false; // Stop if validation fails (required fields)
        }

        // Build SIG string
        const { quantity, unit, frequency, additional } = medData.sig_structured;
        let action = "Take"; // Default action
        const formVal = medData.dosageForm || ""
        const fLower = formVal.toLowerCase();

        // Determine action based on form
        if (fLower.includes('apply') || fLower.includes('topical') || fLower.includes('cream') || fLower.includes('ointment') || fLower.includes('lotion') || fLower.includes('gel') || fLower.includes('patch')) action = "Apply";
        else if (fLower.includes('instill') || fLower.includes('drop')) action = "Instill";
        else if (fLower.includes('inhale') || fLower.includes('inhaler') || fLower.includes('spray')) action = "Use"; // Combined inhaler/spray
        else if (fLower.includes('inject') || fLower.includes('injection')) action = "Inject";
        else if (fLower.includes('insert') || fLower.includes('suppository')) action = "Insert";
        // 'Take' covers tablets, capsules, liquids, lozenges etc.

        let sig = `${action} ${quantity || ''} ${unit || ''}`; // Handle potentially empty quantity/unit gracefully

        if (frequency === 'other') {
            sig += ` ${additional?.trim() || 'as directed'}`; // Prepend space if additional exists
        } else if (frequency) { // Only add frequency if selected
            sig += ` ${frequency}`;
            if (additional?.trim()) sig += ` ${additional.trim()}`; // Prepend space if additional exists
        } else if (additional?.trim()) {
            // If no frequency but additional info exists, append it (might need adjusting based on desired format)
             sig += ` ${additional.trim()}`;
        }


        medData.sig_string = sig.replace(/\s+/g, ' ').trim(); // Consolidate whitespace and trim ends
        medData.drug = medData.drug.trim(); // Trim drug name
        medData.dosageForm = formVal; // Ensure dosage form is stored

        // Add potentially missing data from 'selectedMedData' if available (important for combo/strength badges later)
        const selectedData = $row.find('.medication-drug-input').data('selectedMedData');
         if (selectedData) {
             medData.ingredients = selectedData.active_ingredients; // Use the correct key from fetched data
             medData.forms = selectedData.forms; // Store forms list too
             medData.drug_code = selectedData.drug_code; // Store code if needed later
             medData.is_restricted = selectedData.is_restricted; // Store restriction status
             // Copy other relevant fields? e.g. 'descriptor'
             // medData.descriptor = selectedData.descriptor;
         } else {
            // If entered manually, ensure ingredients structure is at least an empty array for consistency
             if (!medData.ingredients) medData.ingredients = [];
             if (!medData.forms) medData.forms = [];
         }

        currentMedications.push(medData);
        saveToHistory(medData);   // Save this specific entry to history
        renderMedicationList();
        loadHistoryList();        // Refresh history buttons
        clearMedicationEntryForm($row); // Reset the form
        return true;
    }
    // --- Helper to handle selecting a suggestion (Unchanged) ---
    function selectSuggestion(medData, targetInput, nameToSet) { /* ... unchanged ... */ }
     function selectSuggestion(medData, targetInput, nameToSet) {
         if (!medData || !targetInput || !targetInput.length) return;

         // Set the input field value (using the constructed name: Brand or Generic + Form)
         targetInput.val(nameToSet).trigger('change');

         // Store the full data object associated with the input field
         targetInput.data('selectedMedData', medData);

         // Auto-select form and units based on the chosen medication's data
         autoSelectFormAndUnits(medData, targetInput);

         // Move focus to the quantity field for quicker SIG entry
         targetInput.closest('.medication-entry-row').find('.sig-quantity').focus();

         // Hide the suggestion box
         $('#medicationSuggestionBox').hide();
    }
    // ---------------------------------------------------------
    // Autocomplete - Setup and Event Handlers (MODIFIED)
    // ---------------------------------------------------------
    function attachMedAutocomplete($input) {
        if (compiledDrugData.length === 0) {
             // Don't console.warn here as loading might still be in progress or failed gracefully
             // Message/placeholder already updated in the loading logic
             return;
        }
        const $box = $('#medicationSuggestionBox');
        let suggestions = [], // Array of suggestion jQuery elements
            dataArr = [],     // Array of corresponding data objects
            idx = -1,         // Current selected index
            debounce;

        function positionBox() { /* ... unchanged positioning logic ... */ }
         function positionBox() {
            const inputRect = $input[0].getBoundingClientRect();
            const scrollTop = $(window).scrollTop();
            const scrollLeft = $(window).scrollLeft();
            const inputWidth = $input.outerWidth(); // Get input width

             // Ensure box width is at least input width, but allow it to grow if content needs more
            $box.css({
                top: (inputRect.bottom + scrollTop) + "px",
                left: (inputRect.left + scrollLeft) + "px",
                minWidth: inputWidth + "px"
                // maxWidth can be set in CSS if needed: .suggestion-box { max-width: 500px; }
            }).show();
        }

        // --- Displays the suggestion list (Unchanged logic, relies on filtered data) ---
        function displaySuggestions(results) { /* ... unchanged display logic ... */ }
         function displaySuggestions(results) {
            $box.empty();
            suggestions = [];
            dataArr = [];
            idx = -1;

            if (!results || results.length === 0) {
                $box.html('<div class="no-results">No matching medications found.</div>');
                positionBox();
                return;
            }

            // Filter out restricted drugs (based on "is_restricted": true in JSON)
             // Now the Python script adds 'is_restricted', so use that directly.
            //const filtered = results.filter(item => !(item.is_restricted === true));
            // NO - filter happens during findMatching

            // Check if results were already filtered and none remain
            if (results.length === 0) { // Check results *after* potential filtering in findMatching
                $box.html('<div class="no-results">No eligible medications found (check spelling or restrictions).</div>');
                positionBox();
                return;
            }


            // Group by unique combination (ingredients + form) to avoid near duplicates in suggestions
            const map = new Map();
            results.forEach(item => { // Use the passed 'results' which are already filtered
                 // Key based on sorted ingredient names + first form (if available)
                  const ingNames = (item.active_ingredients || []).map(ing => ing.name.toLowerCase()).sort().join('|');
                  const firstForm = ((item.forms || [])[0] || '').toLowerCase();
                  const key = `${ingNames}::${firstForm}`;

                if (!map.has(key)) {
                    // Collect all brands for this unique combination from the *original* filtered results
                     const allBrandsForCombo = results // Use 'results' here too
                        .filter(fItem => {
                            const fIngNames = (fItem.active_ingredients || []).map(ing => ing.name.toLowerCase()).sort().join('|');
                            const fFirstForm = ((fItem.forms || [])[0] || '').toLowerCase();
                            const fKey = `${fIngNames}::${fFirstForm}`;
                           return fKey === key;
                        })
                        .map(fItem => fItem.brand_name)
                        .filter(brand => brand && brand.trim() !== ''); // Filter out empty brands

                      // Add ingredient name(s) as a 'brand' possibility if no actual brand names exist
                       if (allBrandsForCombo.length === 0 && Array.isArray(item.active_ingredients) && item.active_ingredients.length > 0) {
                           // Construct a generic name string
                           const genericNameAsBrand = item.active_ingredients.map(ing => ing.name).join(' / ');
                           if (genericNameAsBrand && !allBrandsForCombo.includes(genericNameAsBrand)) {
                               allBrandsForCombo.push(genericNameAsBrand);
                           }
                       }

                    map.set(key, {
                        representativeItem: item, // Use first item found as representative
                        brands: [...new Set(allBrandsForCombo)] // Unique brands
                    });
                }
            });

            const list = Array.from(map.values()).slice(0, MAX_SUGGESTIONS);

            list.forEach((group, i) => {
                const item = group.representativeItem;
                const brands = group.brands;

                // Construct main display text: Ingredient(s) (Form)
                let mainText = (item.active_ingredients || []).map(ing => ing.name).join(' / '); // Ingredients first
                const firstForm = (item.forms || [])[0]; // Get the primary form
                if(firstForm) {
                     mainText += ` (${firstForm})`; // Add form in parens
                }

                const $opt = $('<div class="suggestion-item">')
                    .data('medData', item) // Store representative data
                    .data('allBrands', brands); // Store all brands for this group

                const isCombo = (item.active_ingredients || []).length > 1;
                if (isCombo) {
                    $opt.addClass('combination-medication'); // Class for potential styling
                }

                const $nameSpan = $('<span class="suggestion-med-name">').text(mainText);
                if (isCombo) {
                    $nameSpan.append($('<span class="combo-badge">').text('Combo'));
                }
                // Restricted badge - should ideally not show due to filtering, but keep as double-check
                if (item.is_restricted) {
                   $nameSpan.append($('<span class="restricted-badge">').text('Restricted'));
                }

                $opt.append($nameSpan);

                // Display brands below
                if (brands.length > 0) {
                    // Filter out the mainText itself if it happened to be added as a brand
                    const displayableBrands = brands.filter(b => b !== mainText);
                    const limitedBrands = displayableBrands.slice(0, MAX_BRANDS_DISPLAY);

                    if(limitedBrands.length > 0) {
                        let brandHtml = 'Brands: ' + limitedBrands.join(', ');
                        if (displayableBrands.length > MAX_BRANDS_DISPLAY) {
                            brandHtml += `<span class="more-brands-link" data-group-index="${i}">(+${displayableBrands.length - MAX_BRANDS_DISPLAY} more)</span>`;
                        }
                        $opt.append($('<span class="suggestion-brands">').html(brandHtml));
                    }
                }


                $opt.on('mousedown', (ev) => {
                    if ($(ev.target).hasClass('more-brands-link')) {
                        // Handled by separate '.more-brands-link' mousedown handler below
                        return;
                    }
                    ev.preventDefault(); // Prevent input blur
                    // When clicking the main item, use the constructed generic/form name
                    selectSuggestion($(ev.currentTarget).data('medData'), $input, mainText);
                });

                $opt.on('mouseenter', () => {
                    $box.find('.suggestion-item').removeClass('selected');
                    $opt.addClass('selected');
                     // Update index based on CURRENTLY VISIBLE items (excluding additional brands)
                    idx = $box.find('.suggestion-item:not(.additional-brand-item)').index($opt);
                });

                $box.append($opt);

                // We don't manage suggestions/dataArr here anymore, managed by keydown nav
                // suggestions.push($opt);
                // dataArr.push(item);
            });

            $box.append('<div class="suggestion-item manual-entry">Can\'t find it? <strong>Enter manually</strong></div>');
            positionBox();
        } // End displaySuggestions


        // --- Event handler for clicking "more brands" (Unchanged) ---
        $(document).off('mousedown.morebrands').on('mousedown.morebrands', '.more-brands-link', function(e) {
             e.preventDefault();
            e.stopPropagation(); // Stop propagation to outer suggestion item handler
            const $link = $(this);
            const $currentItem = $link.closest('.suggestion-item');
            const allBrands = $currentItem.data('allBrands');
            const medData = $currentItem.data('medData'); // Get original data for ingredients/form info

            // Find existing container or create one
            let $additionalContainer = $currentItem.next('.additional-brands-container');

            if ($additionalContainer.length) {
                $additionalContainer.slideToggle(150); // Toggle if exists, slightly faster animation
                return;
            }

            $additionalContainer = $('<div class="additional-brands-container">').hide().insertAfter($currentItem);

            // Determine which brands are actually 'additional'
             const displayedCount = MAX_BRANDS_DISPLAY; // Number initially shown
             // Filter out the 'mainText' if it was among brands, then slice
             const mainText = $currentItem.find('.suggestion-med-name').text();
             const displayableBrands = allBrands.filter(b => b !== mainText);
            const additionalBrands = displayableBrands.slice(displayedCount);


            if (additionalBrands.length == 0) {
                  $additionalContainer.remove(); // Remove container if nothing to show
                  return;
            }


            additionalBrands.forEach(brand => {
                 // Construct display name for the list item: Just the Brand Name
                 let brandDisplayName = brand;

                // Construct main name for display under brand (Generic / Ingredients)
                let mainNameForDisplay = 'Unknown Generic';
                 if (medData && Array.isArray(medData.active_ingredients) && medData.active_ingredients.length > 0) {
                      mainNameForDisplay = medData.active_ingredients.map(ing => ing.name).join(' / ');
                 } else if (medData && medData.brand_name && medData.brand_name !== brand) {
                      // Fallback if ingredients somehow missing, but don't show brand as generic
                      mainNameForDisplay = medData.brand_name; // Less ideal, but better than nothing
                 }


                const $brandItem = $('<div class="suggestion-item additional-brand-item">')
                    .data('medData', medData) // Use original med data (contains ingredients, forms etc.)
                    .data('brandName', brand) // Store specific brand name clicked
                    // Display: Brand Name (with potential restricted badge)
                    .append($('<span class="suggestion-brands">').text(`${brand}`)) // Show brand prominently
                     // Display: Generic/Ingredient Name (italicized, smaller)
                    .append($('<span class="suggestion-med-name" style="font-style: italic; color: #555;">').text(mainNameForDisplay));

                 // Add restricted badge if applicable to the representative item
                 if (medData && medData.is_restricted) {
                      $brandItem.find('.suggestion-brands').append($('<span class="restricted-badge">').text('Restricted'));
                 }


                $brandItem.on('mousedown', function(evt) {
                    evt.preventDefault();
                    evt.stopPropagation();

                    const brandToSet = $(this).data('brandName');
                    const itemData = $(this).data('medData'); // Get full data

                     // Construct name for input field: Brand Name (Form)
                    let inputBrandName = brandToSet;
                    const firstForm = (itemData.forms || [])[0];
                    if (firstForm) {
                         inputBrandName += ` (${firstForm})`;
                    }

                    // Select using the specific BRAND name + Form for the input field value
                    selectSuggestion(itemData, $input, inputBrandName);
                });
                $additionalContainer.append($brandItem);
            });

            // Hide the original "more" link's parent span (cleaner toggle)
            $link.parent().slideUp(100); // Hide the span containing the link smoothly

            $additionalContainer.slideDown(200); // Show the new items
        }); // End more-brands-link handler


        // --- Find matching drugs (Now includes filtering restricted) ---
        function findMatching(query) {
            const terms = query.toLowerCase().split(/\s+/).filter(Boolean);
            if (terms.length === 0) {
                displaySuggestions([]);
                return;
            }

            console.time("Filtering Time"); // Start timing
            const results = compiledDrugData.filter(item => {
                // ** Filter out restricted items first **
                if (item.is_restricted === true) {
                    return false;
                }

                // Create comprehensive search string for each item ONCE
                 if (!item._search_string) { // Cache search string on first use
                    const ingredientsText = (item.active_ingredients || []).map(ing => ing.name).join(' ').toLowerCase();
                    const formsText = (item.forms || []).join(' ').toLowerCase();
                    item._search_string = `${item.brand_name || ''} ${ingredientsText} ${formsText}`.toLowerCase();
                 }
                const searchText = item._search_string;

                // Check if _all_ query terms are present in the search text
                return terms.every(term => searchText.includes(term));
            });
            console.timeEnd("Filtering Time"); // End timing

            // Limit results *after* filtering
            const limitedResults = results.slice(0, 50); // Limit results processed for suggestion display map

            displaySuggestions(limitedResults); // Display the filtered & limited results
        }

        // --- Input field event handlers (MODIFIED trigger length & debounce) ---
        $input.on('input', () => {
            clearTimeout(debounce);
            const value = $input.val().trim();
             // Clear associated data if user types something new after selecting
             if ($input.data('selectedMedData') && value !== $input.val()) { // Check raw value in case nameToSet was different
                $input.data('selectedMedData', null);
             }

            // **** UPDATED: Trigger search only after 3 characters ****
            if (value.length < 3) {
                $box.hide();
                return;
            }

            // Debounce the search
            // **** UPDATED: Reduced debounce for faster response ****
            debounce = setTimeout(() => findMatching(value), 150);
        });

        // --- Keydown handler (Unchanged) ---
        $input.on('keydown', (e) => { /* ... unchanged keydown logic ... */ });
        $input.on('keydown', (e) => {
            // Only handle keydown if suggestion box is visible
            if (!$box.is(':visible')) return;

            // Get all selectable items (suggestions + manual entry), EXCLUDING expanded brand items
            const $items = $box.find('.suggestion-item:not(.additional-brand-item)');
             if ($items.length === 0) return; // No items to navigate

            if (['ArrowDown', 'ArrowUp', 'Enter', 'Escape', 'Tab'].includes(e.key)) {
                 e.preventDefault(); // Prevent default browser behavior (scrolling, form submit)

                 if (e.key === 'Escape' || e.key === 'Tab') {
                     $box.hide();
                     return;
                 }

                 if (e.key === 'Enter') {
                      const $selectedItem = $items.filter('.selected');
                     if ($selectedItem.length) {
                           $selectedItem.trigger('mousedown'); // Simulate click on selected item
                     } else {
                         // Optional: Select first item if Enter is pressed with no explicit selection?
                         // $($items[0]).trigger('mousedown');
                     }
                       $box.hide(); // Hide on enter regardless
                     return;
                 }

                 // Arrow navigation
                 let currentIdx = $items.index($items.filter('.selected')); // Find current index, -1 if none
                 let newIdx = currentIdx;

                 if (e.key === 'ArrowDown') {
                     newIdx = (currentIdx + 1) % $items.length;
                 } else if (e.key === 'ArrowUp') {
                     newIdx = (currentIdx - 1 + $items.length) % $items.length;
                 }

                 // Update selection visuals
                  if (newIdx !== currentIdx) { // Check if index actually changed
                     $items.removeClass('selected'); // Remove from all
                     const $newItem = $($items[newIdx]);
                     $newItem.addClass('selected');
                     // Scroll into view if needed
                      const boxNode = $box[0];
                      const itemNode = $newItem[0];
                      if (itemNode.offsetTop < boxNode.scrollTop || itemNode.offsetTop + itemNode.offsetHeight > boxNode.scrollTop + boxNode.clientHeight) {
                        itemNode.scrollIntoView({ block: 'nearest', inline: 'nearest' });
                      }
                      // Update the internal index tracking variable (idx) if needed, though not strictly used elsewhere here
                      idx = newIdx;
                  }
            }
        });


        // --- Focus/Blur handlers (Unchanged) ---
        $input.on('focus', () => { /* ... unchanged focus logic ... */ });
        $input.on('focus', () => {
            // Track focus for inline brand click target and manual entry target
            $('.medication-drug-input').data('has-focus', false); // Clear others
            $input.data('has-focus', true);
            // Show suggestions if input has enough characters (now 3+)
            const value = $input.val().trim();
            if (value.length >= 3) { // Check against new threshold
                findMatching(value);
            }
        });
         $input.on('blur', () => {
             // Delay hiding to allow clicks inside suggestion box or expanded brands/manual entry
            setTimeout(() => {
                // Check if the newly focused element is the input itself, the box, or anything inside the box
                const activeElement = document.activeElement;
                 if (activeElement !== $input[0] && !$box[0].contains(activeElement)) {
                     $box.hide();
                 }
                // Explicitly remove has-focus flag when definitely blurred away
                 if (activeElement !== $input[0]) {
                    $input.data('has-focus', false);
                 }
            }, 250); // Delay remains reasonable
        });


        // Manual entry click (Unchanged)
         $(document).off('mousedown.manualentry').on('mousedown.manualentry', '.manual-entry', function(e) { e.preventDefault(); e.stopPropagation(); const custom = prompt("Enter full medication name (e.g., Metformin 500mg Tablet):"); if (custom) { const $focusedInput = $('.medication-drug-input').filter(function() { return $(this).data('has-focus'); }); if($focusedInput.length) { $focusedInput.val(custom.trim()).trigger('change'); $focusedInput.data('selectedMedData', null); const $row = $focusedInput.closest('.medication-entry-row'); $row.find('.medication-dosage-form').prop('selectedIndex', 0); populateUnitOptions($row.find('.medication-dosage-form')); $row.find('.sig-quantity').val('').focus(); } } $box.hide(); });
          $(document).off('mousedown.manualentry').on('mousedown.manualentry', '.manual-entry', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const custom = prompt("Enter full medication name (e.g., Metformin 500mg Tablet):");
            if (custom && custom.trim()) { // Ensure something was entered
                 // Find the input that likely triggered this
                 const $focusedInput = $('.medication-drug-input').filter(function() { return $(this).data('has-focus'); });
                 if($focusedInput.length) {
                     $focusedInput.val(custom.trim()).trigger('change');
                     $focusedInput.data({ selectedMedData: null, hasFocus: false }); // Clear selection data and focus flag

                     // Reset form/unit selectors as we don't know the form from manual entry
                     const $row = $focusedInput.closest('.medication-entry-row');
                     $row.find('.medication-dosage-form').prop('selectedIndex', 0);
                     populateUnitOptions($row.find('.medication-dosage-form')); // Reset units based on blank form
                     $row.find('.sig-quantity').val('').focus(); // Focus quantity
                 }
            }
            $box.hide();
         });

    } // End attachMedAutocomplete


    // ---------------------------------------------------------
    // Keyboard Nav within Form Row (Unchanged)
    // ---------------------------------------------------------
    function setupKeyboardNavigation() { /* ... unchanged ... */ }
     function setupKeyboardNavigation() {
        $('#medicationEntryArea').on('keydown', '.medication-drug-input, .medication-dosage-form, .sig-quantity, .sig-unit, .sig-frequency, .sig-additional, .add-current-med-button', function(e) {
             // Include button in listener
            if (!['ArrowRight', 'ArrowLeft', 'Enter'].includes(e.key)) return; // Only handle these keys

             // Don't navigate if suggestion box is open for drug input
             if ($(this).hasClass('medication-drug-input') && $('#medicationSuggestionBox').is(':visible')) {
                // Allow Enter to select suggestion via keydown handler in attachMedAutocomplete
                 if (e.key === 'Enter') return;
                 // Prevent left/right nav when suggestions open
                 if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                     e.preventDefault();
                     return;
                 }
             }

            const $row = $(this).closest('.medication-entry-row');
            const fields = [
                $row.find('.medication-drug-input'),
                $row.find('.medication-dosage-form'),
                $row.find('.sig-quantity'),
                $row.find('.sig-unit'), // Include unit even if disabled initially
                $row.find('.sig-frequency'),
                $row.find('.sig-additional'),
                $row.find('.add-current-med-button') // Navigate to button
            ];

            const currentIndex = fields.findIndex($el => $el.is(this));
            let targetIndex = -1;

            if (e.key === 'ArrowRight') {
                 if (currentIndex < fields.length - 1) {
                    e.preventDefault();
                    // Find next visible/enabled field
                    for (let i = currentIndex + 1; i < fields.length; i++) {
                        if (fields[i].length && fields[i].is(':visible') && !fields[i].prop('disabled')) {
                            targetIndex = i;
                            break;
                        }
                    }
                 }
            } else if (e.key === 'ArrowLeft') {
                 if (currentIndex > 0) {
                    e.preventDefault();
                    // Find previous visible/enabled field
                    for (let i = currentIndex - 1; i >= 0; i--) {
                        if (fields[i].length && fields[i].is(':visible') && !fields[i].prop('disabled')) {
                            targetIndex = i;
                            break;
                        }
                    }
                 }
            } else if (e.key === 'Enter') {
                 // If enter on button, allow it to trigger the click event naturally
                 if ($(this).is('.add-current-med-button')) {
                      // Let the default button 'click' on Enter happen
                      return;
                 }
                 // If enter on freq or additional, simulate add button click
                 if ($(this).is('.sig-frequency, .sig-additional')) {
                       e.preventDefault();
                       $row.find('.add-current-med-button').trigger('click'); // Use trigger('click')
                       return; // Stop further processing
                 }
                 // Allow default Enter behavior for other fields (e.g., selecting dropdown item)
                  // Optional: Move to next field on Enter for text/number inputs?
                  if ($(this).is('input[type="text"], input[type="number"]') && currentIndex < fields.length -1) {
                         e.preventDefault();
                         // Find next focusable field (similar to ArrowRight logic)
                         for (let i = currentIndex + 1; i < fields.length; i++) {
                             if (fields[i].length && fields[i].is(':visible') && !fields[i].prop('disabled')) {
                                  targetIndex = i;
                                  break;
                             }
                         }
                  }
            }

            if (targetIndex !== -1 && targetIndex < fields.length) {
                 fields[targetIndex].focus().select(); // select() useful for text inputs
            }
        });
    }


    // ---------------------------------------------------------
    // Document Ready - Main Initialization (MODIFIED loading)
    // ---------------------------------------------------------
    $(document).ready(() => {
        // No initial loading message show here, handled by loadCompiledDrugData

        setupKeyboardNavigation();

        // Age calculation (Unchanged)
        $('#dob').on('change', function() {
            const dob = new Date(this.value);
            const today = new Date();
            if (!isNaN(dob) && dob < today) { // Check if dob is valid and in the past
                let age = today.getFullYear() - dob.getFullYear();
                const m = today.getMonth() - dob.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
                    age--;
                }
                 $('#age').val(age >= 0 ? age : '');
            } else {
                $('#age').val('');
            }
            loadHistoryList(); // Reload history on DOB change
        });
        $('#dob').trigger('change'); // Calculate age on load if DOB is pre-filled

        // **** MODIFIED: Load medication data using the new async function ****
        loadCompiledDrugData()
            .then(data => {
                // This function now returns the parsed data or empty array
                compiledDrugData = Array.isArray(data) ? data : []; // Ensure it's an array

                // Pre-process search string cache (optional but can help performance slightly)
                // We'll do this lazily in findMatching now to spread the load

                // Check if data loading actually succeeded (function handles error messages)
                if (compiledDrugData.length === 0) {
                    console.warn("Compiled drug data is empty after loading.");
                    // Ensure input reflects the error state
                    $('.medication-drug-input').prop('disabled', true).attr('placeholder', 'Error: No drug data');
                    return; // Stop further processing that depends on data
                }

                console.log(`Successfully loaded ${compiledDrugData.length} drug records.`);

                // Enable the input field ONLY if data loaded successfully
                $('#medicationDrugField_0')
                    .prop('disabled', false)
                    .attr('placeholder', 'Start typing medication name…');

                // Attach autocomplete features now that data is ready
                attachMedAutocomplete($('#medicationDrugField_0'));

            })
            .catch(error => {
                // Catch potential errors from the Promise chain itself (less likely now with try/catch inside)
                console.error("Unexpected error during data loading sequence:", error);
                $('#errorMessage').text('An unexpected error occurred. Please refresh the page.').show();
                $('.medication-drug-input').prop('disabled', true).attr('placeholder', 'Error loading drug data');
            });


        // Populate units when form is manually changed (Unchanged)
        $('#medicationEntryArea').on('change', '.medication-dosage-form', function() {
            populateUnitOptions($(this));
            // Reset unit selection when form changes manually
             $(this).closest('.medication-entry-row').find('.sig-unit').prop('selectedIndex', 0);
        });

        // Add medication button click (Unchanged)
        $('#medicationEntryArea').on('click', '.add-current-med-button', function() {
            const $row = $(this).closest('.medication-entry-row');
            const medData = {
                drug: $row.find('.medication-drug-input').val(),
                dosageForm: $row.find('.medication-dosage-form').val(),
                sig_structured: {
                    quantity: $row.find('.sig-quantity').val(),
                    unit:     $row.find('.sig-unit').val(),
                    frequency: $row.find('.sig-frequency').val(),
                    additional: $row.find('.sig-additional').val()
                },
                 // selected data is added within addMedicationToList
            };
            addMedicationToList(medData, $row);
        });

        // Form submission (Unchanged)
        $('#patientForm').on('submit', e => {
            e.preventDefault();
            // Basic validation
            if (!$('#firstName').val().trim() || !$('#lastName').val().trim() || !$('#dob').val()) {
                alert("Please fill in First Name, Last Name, and Date of Birth.");
                 $('#firstName, #lastName, #dob').filter(function() { return !$.trim(this.value); }).first().focus();
                return;
            }
            if (currentMedications.length === 0) {
                alert("Please add at least one medication to the request.");
                 $('#medicationDrugField_0').focus();
                return;
            }
             // Check if current entry row has unsaved data (Improved check)
             const $row = $('#medicationRow_0');
             const drugInput = $.trim($row.find('.medication-drug-input').val());
             const quantityInput = $.trim($row.find('.sig-quantity').val());
             const unitSelected = $row.find('.sig-unit').val();
             const freqSelected = $row.find('.sig-frequency').val();
             const additionalInput = $.trim($row.find('.sig-additional').val());

             if (drugInput || quantityInput || unitSelected || freqSelected || additionalInput) {
                  if(!confirm("The current medication entry fields have data that hasn't been added to the list. Submit request without adding it?")) {
                      $row.find('.add-current-med-button').focus();
                      return;
                  }
             }

            // Build payload
            const payload = {
                firstName: $('#firstName').val().trim(),
                lastName: $('#lastName').val().trim(),
                dob: $('#dob').val(),
                age: $('#age').val(),
                medications: currentMedications,
                requestTimestamp: new Date().toISOString()
            };
            // --- SIMULATE SUBMISSION ---
            console.log("Submitting Payload:", JSON.stringify(payload, null, 2));
            savePreviousRequest(); // Save this successful request
            $('#successMessage').text(`Request for ${payload.firstName} ${payload.lastName} submitted.`).fadeIn().delay(4000).fadeOut();
            // --- END SIMULATION ---
            // Clear list and form after "successful" submission
            currentMedications = [];
            renderMedicationList();
            clearMedicationEntryForm($('#medicationRow_0'));
             loadHistoryList(); // Refresh history in case identifiers change between submits? Or just rely on identifier change event? Reloading is safer.
             $('#firstName').focus(); // Focus back to start
        }); // End form submit

        // Load history when patient identifiers change (Unchanged)
        $('#firstName, #lastName').on('change', loadHistoryList);

        // Initial setup (Unchanged)
        renderMedicationList();
        loadHistoryList();
        $('#firstName').focus(); // Focus on first name initially

    }); // End document ready
    })(jQuery); // End IIFE
</script>
</body>
</html>
