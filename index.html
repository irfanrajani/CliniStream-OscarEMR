<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Patient & Medication Entry</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        /* --- Core Styles --- */
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        h1, h2 { color: #333; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 800px; margin: auto; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input[type="text"], input[type="date"], input[type="number"], select, button { padding: 10px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; width: 100%; }
        button { cursor: pointer; background-color: #007bff; color: white; border: none; margin-top: 10px; }
        button:hover { background-color: #0056b3; }
        input[readonly] { background-color: #e9ecef; cursor: not-allowed; }
        hr { border: 0; height: 1px; background-color: #ddd; margin: 25px 0; }
        .medication-entry-row { border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; background-color: #f9f9f9; border-radius: 5px; }
        .medication-fields-grid { display: grid; grid-template-columns: 3fr 2fr; gap: 20px; margin-bottom: 15px; }
        .sig-structured-area { border-top: 1px dashed #ccc; margin-top: 15px; padding-top: 15px; }
        .sig-structured-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; align-items: end; margin-bottom: 10px; }
        .sig-structured-grid label { margin-bottom: 3px; font-size: 0.9em; }
        .sig-structured-grid input[type="number"] { max-width: 100px; } /* Existing max-width */
        .sig-additional-info { margin-top: 10px; }

        /* --- Suggestion Box --- */
        .suggestion-box { position: absolute; background: #fff; border: 1px solid #aaa; z-index: 9999; max-height: 300px; overflow-y: auto; min-width: 300px; max-width: 500px; display: none; border-radius: 4px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); font-family: sans-serif; font-size: 14px; }
        .suggestion-item { padding: 6px 12px; cursor: pointer; border-bottom: 1px solid #eee; line-height: 1.4; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover, .suggestion-item.selected { background-color: #e9ecef; }
        .suggestion-item.selected { background-color: #007bff; color: white; }
        .suggestion-med-name { display: block; font-weight: 500; white-space: normal; word-wrap: break-word; }
        .suggestion-brands { display: block; font-size: 0.9em; color: #555; font-style: italic; padding-left: 5px; margin-top: 2px; white-space: normal; word-wrap: break-word; }
        .suggestion-brands .more-brands-link { cursor: pointer; text-decoration: underline; color: #0056b3; margin-left: 5px; font-weight: normal; font-style: normal; }
        .suggestion-box .no-results { padding: 8px 12px; color:#666; font-style: italic; cursor: default; }
        /* **NEW/UPDATED** Style for manual entry item in suggestion box */
        .suggestion-item.manual-entry { border-top: 1px dashed #ccc; font-style: italic; }
        .suggestion-item.manual-entry strong { color: #0056b3; font-style: normal; }
        .suggestion-item.manual-entry:hover { background-color: #e9ecef; } /* Keep hover consistent */

        /* --- Medication List Styling --- */
        #medicationsListContainer { margin-top: 20px; border-top: 2px solid #007bff; padding-top: 15px; }
        .added-medication-item { border: 1px solid #b3e0ff; padding: 10px 15px; margin-bottom: 8px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
        .added-medication-item.single-med { background-color: #e6f7ff; }
        .added-medication-item.combination-med { background-color: #fff3cd; }
        .added-medication-item span { flex-grow: 1; margin-right: 10px; word-break: break-word; } /* This targets both badge and text, might need refinement if text span needs specific class */
        .added-medication-item button { padding: 4px 8px; font-size: 12px; background-color: #dc3545; width: auto; margin-top: 0; flex-shrink: 0; }
        .added-medication-item button:hover { background-color: #c82333; }
        .badge.combo { display: inline-block; background: #ffc107; color: #212529; padding: 2px 6px; margin-right: 8px; font-size: 0.75em; border-radius: 3px; vertical-align: middle; }

        /* --- Messages --- */
        #loadingMessage, #errorMessage { padding: 15px; border-radius: 4px; margin-bottom: 20px; text-align: center; display: none; }
        #loadingMessage { background-color: #ffc107; border: 1px solid #dda700; }
        #errorMessage { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }

        /* **NEW** History Area Styling */
        #historyContainer {
            margin-bottom: 20px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
            border: 1px solid #ced4da;
        }
        #historyContainer h3 { margin-top: 0; margin-bottom: 8px; font-size: 1em; color: #333; font-weight: bold; }
        #historyContainer .history-buttons-wrapper { display: flex; flex-wrap: wrap; gap: 5px; } /* Wrapper for layout */
        #historyContainer .history-btn {
             padding: 5px 10px;
             font-size: 0.9em;
             background-color: #6c757d; /* Neutral gray */
             color: white;
             width: auto; /* Override default full width */
             margin-top: 0; /* Override default button margin */
             border: none;
             border-radius: 4px;
             cursor: pointer;
         }
        #historyContainer .history-btn:hover { background-color: #5a6268; }
        #historyContainer .no-history { font-style: italic; color: #666; margin-top: 5px; display: block;}


    </style>
</head>
<body>
<div class="container">
    <!-- Loading/Error Message Area -->
    <div id="loadingMessage">Loading drug data... Please wait.</div>
    <div id="errorMessage">Error loading drug data. Autocomplete disabled. See console.</div>

    <h1>Patient Demographics</h1>
    <form id="patientForm">
        <div class="form-group">
            <label for="firstName">First Name:</label>
            <input type="text" id="firstName" name="firstName">
        </div>
        <div class="form-group">
            <label for="lastName">Last Name:</label>
            <input type="text" id="lastName" name="lastName">
        </div>
        <div class="form-group">
            <label for="dob">Date of Birth:</label>
            <input type="date" id="dob" name="dob">
        </div>
        <div class="form-group">
            <label for="age">Age:</label>
            <input type="number" id="age" name="age" readonly>
        </div>

        <h2>Medication Entry</h2>

        <!-- **UPDATED** Recently Used History Area Structure -->
        <div id="historyContainer">
             <h3>Your Recently Used Medications</h3>
             <div class="history-buttons-wrapper">
                  <!-- Buttons will be added here by loadHistoryList() -->
             </div>
             <span class="no-history" style="display: none;">No recently used medications found for this patient.</span>
        </div>


        <div id="medicationEntryArea">
            <div class="medication-entry-row" id="medicationRow_0">
                <div class="medication-fields-grid">
                    <div style="position: relative;">
                        <label for="medicationDrugField_0">Medication:</label>
                        <input type="text" id="medicationDrugField_0" name="medicationDrugField"
                               class="medication-drug-input" autocomplete="off"
                               placeholder="Loading drug data..." disabled>
                        <!-- Removed suggestion-anchor div -->
                    </div>
                    <div style="position: relative;"> <!-- Keep relative for potential future absolute elements if needed -->
                        <label for="medicationDosageForm_0">Dosage Form:</label>
                        <select id="medicationDosageForm_0" name="medicationDosageForm"
                                class="medication-dosage-form">
                            <option value="" disabled selected>-- Select Form --</option>
                            <option value="tablet">Tablet</option>
                            <option value="capsule">Capsule</option>
                            <option value="liquid">Liquid/Syrup</option>
                            <option value="suspension">Suspension</option>
                            <option value="injection">Injection (SC/IM/IV)</option>
                            <option value="inhaler">Inhaler</option>
                            <option value="topical">Topical Cream/Ointment/Gel</option>
                            <option value="patch">Patch</option>
                            <option value="suppository">Suppository</option>
                            <option value="eye drop">Eye Drop</option>
                            <option value="ear drop">Ear Drop</option>
                            <option value="nasal spray">Nasal Spray</option>
                        </select>
                    </div>
                </div>
                <div class="sig-structured-area">
                    <label style="font-weight: normal; margin-bottom: 10px; display: block;">
                        Directions / SIG:
                    </label>
                    <div class="sig-structured-grid">
                        <div>
                            <label for="sigQuantity_0">Quantity</label>
                            <input type="number" id="sigQuantity_0" class="sig-quantity"
                                   min="0" step="any" placeholder="e.g., 1"> <!-- Changed step to any for decimals -->
                        </div>
                        <div>
                            <label for="sigUnit_0">Unit</label>
                            <select id="sigUnit_0" class="sig-unit" disabled>
                                <option value="">-- Select Form First --</option>
                            </select>
                        </div>
                        <div>
                            <label for="sigFrequency_0">Frequency</label>
                            <select id="sigFrequency_0" class="sig-frequency">
                                <option value="" disabled selected>-- Select --</option>
                                <option value="once daily">Once daily (QD)</option>
                                <option value="twice daily">Twice daily (BID)</option>
                                <option value="three times daily">Three times daily (TID)</option>
                                <option value="four times daily">Four times daily (QID)</option>
                                <option value="every morning">Every morning (QAM)</option>
                                <option value="every evening">Every evening (QPM)</option>
                                <option value="at bedtime">At bedtime (QHS)</option>
                                <option value="every 4 hours">Every 4 hours</option>
                                <option value="every 6 hours">Every 6 hours</option>
                                <option value="every 8 hours">Every 8 hours</option>
                                <option value="every 12 hours">Every 12 hours</option>
                                <option value="every other day">Every other day</option>
                                <option value="once weekly">Once weekly</option>
                                <option value="as needed">As needed (PRN)</option>
                                <option value="other">Other (Specify Below)</option>
                            </select>
                        </div>
                    </div>
                    <div class="sig-additional-info">
                        <label for="sigAdditional_0">Additional Info / Frequency Detail</label>
                        <input type="text" id="sigAdditional_0" class="sig-additional"
                               placeholder="e.g., for pain, with food, for 7 days, or specify 'Other'">
                    </div>
                </div>
                <button type="button" class="add-current-med-button">
                    Add This Medication to List
                </button>
            </div>
             <!-- Suggestion box moved outside the entry row for better positioning control -->
             <div class="suggestion-box" id="medicationSuggestionBox"></div>
        </div>

        <h2>Current Medication List</h2>
        <div id="medicationsListContainer">
            <p>No medications added yet.</p>
        </div>
        <hr>
        <button type="submit">Submit Patient Data & Medications</button>
    </form>

</div><!-- /.container -->

<script>
    // ======================================================================
    //                    Configuration & Globals
    // ======================================================================
    const COMPILED_DATA_URL = 'compiled_drug_data.json';
    const MAX_SUGGESTIONS = 10;
    const MAX_BRANDS_DISPLAY = 3;
    let compiledDrugData = [];
    let currentMedications = []; // Array to hold added medication objects
    const dosageFormUnits = {
        tablet: ['tablet(s)'],
        capsule: ['capsule(s)'],
        liquid: ['mL','tsp (5mL)','tbsp (15mL)'],
        suspension: ['mL','tsp (5mL)','tbsp (15mL)'],
        injection: ['mL','unit(s)'],
        inhaler: ['puff(s)','inhalation(s)'],
        topical: ['application(s)','gram(s)'],
        patch: ['patch(es)'],
        suppository: ['suppository(ies)'],
        'eye drop': ['drop(s) in eye(s)','drop(s) in left eye','drop(s) in right eye'],
        'ear drop': ['drop(s) in ear(s)','drop(s) in left ear','drop(s) in right ear'],
        'nasal spray': ['spray(s) in nostril(s)','spray(s) in left nostril','spray(s) in right nostril']
    };

    // ======================================================================
    //                    History (Recently Used)
    // ======================================================================
    function getHistoryKey() {
        // Use a combination of first name and DOB for a patient-specific key
        // Use placeholders if fields are empty to generate a key anyway
        const first = $('#firstName').val().trim().toLowerCase() || 'anon';
        const dob = $('#dob').val() || 'nodob';
        // Basic normalization: remove non-alphanumeric for more consistency
        const normalizedFirst = first.replace(/[^a-z0-9]/g, '');
        return `medHistory:${normalizedFirst}_${dob}`;
    }

    function saveToHistory(drugName, dosageForm, sigData) {
        const key = getHistoryKey();
        let history = JSON.parse(localStorage.getItem(key) || '[]');
        // Store more info to potentially pre-fill later
        const historyEntry = {
            drug: drugName,
            dosageForm: dosageForm,
            sig: sigData // Store the structured SIG
        };
        // Prevent duplicates based on drug name only for simplicity here
        history = history.filter(item => item.drug.toLowerCase() !== drugName.toLowerCase());
        // Add new entry to the beginning and limit size
        history.unshift(historyEntry);
        history = history.slice(0, 10); // Keep last 10 entries
        localStorage.setItem(key, JSON.stringify(history));
    }

    function loadHistoryList() {
        const key = getHistoryKey();
        const history = JSON.parse(localStorage.getItem(key) || '[]');
        const $container = $('#historyContainer');
        const $buttonWrapper = $container.find('.history-buttons-wrapper').empty(); // Target the new wrapper
        const $noHistory = $container.find('.no-history');

        if (!history.length) {
             $noHistory.show();
             $buttonWrapper.hide(); // Hide wrapper if no buttons
             return;
         }

        $noHistory.hide();
        $buttonWrapper.show(); // Show wrapper

        history.forEach(entry => {
            // Display just the drug name on the button for simplicity
            const $btn = $('<button type="button" class="history-btn">').text(entry.drug);
            $btn.on('click', () => {
                // **ACTION:** Fill the current entry row with history data
                const $row = $('#medicationRow_0'); // Assuming only one entry row for now
                $row.find('.medication-drug-input').val(entry.drug);
                $row.find('.medication-dosage-form').val(entry.dosageForm);
                populateUnitOptions($row.find('.medication-dosage-form')); // Update units based on form
                // Pre-fill SIG fields
                $row.find('.sig-quantity').val(entry.sig.quantity);
                $row.find('.sig-unit').val(entry.sig.unit); // Unit might change if formUnits updated
                $row.find('.sig-frequency').val(entry.sig.frequency);
                $row.find('.sig-additional').val(entry.sig.additional);

                $row.find('.medication-drug-input').focus(); // Focus drug field after loading
                $('#medicationSuggestionBox').hide().empty(); // Hide suggestions if loading from history
            });
            $buttonWrapper.append($btn);
        });
    }


    // ======================================================================
    //                    UI Interaction Functions
    // ======================================================================
    function populateUnitOptions($dosageSelect) {
        const selectedForm = $dosageSelect.val();
        const $row = $dosageSelect.closest('.medication-entry-row');
        const $unitSelect = $row.find('.sig-unit');
        const currentUnitValue = $unitSelect.val(); // Remember current selection if possible

        $unitSelect.empty().prop('disabled', true); // Clear and disable

        if (selectedForm && dosageFormUnits[selectedForm]) {
            $unitSelect.append('<option value="" disabled selected>-- Select Unit --</option>'); // Add placeholder first
            dosageFormUnits[selectedForm].forEach(unit => {
                $unitSelect.append($('<option>').val(unit).text(unit));
            });
            $unitSelect.prop('disabled', false); // Enable the dropdown

            // Try to re-select the previous value if it's still valid, otherwise pick first
            if (currentUnitValue && dosageFormUnits[selectedForm].includes(currentUnitValue)) {
                 $unitSelect.val(currentUnitValue);
            } else {
                // **Auto-pick first available unit** (excluding placeholder)
                 const firstUnit = $unitSelect.find('option').not('[disabled]').eq(1).val(); // eq(1) to skip placeholder
                 if (firstUnit) {
                     $unitSelect.val(firstUnit);
                 }
            }
        } else {
            // If no form selected or no units defined, add disabled placeholder
            $unitSelect.append('<option value="">-- Select Form First --</option>');
        }
    }

    function attachMedAutocomplete($input) {
        // Ensure we have data before proceeding
        if (!$input.length) return console.error("Input element not found for autocomplete.");
        if (!compiledDrugData || compiledDrugData.length === 0) {
             // Data might still be loading, or failed. The placeholder/disabled state should reflect this.
             console.warn("Autocomplete attached, but drug data is not ready.");
             // Optionally, retry or add loading indicator logic here if needed
             return;
         }

        const $box = $('#medicationSuggestionBox');
        let debounceTimer;
        let suggestions = []; // To keep track of displayed suggestion elements
        let suggestionData = []; // To keep track of the data associated with suggestions
        let currentIndex = -1; // To track keyboard navigation

        function positionBox() {
            const inputRect = $input[0].getBoundingClientRect();
            const scrollTop = $(window).scrollTop();
            const scrollLeft = $(window).scrollLeft();
            // Position below the input field
             $box.css({
                 top: (inputRect.bottom + scrollTop) + "px", // Below input
                 left: (inputRect.left + scrollLeft) + "px", // Align left edge
                 minWidth: $input.outerWidth() + "px", // Match input width
                 display: 'block' // Use display instead of show/hide for clarity
             });
        }

        function displaySuggestions(results) {
            $box.empty().hide(); // Clear previous suggestions and hide initially
            suggestions = []; // Reset suggestions array
            suggestionData = []; // Reset data array
            currentIndex = -1; // Reset keyboard index

             // Filter out restricted drugs (ensure 'is_restricted' property exists or handle default)
             const nonRestricted = results.filter(item => !(item.availability && item.availability.is_restricted));

             if (nonRestricted.length === 0) {
                 $box.html('<div class="no-results">No matching medications found.</div>');
                 positionBox(); // Show the 'no results' message
                 return;
             }


            // Group results by unique combination of ingredients, strength, and form
            const groupedResults = new Map();
            nonRestricted.forEach(item => {
                // Create a consistent key. Handle potentially missing fields gracefully.
                const ingredientsKey = (item.ingredients || []).sort().join('|'); // Sort for consistency
                const strengthKey = item.strength || ''; // Use first_strength if available/preferred
                const formKey = item.dosage_form || ''; // Use normalized_dosage_form if available/preferred

                const key = `${ingredientsKey}|${strengthKey}|${formKey}`;
                const brandName = (item.brand_name || '').trim();

                if (!groupedResults.has(key)) {
                    groupedResults.set(key, { primary: item, brands: brandName ? [brandName] : [] });
                } else {
                    const entry = groupedResults.get(key);
                    // Add unique brand names
                     if (brandName && !entry.brands.includes(brandName)) {
                         entry.brands.push(brandName);
                     }
                    // Optionally, decide which item should be 'primary' (e.g., one with most info)
                 }
            });

            // Convert map values to array and slice to max suggestions
            let finalSuggestions = Array.from(groupedResults.values()).slice(0, MAX_SUGGESTIONS);

            // Build HTML for each suggestion item
            finalSuggestions.forEach((entry, index) => {
                const itemData = entry.primary; // The representative drug data for this group
                // Construct display text carefully, handling missing data
                 const ingredientsDisplay = (itemData.ingredients || []).join(' / ');
                 const formDisplay = itemData.dosage_form || '';
                 const strengthDisplay = itemData.strength || ''; // Use appropriate strength field
                 const mainText = `${ingredientsDisplay} ${strengthDisplay}${formDisplay ? ` (${formDisplay})` : ''}`.trim();

                const displayedBrands = entry.brands.slice(0, MAX_BRANDS_DISPLAY);
                const remainingBrandsCount = entry.brands.length - displayedBrands.length;

                // Create the suggestion item div and store data
                 const $suggestionDiv = $('<div class="suggestion-item">').data('medData', itemData);

                // Add main medication text
                 $suggestionDiv.append($('<span class="suggestion-med-name">').text(mainText));

                // Add brand names if available
                 if (displayedBrands.length > 0) {
                     let brandText = 'Brands: ' + displayedBrands.join(' / ');
                     if (remainingBrandsCount > 0) {
                         // Keep the 'more brands' link simple, maybe handle click later if needed
                         brandText += ` (+${remainingBrandsCount} more)`;
                     }
                     $suggestionDiv.append($('<span class="suggestion-brands">').html(brandText)); // Use html() if including spans/links
                 }

                // --- Event Handlers for Suggestion Item ---
                $suggestionDiv.on('mousedown', (event) => {
                     // Prevent input blur when clicking suggestion
                     event.preventDefault();

                     const selectedData = $suggestionDiv.data('medData');
                     // Format the text to put back into the input - match display format
                     const inputText = `${(selectedData.ingredients || []).join(' / ')} ${selectedData.strength || ''}${selectedData.dosage_form ? ` (${selectedData.dosage_form})` : ''}`.trim();

                     $input.val(inputText).trigger('change'); // Update input and trigger change

                     // Try to select the matching dosage form
                     const $row = $input.closest('.medication-entry-row');
                     const $formSelect = $row.find('.medication-dosage-form');
                     const normalizedForm = (selectedData.dosage_form || '').toLowerCase(); // Use normalized form if available

                     let formMatched = false;
                     $formSelect.find('option').each(function() {
                         const optionValue = $(this).val().toLowerCase();
                         // Simple matching - improve if needed (e.g., tablet vs oral tablet)
                         if (normalizedForm.includes(optionValue) || optionValue.includes(normalizedForm)) {
                             $formSelect.val($(this).val());
                             formMatched = true;
                             return false; // Exit each loop
                         }
                     });

                     // If no direct match, maybe reset or leave as is? Currently resets units below.
                     // if (!formMatched) { $formSelect.prop('selectedIndex', 0); } // Reset if no match?

                     populateUnitOptions($formSelect); // Populate units based on selected form

                     // Focus the quantity field for next step
                     $row.find('.sig-quantity').focus();

                     $box.empty().hide(); // Hide the suggestion box
                 });

                $suggestionDiv.on('mouseenter', () => {
                    // Highlight on hover
                     $box.find('.suggestion-item').removeClass('selected');
                     $suggestionDiv.addClass('selected');
                     currentIndex = $suggestionDiv.index(); // Update index for keyboard nav
                 });

                // Append the fully constructed suggestion item
                 $box.append($suggestionDiv);
                 suggestions.push($suggestionDiv); // Store the element itself
                 suggestionData.push(itemData); // Store corresponding data
             });

            // ** Append Manual Entry Fallback **
            $box.append('<div class="suggestion-item manual-entry">Can’t find your med? <strong>Enter manually</strong></div>');

             // Finally, position and display the box
             positionBox();
        }

        function findMatchingDrugs(query) {
            const terms = query.toLowerCase().split(/\s+/).filter(Boolean); // Split query into terms
            if (!terms.length) {
                displaySuggestions([]); // Show no results if query is empty
                return;
            }

            // Filter the master data list
             const matches = compiledDrugData.filter(item => {
                 // Create a searchable string for each item (include ingredients, brand, strength)
                 // Use pre-processed search fields if available (_search_brand, _search_ingredients)
                 const searchBrand = (item._search_brand || item.brand_name || '').toLowerCase();
                 const searchIngredients = (item._search_ingredients || (item.ingredients || []).join(' ')).toLowerCase();
                 const searchStrength = (item.strength || '').toLowerCase(); // Adapt field name as needed
                 const searchableText = `${searchBrand} ${searchIngredients} ${searchStrength}`;

                 // Check if all query terms are present in the searchable text
                 return terms.every(term => searchableText.includes(term));
             });

            displaySuggestions(matches); // Display the filtered results
        }

        // --- Event Listeners for Input Field ---
        $input.on('input', () => {
            clearTimeout(debounceTimer); // Clear previous timer on new input
            const query = $input.val().trim();

            if (query.length < 2) { // Only search if query is long enough
                 $box.empty().hide();
                 return;
             }
            // Debounce the search function call
             debounceTimer = setTimeout(() => {
                 findMatchingDrugs(query);
             }, 250); // Wait 250ms after typing stops
         });

        $input.on('keydown', (e) => {
             if (!$box.is(':visible') || suggestions.length === 0) return; // Ignore if box hidden or empty

             let preventDefault = true; // Assume we handle the key
             let scrollNeeded = false;

             switch (e.key) {
                 case 'ArrowDown':
                     currentIndex = (currentIndex + 1) % suggestions.length;
                     scrollNeeded = true;
                     break;
                 case 'ArrowUp':
                     currentIndex = (currentIndex - 1 + suggestions.length) % suggestions.length;
                     scrollNeeded = true;
                     break;
                 case 'Enter':
                 case 'Tab':
                     if (currentIndex >= 0) {
                         suggestions[currentIndex].trigger('mousedown'); // Simulate click on selected item
                     } else {
                          // If no item selected, maybe just close or allow default tab behavior?
                          $box.empty().hide();
                         if (e.key === 'Enter') e.preventDefault(); // Prevent form submit on enter if nothing selected
                         else preventDefault = false; // Allow tab to proceed
                      }
                     break;
                 case 'Escape':
                     $box.empty().hide();
                     break;
                 default:
                     preventDefault = false; // Don't prevent default for other keys
             }

             if (preventDefault) {
                 e.preventDefault();
                 // Update selection highlight
                 $box.find('.suggestion-item').removeClass('selected');
                 if (currentIndex >= 0) {
                     const currentSuggestion = suggestions[currentIndex];
                     currentSuggestion.addClass('selected');
                     // Ensure the selected item is visible within the suggestion box
                     if (scrollNeeded) {
                         currentSuggestion[0].scrollIntoView({ block: 'nearest' });
                     }
                 }
             }
         });

        $input.on('focus', () => {
            // Optionally, show suggestions immediately on focus if input has value
            const currentValue = $input.val().trim();
            if (currentValue.length >= 2) {
                findMatchingDrugs(currentValue);
            }
        });

        $input.on('blur', () => {
            // Hide suggestions shortly after blur, unless the mouse is over the box
             setTimeout(() => {
                 if (!$box.is(':hover')) {
                     $box.empty().hide();
                 }
             }, 200); // Delay allows clicking on suggestion item
         });

         // **NEW/UPDATED** Manual entry handler using event delegation on document
         $(document).on('mousedown', '.suggestion-item.manual-entry', function(event) {
              event.preventDefault(); // Prevent input blur
              const customMed = prompt("Please enter the full medication name and strength:");
              if (customMed && customMed.trim() !== '') {
                  const $targetInput = $('#medicationDrugField_0'); // Assuming one input field for now
                  $targetInput.val(customMed.trim()).trigger('change');
                   // Maybe clear dosage form/units or require manual selection?
                   const $row = $targetInput.closest('.medication-entry-row');
                   $row.find('.medication-dosage-form').prop('selectedIndex', 0);
                   $row.find('.sig-unit').empty().append('<option value="">-- Select Form First --</option>').prop('disabled', true);
                   // Consider adding a flag to the data submitted for review
                   $targetInput.data('manualEntry', true); // Store flag on the input element
                   $row.find('.medication-dosage-form').focus(); // Focus form select next
               }
               $('#medicationSuggestionBox').empty().hide(); // Close the box
           });
    }


    // ======================================================================
    //             Medication List & SIG Management
    // ======================================================================
    function renderMedicationList() {
        const $container = $('#medicationsListContainer').empty(); // Clear the container

        if (!currentMedications.length) {
            $container.html('<p>No medications added yet.</p>'); // Show placeholder text
            return;
        }

        currentMedications.forEach((medication, index) => {
            // Determine if it's a combination drug (simple check, refine if needed)
            // Needs access to ingredient count if available, otherwise fallback to name check
            const isCombination = medication.drug.includes('/') || (medication.ingredients && medication.ingredients.length > 1);
            const itemClass = isCombination ? 'combination-med' : 'single-med';

            // Create the main div for the medication item
            const $itemDiv = $(`<div class="added-medication-item ${itemClass}">`).attr('data-index', index);

            // Add Combo badge if it's a combination product
             if (isCombination) {
                 $itemDiv.append('<span class="badge combo">Combo</span>');
             }

            // Add medication text (Drug Name – SIG)
            const sigString = medication.sig_string || 'SIG missing'; // Fallback for safety
            const displayText = `${medication.drug} – SIG: ${sigString}`;
            $itemDiv.append($('<span>').text(displayText)); // Add text in its own span

            // Add Remove button
            const $removeButton = $('<button type="button">Remove</button>').on('click', () => {
                removeMedication(index); // Call remove function with the correct index
            });
            $itemDiv.append($removeButton);

            // Append the fully constructed item to the container
            $container.append($itemDiv);
        });
    }

    function addMedicationToList() {
        const $row = $('#medicationRow_0'); // Assuming one entry row
        const drugName = $row.find('.medication-drug-input').val().trim();
        const dosageForm = $row.find('.medication-dosage-form').val();
        const sigData = {
            quantity: $row.find('.sig-quantity').val(),
            unit:     $row.find('.sig-unit').val(),
            frequency:$row.find('.sig-frequency').val(),
            additional: $row.find('.sig-additional').val().trim()
        };

        // Basic validation
        if (!drugName) {
            alert("Please enter or select a medication name.");
            $row.find('.medication-drug-input').focus();
            return false; // Indicate failure
        }
        if (!dosageForm) {
            alert("Please select a dosage form.");
            $row.find('.medication-dosage-form').focus();
             return false;
         }
        if (!sigData.quantity || !sigData.unit || !sigData.frequency) {
             alert("Please fill in Quantity, Unit, and Frequency for the SIG.");
             // Focus the first empty required SIG field
             if (!sigData.quantity) $row.find('.sig-quantity').focus();
             else if (!sigData.unit) $row.find('.sig-unit').focus();
             else $row.find('.sig-frequency').focus();
             return false;
         }
        // Frequency 'other' requires additional info
         if (sigData.frequency === 'other' && !sigData.additional) {
             alert("Please specify the frequency details in the 'Additional Info' field when selecting 'Other'.");
             $row.find('.sig-additional').focus();
             return false;
         }

        // **Validation hint:** Check for high quantity (e.g., > 4 tablets)
        if (parseFloat(sigData.quantity) > 4 && sigData.unit && sigData.unit.toLowerCase().includes('tablet')) {
            if (!confirm(`⚠️ You entered ${sigData.quantity} tablets. Is this correct?`)) {
                $row.find('.sig-quantity').focus();
                return false; // Stop if user cancels
            }
        }
        if (parseFloat(sigData.quantity) > 4 && sigData.unit && sigData.unit.toLowerCase().includes('capsule')) {
            if (!confirm(`⚠️ You entered ${sigData.quantity} capsules. Is this correct?`)) {
                $row.find('.sig-quantity').focus();
                return false; // Stop if user cancels
            }
        }


        // Build the SIG string
        let action = "Take"; // Default action
        const formLower = (dosageForm || '').toLowerCase();
        if (formLower.includes('topical') || formLower.includes('patch')) action = "Apply";
        else if (formLower.includes('drop')) action = "Instill";
        else if (formLower.includes('inhaler') || formLower.includes('spray')) action = "Use";
        else if (formLower.includes('injection')) action = "Inject";
        else if (formLower.includes('suppository')) action = "Insert";

        let sigString = `${action} ${sigData.quantity} ${sigData.unit}`;
        if (sigData.frequency === 'other') {
            sigString += ` ${sigData.additional || 'as directed'}`; // Use additional info or fallback
        } else {
            sigString += ` ${sigData.frequency}`;
            if (sigData.additional) { // Append additional info if provided (e.g., 'for pain')
                 sigString += ` ${sigData.additional}`;
             }
        }
        // Clean up extra spaces
        sigString = sigString.trim().replace(/\s+/g, ' ');

        // Prepare the medication object to add
        const medication = {
            drug: drugName,
            dosageForm: dosageForm,
            sig_structured: sigData,
            sig_string: sigString,
             manualEntry: $row.find('.medication-drug-input').data('manualEntry') || false // Check if manually entered
         };

        // Add to the list
        currentMedications.push(medication);

        // **Save to history** (pass structured SIG too)
        saveToHistory(drugName, dosageForm, sigData);
        loadHistoryList(); // Refresh history display

        renderMedicationList(); // Update the displayed list

        // Clear the input fields for the next entry
        $row.find('.medication-drug-input').val('').removeData('manualEntry').focus(); // Clear and reset manual flag
        $row.find('.medication-dosage-form').prop('selectedIndex', 0);
        $row.find('.sig-quantity').val('');
        $row.find('.sig-unit').empty().append('<option value="">-- Select Form First --</option>').prop('disabled', true);
        $row.find('.sig-frequency').prop('selectedIndex', 0);
        $row.find('.sig-additional').val('');

        return true; // Indicate success
    }

    function removeMedication(index) {
        // Ensure index is valid
        if (index >= 0 && index < currentMedications.length) {
            currentMedications.splice(index, 1); // Remove item from array
            renderMedicationList(); // Re-render the list
        }
    }

    // ======================================================================
    //                       Document Ready
    // ======================================================================
    $(document).ready(function(){

        // Attach listener to patient info fields to reload history on change
        $('#firstName, #dob').on('change', loadHistoryList);

        // Load master drug data
        $('#loadingMessage').show();
        $.getJSON(COMPILED_DATA_URL)
         .done(function(data){
            $('#loadingMessage').hide();
            if (!Array.isArray(data) || data.length === 0) {
                console.error("Loaded drug data is not a valid array or is empty.");
                $('#errorMessage').text("Error: Could not load medication list data.").show();
                // Keep input disabled if data fails
                 return;
             }
            console.log(`Loaded ${data.length} drug records.`);
            compiledDrugData = data;
            // Enable the input field now that data is loaded
             $('#medicationDrugField_0')
                 .prop('disabled', false)
                 .attr('placeholder', 'Start typing medication name...');
             attachMedAutocomplete($('#medicationDrugField_0')); // Attach autocomplete now
         })
         .fail(function(jqXHR, textStatus, errorThrown){
            $('#loadingMessage').hide();
            $('#errorMessage').text(`Error loading medication data: ${textStatus}. Please try again later.`).show();
            console.error("Failed to load drug data:", textStatus, errorThrown);
            // Keep input field disabled
         });

        // Age calculation on DOB change
        $('#dob').on('change', function(){
            const dobValue = $(this).val();
            if (!dobValue) {
                $('#age').val('');
                return;
            }
            const dob = new Date(dobValue);
            const today = new Date();
            // Basic validation for date format and future date
            if (isNaN(dob.getTime()) || dob > today) {
                 $('#age').val(''); // Clear age if date is invalid or in the future
                 // Optionally show a validation message to the user
                 return;
             }
            let age = today.getFullYear() - dob.getFullYear();
            const monthDiff = today.getMonth() - dob.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
                age--; // Decrement age if birthday hasn't occurred yet this year
            }
            $('#age').val(age >= 0 ? age : ''); // Display age, ensuring it's not negative
         }).trigger('change'); // Calculate age on initial load if DOB is pre-filled

        // Update Unit options when Dosage Form changes
        $('#medicationEntryArea').on('change', '.medication-dosage-form', function(){
            populateUnitOptions($(this));
        });

        // **NEW** Keyboard navigation: Enter on Quantity moves to Add button
        $('#medicationEntryArea').on('keydown', '.sig-quantity', function(e) {
             if (e.key === 'Enter') {
                 e.preventDefault(); // Prevent form submission or other default actions
                 $(this).closest('.medication-entry-row').find('.add-current-med-button').focus(); // Focus the add button
             }
         });

        // Add medication button click handler
        $('#medicationEntryArea').on('click', '.add-current-med-button', function(){
            addMedicationToList(); // Call the function to add the med
        });

        // Form submission
        $('#patientForm').submit(function(e){
            e.preventDefault(); // Prevent default browser form submission
            // Gather form data
            const formData = {
                patient: {
                    firstName: $('#firstName').val().trim(),
                    lastName: $('#lastName').val().trim(),
                    dob: $('#dob').val(),
                    age: $('#age').val()
                },
                 // Filter medications to only include necessary data for submission
                 medications: currentMedications.map(med => ({
                     drug: med.drug,
                     dosageForm: med.dosageForm,
                     sig_string: med.sig_string,
                     sig_structured: med.sig_structured, // Include structured sig if needed
                     manualEntry: med.manualEntry // Include manual entry flag
                 }))
             };

             // Basic check: ensure patient info is present
             if (!formData.patient.firstName || !formData.patient.dob) {
                 alert("Please enter patient's First Name and Date of Birth.");
                 return;
             }
            // Basic check: ensure at least one medication is added
             if(formData.medications.length===0){
                alert("Please add at least one medication to the list before submitting.");
                return;
             }

            // Output to console for now - replace with actual submission logic (AJAX)
            console.log("SUBMITTING FORM DATA:", JSON.stringify(formData, null, 2));
            alert("Form data is ready to be submitted (see console log). Implement actual submission logic here.");

            // TODO: Replace console.log/alert with AJAX call to your backend endpoint
            // Example using jQuery AJAX:
            /*
            $.ajax({
                url: '/your-backend-endpoint', // Replace with your actual endpoint
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    alert('Refill request submitted successfully!');
                     // Optionally clear form or redirect
                     currentMedications = []; // Clear list
                     renderMedicationList();
                     $('#patientForm')[0].reset(); // Reset form fields
                     loadHistoryList(); // Reload history (might be empty now)
                 },
                 error: function(jqXHR, textStatus, errorThrown) {
                    alert('Error submitting request: ' + textStatus);
                    console.error("Submission error:", textStatus, errorThrown);
                 }
             });
            */
        });

        // Initial render of the (empty) medication list and history
        renderMedicationList();
        loadHistoryList(); // Load history based on initial patient field values (if any)

    }); // End document ready
</script>
</body>
</html>
