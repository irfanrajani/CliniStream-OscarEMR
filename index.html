<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Patient Refill Request</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Added Pako.js for gzip decompression -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <style>
        /* --- Core Styles --- */
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        h1, h2, h3 { color: #333; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 800px; margin: auto; }
        /* --- Patient Form --- */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input[type="text"], input[type="date"], input[type="number"], select, button {
            padding: 10px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; width: 100%;
        }
        input[readonly] { background-color: #e9ecef; }
        button { cursor: pointer; background-color: #007bff; color: white; border: none; margin-top: 10px; }
        button:hover { background-color: #0056b3; }
        /* --- History Buttons --- */
        #historyContainer { margin-bottom: 20px; }
        .history-section { border-top: 1px solid #eee; padding-top: 10px; margin-top: 15px; }
        .history-title { font-size: 16px; margin-bottom: 8px; color: #555; }
        .history-btn {
            margin: 4px 4px 4px 0; padding: 8px 12px; font-size: 0.9em;
            background-color: #e6f7ff; border: 1px solid #b3e0ff; color: #0056b3;
            border-radius: 4px; cursor: pointer; display: inline-block;
        }
        .history-btn:hover { background-color: #d0edff; }
        /* --- Medication Entry --- */
        .medication-entry-row { border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; background-color: #f9f9f9; border-radius: 5px; }
        .medication-fields-grid { display: grid; grid-template-columns: 3fr 2fr; gap: 20px; margin-bottom: 15px; }
        .sig-structured-area { border-top: 1px dashed #ccc; margin-top: 15px; padding-top: 15px; }
        .sig-structured-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; align-items: end; margin-bottom: 10px; }
        .sig-additional-info { margin-top: 10px; }
        .form-hint { color: #6c757d; font-size: 0.85em; margin-top: 3px; font-style: italic; }
        /* --- Suggestion Box --- */
        .suggestion-box { position: absolute; background: #fff; border: 1px solid #aaa; z-index: 9999; max-height: 300px; overflow-y: auto; min-width: 300px; max-width: 500px; display: none; border-radius: 4px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); font-size: 14px; }
        .suggestion-item { padding: 6px 12px; cursor: pointer; border-bottom: 1px solid #eee; position: relative; /* Needed for absolute child */ }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover, .suggestion-item.selected { background-color: #e9ecef; }
        .suggestion-med-name { font-weight: 500; display: block; /* Ensure block for badge positioning */ margin-bottom: 2px;}
        .suggestion-brands { font-size: 0.9em; color: #555; font-style: italic; display: block; }
        .more-brands-link { text-decoration: underline; color: #0056b3; cursor: pointer; margin-left: 5px; }
        .manual-entry { background-color: #f8f9fa; border-top: 1px solid #ddd; padding: 8px 12px; }
        .manual-entry strong { color: #007bff; }
        .suggestion-box .no-results { padding: 8px 12px; color:#666; font-style: italic; cursor: default; }
        /* Styling for additional brand items */
         .additional-brands-container .additional-brand-item {
            padding-left: 25px !important; /* Indent more */
            background-color: #f8f9fa !important; /* Different background */
            border-top: 1px dashed #eee; /* Separator */
         }
         .additional-brands-container .additional-brand-item .suggestion-med-name { font-weight: 400; } /* Less emphasis */
         .additional-brands-container .additional-brand-item .suggestion-brands { color: #333; }
          .additional-brands-container { /* Container itself */
              border-left: 3px solid #007bff; /* Indicate relation */
              margin-left: 5px;
           }
        /* --- Medication List --- */
        #medicationsListContainer { margin-top: 20px; border-top: 2px solid #007bff; padding-top: 15px; }
        .added-medication-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 15px; margin-bottom: 12px; border-radius: 4px;
            font-size: 14px; border: 1px solid; position: relative;
        }
         /* Added list: Diff color */
        .added-medication-item.single-med { background-color: #e6f7ff; border-color: #b3e0ff; }
        .added-medication-item.combination-med { background-color: #fff3cd; border-color: #ffeeba; }
        .added-medication-item .med-info { flex-grow: 1; padding-right: 15px; word-break: break-word; }
        .added-medication-item .med-controls { display: flex; gap: 5px; flex-shrink: 0; align-items: center; /* Align buttons vertically */ }
        .added-medication-item .remove-btn,
        .added-medication-item .edit-btn { /* Style both buttons */
            padding: 4px 8px; font-size: 12px;
            width: auto; margin-top: 0; flex-shrink: 0; color: white;
            border: none; border-radius: 3px; cursor: pointer;
        }
         .added-medication-item .remove-btn { background-color: #dc3545; }
         .added-medication-item .remove-btn:hover { background-color: #c82333; }
         .added-medication-item .edit-btn { background-color: #ffc107; color: #212529; /* Dark text on yellow */}
         .added-medication-item .edit-btn:hover { background-color: #e0a800; }

        .badge {
            display: inline-block; padding: 3px 7px; font-size: 0.75em;
            border-radius: 3px; margin-right: 8px; font-weight: bold; vertical-align: middle;
        }
        .badge.combo { background: #ffc107; color: #212529; } /* Added list badge */
        .badge.dosage { background: #17a2b8; color: #fff; }
        /* --- Messages --- */
        #loadingMessage, #errorMessage, #successMessage { padding: 15px; border-radius: 4px; margin-bottom: 20px; text-align: center; display: none; }
        #loadingMessage { background-color: #ffc107; border: 1px solid #dda700; } /* Use this for loading indication */
        #errorMessage   { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        #successMessage { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        /* --- Validation --- */
        .validation-alert {
            background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404;
            padding: 10px; border-radius: 4px; margin: 10px 0; display: none;
        }
        /* --- Badges & Coloring in Suggestion Box --- */
        .suggestion-box .combination-medication {
             /* NEW: Subtle background for combo drugs in suggestions */
             background-color: #f0f8ff; /* AliceBlue - adjust as needed */
        }
        /* Ensure selected style overrides combo background */
        .suggestion-box .combination-medication.selected {
            background-color: #e9ecef; /* Default selected color */
        }
        .restricted-badge { /* Suggestion box badge */
          display: inline-block;
          background-color: #dc3545;
          color: white;
          font-size: 0.7em;
          padding: 1px 4px;
          border-radius: 3px;
          margin-left: 5px;
          font-weight: bold;
          vertical-align: text-top; /* Align better with text */
        }
        .combo-badge { /* Suggestion box badge */
          display: inline-block;
          background-color: #17a2b8; /* Suggestion: distinct color from list badge */
          color: white;
          font-size: 0.7em;
          padding: 1px 4px;
          border-radius: 3px;
          margin-left: 5px;
          font-weight: bold;
           vertical-align: text-top; /* Align better with text */
        }
         /* Ensure suggestion box badges are visible on selected items */
        .suggestion-item.selected .restricted-badge,
        .suggestion-item.selected .combo-badge {
          color: white; /* Keep text white */
          /* Background might need adjustment if selected color is dark */
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Refill Request</h1>
    <!-- Loading / Error / Success Messages -->
    <div id="loadingMessage">Loading medication data…</div>
    <div id="errorMessage">Error loading data. Please try again later.</div>
    <div id="successMessage">Your refill request has been submitted successfully!</div>
    <!-- Patient Info -->
    <h2>Patient Information</h2>
    <form id="patientForm">
        <div class="form-group">
            <label for="firstName">First Name:</label>
            <input type="text" id="firstName" name="firstName" required>
        </div>
        <div class="form-group">
            <label for="lastName">Last Name:</label>
            <input type="text" id="lastName" name="lastName" required>
        </div>
        <div class="form-group">
            <label for="dob">Date of Birth:</label>
            <input type="date" id="dob" name="dob" required>
        </div>
        <div class="form-group">
            <label for="age">Age:</label>
            <input type="number" id="age" name="age" readonly>
        </div>
        <!-- History of last meds -->
        <div id="historyContainer"></div>
        <h2>Medication Entry</h2>
        <div id="medicationEntryArea">
            <div class="medication-entry-row" id="medicationRow_0">
                <div class="medication-fields-grid">
                    <div style="position: relative;">
                        <label for="medicationDrugField_0">Medication:</label>
                        <!-- ADDED ARIA attributes for Combobox role -->
                        <input type="text" id="medicationDrugField_0" class="medication-drug-input"
                               autocomplete="off"
                               placeholder="Loading drug data..." disabled
                               role="combobox"
                               aria-autocomplete="list"
                               aria-haspopup="listbox"
                               aria-expanded="false"
                               aria-controls="medicationSuggestionBox"
                               aria-activedescendant="">
                        <div class="form-hint">Begin typing 3+ characters OR select manual entry below</div>
                        <div class="suggestion-anchor" style="position: relative; height: 0;"></div>
                    </div>
                    <div>
                        <label for="medicationDosageForm_0">Form:</label>
                        <select id="medicationDosageForm_0" class="medication-dosage-form">
                            <option value="" disabled selected>-- Select Form --</option>
                            <!-- Keep static options, data matching is primary -->
                            <option value="tablet">Tablet</option>
                            <option value="capsule">Capsule</option>
                            <option value="liquid">Liquid/Syrup</option> <!-- Combined for broader match -->
                            <option value="solution">Solution</option>
                            <option value="suspension">Suspension</option>
                            <option value="injection">Injection</option>
                            <option value="inhaler">Inhaler</option>
                            <option value="topical">Topical</option>
                            <option value="cream">Cream</option>
                            <option value="ointment">Ointment</option>
                            <option value="lotion">Lotion</option>
                            <option value="gel">Gel</option>
                            <option value="patch">Patch</option>
                            <option value="suppository">Suppository</option>
                            <option value="eye drop">Eye Drop</option>
                            <option value="ear drop">Ear Drop</option>
                            <option value="nasal spray">Nasal Spray</option>
                            <option value="powder">Powder</option>
                            <option value="lozenge">Lozenge</option>
                        </select>
                    </div>
                </div>
                <div class="sig-structured-area">
                    <label>Directions / SIG:</label>
                    <div class="validation-alert" id="validationAlert_0"></div>
                    <div class="sig-structured-grid">
                        <div>
                            <label for="sigQuantity_0">Quantity</label>
                            <input type="number" id="sigQuantity_0" class="sig-quantity" min="0" step="0.01"> <!-- Allow decimals -->
                        </div>
                        <div>
                            <label for="sigUnit_0">Unit</label>
                            <select id="sigUnit_0" class="sig-unit" disabled>
                                <option>-- Select Form First --</option>
                            </select>
                        </div>
                        <div>
                            <label for="sigFrequency_0">Frequency</label>
                            <select id="sigFrequency_0" class="sig-frequency">
                                <option value="" disabled selected>-- Select --</option>
                                <option value="once daily">Once daily (QD)</option>
                                <option value="twice daily">Twice daily (BID)</option>
                                <option value="three times daily">Three times daily (TID)</option>
                                <option value="four times daily">Four times daily (QID)</option>
                                <option value="every morning">Every morning (QAM)</option>
                                <option value="every evening">Every evening (QPM)</option>
                                <option value="at bedtime">At bedtime (QHS)</option>
                                <option value="every 4 hours">Every 4 hours</option>
                                <option value="every 6 hours">Every 6 hours</option>
                                <option value="every 8 hours">Every 8 hours</option>
                                <option value="every 12 hours">Every 12 hours</option>
                                <option value="every other day">Every other day</option>
                                <option value="once weekly">Once weekly</option>
                                <option value="twice weekly">Twice weekly</option>
                                <option value="as needed">As needed (PRN)</option>
                                <option value="other">Other (Specify Below)</option>
                            </select>
                        </div>
                    </div>
                    <div class="sig-additional-info">
                        <label for="sigAdditional_0">Additional Info</label>
                        <input type="text" id="sigAdditional_0" class="sig-additional"
                            placeholder="e.g., for pain, with food, etc.">
                    </div>
                </div>
                <!-- Button text/color will change based on add/edit mode -->
                <button type="button" class="add-current-med-button">Add Medication</button>
            </div>
        </div>
        <h2>Your Medications</h2>
        <div id="medicationsListContainer">
            <p>No medications added.</p>
        </div>
        <hr>
        <button type="submit">Submit Request</button>
    </form>
    <!-- Autocomplete Suggestions - ADDED role="listbox" -->
    <div class="suggestion-box" id="medicationSuggestionBox" role="listbox"></div>
</div>
<script>
    // IIFE to encapsulate code
    (function($) {
    // ---------------------------------------------------------
    // CONFIG & GLOBALS
    // ---------------------------------------------------------
    const COMPILED_DATA_URL = 'https://raw.githubusercontent.com/irfanrajani/CliniStream-OscarEMR/main/compiled_drug_data.json.gz'; // MAKE SURE THIS URL IS CORRECT
    let compiledDrugData = [];
    let currentMedications = [];
    const MAX_SUGGESTIONS = 10;
    const MAX_BRANDS_DISPLAY = 3;
    const MAX_HISTORY_ITEMS = 15;

    // Editing State
    let editingMedBaseName = null; // Track which med group is being edited

    // Updated dosageFormUnits with explicit lowercase keys and added 'syrup'
    const dosageFormUnits = {
        'tablet': ['tablet(s)'], 'capsule': ['capsule(s)'], 'lozenge': ['lozenge(s)'],
        'powder': ['packet(s)', 'scoop(s)', 'gram(s)', 'mg'],
        'liquid': ['mL','tsp (5mL)','tbsp (15mL)'], // Primary key for liquids
        'solution': ['mL','tsp (5mL)','tbsp (15mL)'],
        'suspension': ['mL','tsp (5mL)','tbsp (15mL)'],
        'syrup': ['mL','tsp (5mL)','tbsp (15mL)'], // Explicitly add syrup units
        'injection': ['mL','unit(s)'], 'inhaler': ['puff(s)','inhalation(s)'],
        'nasal spray': ['spray(s) in nostril(s)','spray(s) in left nostril','spray(s) in right nostril'],
        'topical': ['application(s)','gram(s)','mL'], 'cream': ['application(s)','gram(s)'],
        'ointment': ['application(s)','gram(s)'], 'lotion': ['application(s)','mL'],
        'gel': ['application(s)','gram(s)'], 'patch': ['patch(es)'],
        'suppository': ['suppository(ies)'],
        'eye drop': ['drop(s)','drop(s) in eye(s)','drop(s) in left eye','drop(s) in right eye'],
        'ear drop': ['drop(s)','drop(s) in ear(s)','drop(s) in left ear','drop(s) in right ear']
    };

    // Enhanced form mappings for better matching
     const formMappings = {
            'tablet': 'tablet', 'tab': 'tablet','tabs': 'tablet', 'tbl': 'tablet', 'chew tab': 'tablet', 'odt': 'tablet', 'dr tab': 'tablet', 'er tab': 'tablet',
            'capsule': 'capsule', 'cap': 'capsule','caps': 'capsule', 'gelcap': 'capsule', 'dr cap': 'capsule', 'er cap': 'capsule',
            'liquid': 'liquid', 'liq': 'liquid', 'oral liq': 'liquid',
            'solution': 'solution', 'soln': 'solution', 'sol': 'solution', 'oral soln': 'solution',
            'suspension': 'suspension', 'susp': 'suspension', 'oral susp': 'suspension',
            'syrup': 'liquid', // Map syrup to the combined liquid/syrup option
            'elixir': 'liquid', // Map elixir to liquid/syrup option
            'injection': 'injection', 'inj': 'injection', 'sc': 'injection', 'im': 'injection', 'iv': 'injection',
            'inhaler': 'inhaler', 'inhaln': 'inhaler', 'mdi': 'inhaler', 'dpi': 'inhaler', 'neb': 'solution', // Neb solution might be 'solution'
            'topical': 'topical', 'topic': 'topical',
            'cream': 'cream', 'crm': 'cream',
            'ointment': 'ointment', 'oint': 'ointment', 'ung': 'ointment',
            'lotion': 'lotion', 'lot': 'lotion',
            'gel': 'gel',
            'patch': 'patch', 'td patch': 'patch',
            'suppository': 'suppository', 'supp': 'suppository',
            'eye drop': 'eye drop', 'ophth drop': 'eye drop', 'eye drops': 'eye drop',
            'ear drop': 'ear drop', 'otic drop': 'ear drop', 'ear drops': 'ear drop',
            'nasal spray': 'nasal spray', 'nas spray': 'nasal spray',
            'powder': 'powder', 'pwd': 'powder', 'for soln': 'powder', 'for susp': 'powder',
            'lozenge': 'lozenge', 'loz': 'lozenge'
            // Add more mappings as needed based on your specific data
        };

    // ---------------------------------------------------------
    // Data Loading Function
    // ---------------------------------------------------------
    async function loadCompiledDrugData() {
        console.log("Attempting to load compiled drug data...");
        $('#loadingMessage').text('Loading medication data... Please wait.').show();
        $('#errorMessage').hide();
        $('.medication-drug-input').prop('disabled', true).attr('placeholder', 'Loading drug data...');

        try {
            const response = await fetch(COMPILED_DATA_URL);
            console.log("Fetch response status:", response.status);
            if (!response.ok) {
                throw new Error(`Failed to fetch drug data: ${response.status} ${response.statusText}`);
            }
            const compressedData = await response.arrayBuffer();
            console.log(`Fetched ${compressedData.byteLength} bytes (compressed).`);
            if (compressedData.byteLength === 0) {
                 throw new Error("Downloaded data file is empty.");
            }
            console.log("Decompressing data...");
            const decompressed = pako.inflate(compressedData, { to: 'string' });
            console.log(`Decompressed data length: ${decompressed.length} characters.`);
            console.log("Parsing JSON...");
            const data = JSON.parse(decompressed);
            console.log("JSON parsed successfully.");

             if (!Array.isArray(data)) {
                 throw new Error("Parsed data is not an array.");
             }

            $('#loadingMessage').hide();
            if (data.length > 0) {
                 $('.medication-drug-input')
                     .prop('disabled', false)
                     .attr('placeholder', 'Start typing medication name…');
                console.log(`Successfully loaded ${data.length} drug records.`);
            } else {
                 throw new Error("Loaded data is an empty array.");
            }
            return data;
        } catch (error) {
            console.error('Error loading or processing compiled drug data:', error);
            const userMessage = `Unable to load medication data. Please check your internet connection or refresh the page. Error: ${error.message}`;
            $('#errorMessage').text(userMessage).show();
            $('#loadingMessage').hide();
            $('.medication-drug-input').prop('disabled', true).attr('placeholder', 'Error loading drug data');
            return [];
        }
    }
    // ---------------------------------------------------------
    // History Functions (Unchanged)
    // ---------------------------------------------------------
    function historyKeyBase() {
        const first = $('#firstName').val().trim().toLowerCase();
        const last = $('#lastName').val().trim().toLowerCase();
        const dob = $('#dob').val();
        if (!first || !dob) return null;
        return `${first}_${last}_${dob}`;
    }
    function historyKey() {
        const base = historyKeyBase();
        return base ? `medHistory:${base}` : null;
    }
    function historyKeyPrevRequests() {
         const base = historyKeyBase();
        return base ? `prevRequests:${base}` : null;
    }
    function saveToHistory(med) {
        const key = historyKey();
        if (!key) return;
        try {
            // Ensure med object is serializable (especially if added via complex objects)
            const cleanedMed = JSON.parse(JSON.stringify(med));
            let hist = JSON.parse(localStorage.getItem(key) || '[]');
            const medLower = cleanedMed.drug.toLowerCase();
            hist = [cleanedMed, ...hist.filter(m => m.drug.toLowerCase() !== medLower)].slice(0, MAX_HISTORY_ITEMS);
            localStorage.setItem(key, JSON.stringify(hist));
        } catch (e) {
            console.error("Error saving to history:", e);
        }
    }
    function savePreviousRequest() {
        const key = historyKeyPrevRequests();
        if (!key || !currentMedications.length) return;
        const request = {
            timestamp: new Date().toISOString(),
            medications: JSON.parse(JSON.stringify(currentMedications)) // Deep copy for safety
        };
        try {
            let prevRequests = JSON.parse(localStorage.getItem(key) || '[]');
            prevRequests.unshift(request);
            if (prevRequests.length > 5) prevRequests = prevRequests.slice(0, 5);
            localStorage.setItem(key, JSON.stringify(prevRequests));
        } catch (e) {
            console.error("Error saving previous request:", e);
        }
    }
    function loadHistoryList() {
        const $cont = $('#historyContainer').empty();
        if (!$('#firstName').val() || !$('#dob').val()) return;

        const medKey = historyKey();
        if (medKey) {
            try {
                const hist = JSON.parse(localStorage.getItem(medKey) || '[]');
                if (hist.length) {
                    $cont.append('<div class="history-section"><div class="history-title">Recently Used Medications</div><div id="recentMedsHistory"></div></div>');
                    const $recentMeds = $('#recentMedsHistory');
                    hist.forEach(med => {
                        if (!med || typeof med !== 'object') { // Basic check for invalid history items
                            console.warn("Skipping invalid history item:", med);
                            return;
                        }
                        const displaySig = med.sig_string || 'Click to fill';
                        const $btn = $('<button type="button" class="history-btn">')
                            .text(med.drug || 'Unknown Medication') // Safety check for drug name
                            .attr('title', displaySig)
                            .on('click', () => {
                                if (editingMedBaseName) { // Prevent loading history while editing
                                    alert("Please finish editing the current medication before loading from history.");
                                    return;
                                }
                                const $row = $('#medicationRow_0');
                                $row.find('.medication-drug-input').val(med.drug).data('selectedMedData', null);
                                $row.find('.sig-quantity').val( med.sig_structured?.quantity || '');
                                $row.find('.sig-frequency').val( med.sig_structured?.frequency || '');
                                $row.find('.sig-additional').val( med.sig_structured?.additional || '');
                                const $form = $row.find('.medication-dosage-form');
                                let selectedFormValue = '';
                                if (med.dosageForm) {
                                    selectedFormValue = med.dosageForm.toLowerCase();
                                    const match = $form.find('option').filter(function() { return this.value.toLowerCase() === selectedFormValue; });
                                     if(match.length) { $form.val(match.val()); selectedFormValue = match.val(); }
                                     else { const mapped = formMappings[selectedFormValue]; const mappedMatch = $form.find('option').filter(function() { return this.value === mapped; }); if (mappedMatch.length) { $form.val(mappedMatch.val()); selectedFormValue = mappedMatch.val(); } else { $form.prop('selectedIndex', 0); selectedFormValue = ''; } }
                                } else { $form.prop('selectedIndex', 0); }
                                populateUnitOptions($form);
                                if (med.sig_structured?.unit) { if ($row.find('.sig-unit option[value="' + med.sig_structured.unit + '"]').length > 0) { $row.find('.sig-unit').val(med.sig_structured.unit); } else { $row.find('.sig-unit').prop('selectedIndex', 0); } }
                                else { setDefaultUnit($row, selectedFormValue); }
                                $row.find('.sig-quantity').focus();
                            });
                        $recentMeds.append($btn);
                    });
                }
            } catch(e){ console.error("Error loading medication history:", e); }
        }

        const reqKey = historyKeyPrevRequests();
        if (reqKey) {
           try {
               const prevRequests = JSON.parse(localStorage.getItem(reqKey) || '[]');
               if (prevRequests.length) {
                    $cont.append('<div class="history-section"><div class="history-title">Previous Refill Requests</div><div id="previousRequestsList"></div></div>');
                    const $prevList = $('#previousRequestsList');
                    prevRequests.forEach((req, i) => {
                         if (!req || !Array.isArray(req.medications)) { console.warn("Skipping invalid previous request:", req); return; } // Validation
                        const date = new Date(req.timestamp); const dateStr = date.toLocaleDateString(); const numMeds = req.medications.length;
                        const $btn = $('<button type="button" class="history-btn">')
                            .html(`${dateStr} (${numMeds} med${numMeds !== 1 ? 's' : ''})`)
                            .on('click', () => {
                                 if (editingMedBaseName) { alert("Please finish editing the current medication first."); return; }
                                if (confirm(`Replace current list with the ${numMeds} medication(s) from ${dateStr} request?`)) {
                                    currentMedications = JSON.parse(JSON.stringify(req.medications));
                                    renderMedicationList(); clearMedicationEntryForm($('#medicationRow_0'));
                                }
                            });
                        $prevList.append($btn);
                    });
                }
            } catch(e){ console.error("Error loading previous requests:", e); }
        }
    }
    // ---------------------------------------------------------
    // Form/Unit Helper Functions (Unchanged)
    // ---------------------------------------------------------
    function populateUnitOptions($formSelect) {
        const selectedFormValue = ($formSelect.val() || "").toLowerCase();
        const $row = $formSelect.closest('.medication-entry-row');
        const $unitSelect = $row.find('.sig-unit');
        const currentUnitVal = $unitSelect.val();
        $unitSelect.empty().prop('disabled', true);
        let units = dosageFormUnits[selectedFormValue];
         if (!units && ['liquid', 'solution', 'suspension', 'syrup'].includes(selectedFormValue)) { units = dosageFormUnits['liquid']; }

        if (units && units.length > 0) {
            $unitSelect.append('<option value="" disabled selected>-- Select Unit --</option>');
            units.forEach(u => $unitSelect.append($('<option>').val(u).text(u)));
            $unitSelect.prop('disabled', false);
             if (currentUnitVal && units.includes(currentUnitVal)) { $unitSelect.val(currentUnitVal); }
        } else { $unitSelect.append('<option>-- Select Form First --</option>'); }
    }

     function setDefaultUnit($row, formValueLower) {
         if (!formValueLower) return;
         const $unitSelect = $row.find('.sig-unit');
         const availableUnits = dosageFormUnits[formValueLower] || (['liquid', 'solution', 'suspension', 'syrup'].includes(formValueLower) ? dosageFormUnits['liquid'] : []);
         if (availableUnits.length === 0) return;
         let unitToSelect = null;
         if (formValueLower.includes('tablet')) unitToSelect = 'tablet(s)';
         else if (formValueLower.includes('capsule')) unitToSelect = 'capsule(s)';
         else if (['liquid', 'solution', 'suspension', 'syrup'].includes(formValueLower)) unitToSelect = 'mL';
         else if (['cream', 'ointment', 'gel', 'topical', 'lotion'].includes(formValueLower)) unitToSelect = 'application(s)';
         else if (formValueLower.includes('inhaler')) unitToSelect = 'puff(s)';
         else if (formValueLower.includes('eye drop')) unitToSelect = 'drop(s) in eye(s)';
         else if (formValueLower.includes('ear drop')) unitToSelect = 'drop(s) in ear(s)';
         else if (formValueLower.includes('nasal spray')) unitToSelect = 'spray(s) in nostril(s)';
         else if (formValueLower.includes('patch')) unitToSelect = 'patch(es)';
         else if (formValueLower.includes('lozenge')) unitToSelect = 'lozenge(s)';
         else if (formValueLower.includes('powder')) unitToSelect = 'packet(s)';
         else if (formValueLower.includes('suppository')) unitToSelect = 'suppository(ies)';
         else if (formValueLower.includes('injection')) unitToSelect = 'mL';

         if (unitToSelect && $unitSelect.find(`option[value="${unitToSelect}"]`).length) { $unitSelect.val(unitToSelect); }
         else if (availableUnits.length > 0 && $unitSelect.find('option').length > 1) { $unitSelect.prop('selectedIndex', 1); }
     }

    function autoSelectFormAndUnits(medData, $inputField) {
        if (!medData || !$inputField || !$inputField.length) return;
        const $row = $inputField.closest('.medication-entry-row');
        const $form = $row.find('.medication-dosage-form');
        const $unit = $row.find('.sig-unit');
        const $quantity = $row.find('.sig-quantity');
        const primaryForms = medData.forms || [];
        let formFromData = null;
        if (primaryForms.length > 0) { formFromData = primaryForms[0]; console.log("Form from data:", formFromData); }

        if (!formFromData) { /* Try name match as fallback */ console.log("No form in data, trying name match...");
            const nameFormMatch = medData.brand_name ? medData.brand_name.match(/\b(tab|cap|crm|oin|gel|sol|sus|syr|inj|inh|lot|pat|dro|spr|pow|loz)\b/i) : null;
             if (nameFormMatch) { formFromData = nameFormMatch[1]; console.log("Form from name match:", formFromData); }
        }

        const normalizedForm = (formFromData || '').trim().toLowerCase();
        let finalSelectedFormValue = ''; let formSelected = false;
        $unit.empty().append('<option>-- Select Form First --</option>').prop('disabled', true); $form.prop('selectedIndex', 0);

       if (normalizedForm) {
            console.log("Normalized form to match:", normalizedForm); let bestMatchValue = null;
            $form.find('option').each(function() { /* Direct match */ if (this.value.toLowerCase() === normalizedForm) { bestMatchValue = this.value; return false; } });
            if (!bestMatchValue) { /* Mapped match */ const mappedFormValue = formMappings[normalizedForm]; if (mappedFormValue) { console.log("Mapped form:", mappedFormValue); if ($form.find(`option[value="${mappedFormValue}"]`).length) { bestMatchValue = mappedFormValue; } } }

             if (bestMatchValue) {
                 console.log("Selecting form:", bestMatchValue); $form.val(bestMatchValue); finalSelectedFormValue = bestMatchValue.toLowerCase();
                 populateUnitOptions($form); formSelected = true; if (!$quantity.val()) { $quantity.val('1'); }
                 setTimeout(() => { setDefaultUnit($row, finalSelectedFormValue); console.log("Default unit potentially set for:", finalSelectedFormValue); }, 50);
            } else { console.warn("Could not reliably map data form '" + normalizedForm + "' to a dropdown option."); }
        }
        if (!formSelected) { populateUnitOptions($form); }
    }

    // ---------------------------------------------------------
    // Validation Function (Unchanged)
    // ---------------------------------------------------------
     function validateMedicationEntry(medData, $alert) {
         $alert.hide().empty();
         let isValid = true; let warnings = []; const { quantity, unit, frequency, additional } = medData.sig_structured;
         if (!medData.drug.trim()) { $alert.text("Please select or enter a medication name.").show(); return false; }
         if ((!quantity && quantity !== 0 && quantity !== '0') || !unit || !frequency) { $alert.html("Please fill in <strong>Quantity</strong>, <strong>Unit</strong>, and <strong>Frequency</strong>.").show(); isValid = false; }
         if (unit && quantity && (unit.includes('tablet') || unit.includes('capsule')) && parseFloat(quantity) > 4) { warnings.push("High dose: Taking more than 4 tablets/capsules at once may be unusual."); }
         if (unit && frequency && (frequency.includes('four times') || frequency.includes('every 4 hours') || frequency.includes('every 6 hours')) && (unit.includes('tablet') || unit.includes('capsule')) ) { warnings.push("Frequent dosing: Taking tablets/capsules 4+ times/day. Please confirm."); }
         if (frequency === 'as needed' && !additional?.trim()) { warnings.push("Consider adding reason for 'as needed' use (e.g., 'for pain')."); }
         if (frequency === 'other' && !additional?.trim()) { warnings.push("Please specify frequency in 'Additional Info' when 'Other' is selected."); }
         if (warnings.length > 0) { const warningHtml = warnings.map(w => `<li>⚠️ ${w}</li>`).join(''); const currentHtml = $alert.html(); const message = (currentHtml ? currentHtml + '<br>' : '') + `<strong>Warnings:</strong><ul>${warningHtml}</ul>`; $alert.html(message).show(); }
         return isValid;
     }

    // ---------------------------------------------------------
    // Render Med List - MODIFIED (Add Edit Button & Logic)
    // ---------------------------------------------------------
    function renderMedicationList() {
        const $c = $('#medicationsListContainer').empty();
        if (!currentMedications.length) {
            return $c.html('<p>No medications added.</p>');
        }

        const medicationGroups = {};
        currentMedications.forEach((med, index) => { // Store original index
             med._originalIndex = index;
             let baseName = med.drug.replace(/\s+\d+(\.\d+)?\s*(mg|mcg|g|ml|%|unit[s]?|meq|iu)(?:\/\w+)?(\s*\(.*\))?$/i, '').replace(/\s+(tab|cap|soln|susp|syr|inj|oint|crm|lot|gel|inh)\.?$/i,'').trim();
             if (!baseName) baseName = med.drug;
             if (!medicationGroups[baseName]) { medicationGroups[baseName] = { base: baseName, meds: [], strengths: new Set() }; }
             medicationGroups[baseName].meds.push(med);
             let strengthText = '';
             if (Array.isArray(med.ingredients) && med.ingredients.length > 0 && med.ingredients[0]?.strength) { strengthText = `${med.ingredients[0].strength}${med.ingredients[0].unit || ''}`; }
             else { const strengthMatch = med.drug.match(/\d+(\.\d+)?\s*(mg|mcg|g|ml|%|unit[s]?|meq|iu)(?:\/\w+)?/i); if (strengthMatch) strengthText = strengthMatch[0]; }
             if (strengthText) medicationGroups[baseName].strengths.add(strengthText);
        });

        // Render each group
        Object.values(medicationGroups).forEach(group => {
            const representativeMed = group.meds[0]; // Use first med for display/edit baseline
            const isCombo = Array.isArray(representativeMed.ingredients) && representativeMed.ingredients.length > 1;
            const cls = isCombo ? 'combination-med' : 'single-med';
            // Use baseName as identifier for consistent editing/removal
            const $item = $('<div>').addClass('added-medication-item').addClass(cls)
                                  .attr('data-basename', group.base);
            const $info = $('<div class="med-info">');

            if (isCombo) $info.append('<span class="badge combo">Combo</span>');
            group.strengths.forEach(strength => $info.append(`<span class="badge dosage">${strength}</span>`));
            // Display base name + SIG from the representative medication
            $info.append($('<span>').text(`${group.base} – SIG: ${representativeMed.sig_string || 'N/A'}`));

            const $controls = $('<div class="med-controls">');

            // --- NEW: Edit Button ---
            const $editBtn = $('<button type="button" class="edit-btn">Edit</button>') // Style via CSS now
                .on('click', function() {
                    const baseNameToEdit = $(this).closest('.added-medication-item').data('basename');
                    // Find the first medication object matching this base name to populate the form
                    const medToEdit = currentMedications.find(m => {
                        let medBaseName = m.drug.replace(/\s+\d+(\.\d+)?\s*(mg|mcg|g|ml|%|unit[s]?|meq|iu)(?:\/\w+)?(\s*\(.*\))?$/i, '').replace(/\s+(tab|cap|soln|susp|syr|inj|oint|crm|lot|gel|inh)\.?$/i,'').trim();
                        if (!medBaseName) medBaseName = m.drug;
                        return medBaseName === baseNameToEdit;
                    });

                    if (!medToEdit) { console.error("Could not find medication data to edit for:", baseNameToEdit); return; }

                    // Populate the form fields
                    const $row = $('#medicationRow_0');
                    // Use the stored full drug name (which includes strength/form)
                    $row.find('.medication-drug-input').val(medToEdit.drug).data('selectedMedData', null); // Clear selected data flag
                    $row.find('.sig-quantity').val(medToEdit.sig_structured?.quantity || '');
                    $row.find('.sig-frequency').val(medToEdit.sig_structured?.frequency || '');
                    $row.find('.sig-additional').val(medToEdit.sig_structured?.additional || '');

                    const $form = $row.find('.medication-dosage-form');
                    let formValLower = (medToEdit.dosageForm || '').toLowerCase();
                    let formSet = false;
                    // Try direct match
                    $form.find('option').each(function() { if (this.value.toLowerCase() === formValLower) { $form.val(this.value); formValLower = this.value; formSet = true; return false; } });
                    // Try mapping if direct match failed
                    if (!formSet && formMappings[formValLower]) { const mappedVal = formMappings[formValLower]; if ($form.find(`option[value="${mappedVal}"]`).length) { $form.val(mappedVal); formValLower = mappedVal; formSet = true; } }
                    if (!formSet) $form.prop('selectedIndex', 0); // Fallback

                    populateUnitOptions($form); // Populate units based on selected form

                    // Set unit after populating options
                    if (medToEdit.sig_structured?.unit) {
                       if ($row.find('.sig-unit option[value="' + medToEdit.sig_structured.unit + '"]').length > 0) { $row.find('.sig-unit').val(medToEdit.sig_structured.unit); }
                       else { $row.find('.sig-unit').prop('selectedIndex', 0); setDefaultUnit($row, formValLower); }
                    } else {setDefaultUnit($row, formValLower); }

                    // Set editing state
                    editingMedBaseName = baseNameToEdit;
                    $('#medicationEntryArea .add-current-med-button').text('Update Medication').css('background-color', '#28a745'); // Green 'Update' button
                    $row.find('.medication-drug-input').focus(); // Focus on drug input for editing
                    $('html, body').animate({ scrollTop: $row.offset().top - 20 }, 300); // Scroll form into view
                });

            // --- Remove Button --- (Added check for editing state)
            const $removeBtn = $('<button type="button" class="remove-btn">Remove</button>').on('click', function() {
                 const baseNameToRemove = $(this).closest('.added-medication-item').data('basename');
                 // Check if removing the item currently being edited
                 if (editingMedBaseName === baseNameToRemove) {
                     if (!confirm(`This medication is currently being edited. Are you sure you want to remove "${baseNameToRemove}" and cancel editing?`)) {
                         return; // User cancelled
                     }
                     // If confirmed, cancel editing state and proceed with removal
                     editingMedBaseName = null;
                     clearMedicationEntryForm($('#medicationRow_0')); // Clear form & reset button/state
                 } else {
                     // Normal removal confirmation
                     if (!confirm(`Remove "${baseNameToRemove}" (all strengths) from your list?`)) {
                          return; // User cancelled
                     }
                 }
                 // Perform removal
                 currentMedications = currentMedications.filter(med => {
                      let medBaseName = med.drug.replace(/\s+\d+(\.\d+)?\s*(mg|mcg|g|ml|%|unit[s]?|meq|iu)(?:\/\w+)?(\s*\(.*\))?$/i, '').replace(/\s+(tab|cap|soln|susp|syr|inj|oint|crm|lot|gel|inh)\.?$/i,'').trim();
                      if (!medBaseName) medBaseName = med.drug;
                      return medBaseName !== baseNameToRemove;
                  });
                 renderMedicationList(); // Re-render the list
            });

            $controls.append($editBtn, $removeBtn); // Add Edit button before Remove
            $item.append($info, $controls);
            $c.append($item);
        });
    }

    // ---------------------------------------------------------
    // Clear Medication Entry Form - MODIFIED (Reset Button Text/State)
    // ---------------------------------------------------------
    function clearMedicationEntryForm($row) {
        $row.find('.medication-drug-input').val('').data('selectedMedData', null).attr('aria-activedescendant', '');
        $row.find('.medication-dosage-form').prop('selectedIndex', 0);
        $row.find('.sig-quantity').val('');
        $row.find('.sig-unit').empty().prop('disabled', true).append('<option>-- Select Form First --</option>');
        $row.find('.sig-frequency').prop('selectedIndex', 0);
        $row.find('.sig-additional').val('');
        $row.find('.validation-alert').hide().empty();
        editingMedBaseName = null; // Clear editing state
        $('#medicationEntryArea .add-current-med-button').text('Add Medication').css('background-color', ''); // Reset button appearance (remove green)
        $row.find('.medication-drug-input').focus();
    }

    // ---------------------------------------------------------
    // Add med / Update med - MODIFIED (Unified Logic & Payload Clarity)
    // ---------------------------------------------------------
    function addOrUpdateMedication(medData, $row) { // Renamed for clarity
        const $alert = $row.find('.validation-alert');
        if (!validateMedicationEntry(medData, $alert)) return false;

        // Build SIG string (logic unchanged)
        const { quantity, unit, frequency, additional } = medData.sig_structured;
        let action = "Take"; const formVal = $row.find('.medication-dosage-form').val() || ""; const fLower = formVal.toLowerCase();
        if (['apply','topical','cream','ointment','lotion','gel','patch'].some(t => fLower.includes(t))) action = "Apply";
        else if (['instill','drop'].some(t => fLower.includes(t))) action = "Instill";
        else if (['inhale','inhaler','spray'].some(t => fLower.includes(t))) action = "Use";
        else if (['inject','injection'].some(t => fLower.includes(t))) action = "Inject";
        else if (['insert','suppository'].some(t => fLower.includes(t))) action = "Insert";
        let sigParts = [action]; if (quantity) sigParts.push(quantity); if (unit) sigParts.push(unit); if (frequency && frequency !== 'other') sigParts.push(frequency);
        if (additional?.trim()) { if (frequency === 'other') sigParts.push(`(${additional.trim()})`); else sigParts.push(`(${additional.trim()})`); }
        else if (frequency === 'other') { sigParts.push('(as specified)'); }
        medData.sig_string = sigParts.join(' ').replace(/\s+/g, ' ').trim();

        medData.drug = medData.drug.trim(); // Use the value from the input field
        medData.dosageForm = formVal; // Store the selected form

        // Get data from selection OR handle manual entry/edit
        const selectedData = $row.find('.medication-drug-input').data('selectedMedData');
         if (selectedData) {
             // Data came from suggestion selection - use structured info
             medData.ingredients = selectedData.active_ingredients;
             medData.forms = selectedData.forms;
             medData.drug_code = selectedData.drug_code;
             medData.is_restricted = selectedData.is_restricted;
             // Overwrite medData.drug with the structured name from suggestion for consistency in payload
              let structuredName = '';
              if (Array.isArray(selectedData.active_ingredients) && selectedData.active_ingredients.length > 0) {
                  structuredName = selectedData.active_ingredients.map(ing => `${ing.name}${ing.strength ? ' ' + ing.strength + (ing.unit || '') : ''}`).join(' / ');
              } else { structuredName = selectedData.brand_name || selectedData.drug || medData.drug; } // Fallback
              const firstForm = (selectedData.forms || [])[0];
              if(firstForm) structuredName += ` (${firstForm})`;
              medData.drug = structuredName; // Use structured name
              console.log("Adding/Updating selected med:", medData.drug);

         } else {
             // Manual entry OR editing a manual entry
             // Keep medData.drug as the user-typed string
             const drugNameOnly = medData.drug.replace(/\s+\d+.*$/,'').trim(); // Basic parse attempt for ingredient name
             medData.ingredients = [{ name: drugNameOnly || medData.drug, strength: null, unit: null }]; // Basic ingredient structure
             medData.forms = []; // Cannot reliably determine form
             medData.drug_code = null;
             medData.is_restricted = false; // Assume not restricted
             console.log("Adding/Updating manual entry:", medData.drug);
         }

        // --- Handle ADD vs UPDATE ---
        if (editingMedBaseName) {
            // UPDATE: Remove all items matching the original base name
            console.log("Updating med, removing old entries for:", editingMedBaseName);
            currentMedications = currentMedications.filter(med => {
                let medBaseName = med.drug.replace(/\s+\d+(\.\d+)?\s*(mg|mcg|g|ml|%|unit[s]?|meq|iu)(?:\/\w+)?(\s*\(.*\))?$/i, '').replace(/\s+(tab|cap|soln|susp|syr|inj|oint|crm|lot|gel|inh)\.?$/i,'').trim();
                if (!medBaseName) medBaseName = med.drug;
                return medBaseName !== editingMedBaseName;
            });
            // State/button reset is handled by clearMedicationEntryForm
        }

        // ADD the new/updated medication
        currentMedications.push(medData);
        saveToHistory(medData); // Save this specific entry to history
        renderMedicationList();
        loadHistoryList(); // Refresh history buttons
        clearMedicationEntryForm($row); // Reset the form (also resets button text & editing state)
        return true;
    }

     // --- Helper to handle selecting a suggestion - Modified ---
     function selectSuggestion(medData, targetInput, nameToSet) {
         if (!medData || !targetInput || !targetInput.length) return;
         targetInput.val(nameToSet).trigger('change');
         targetInput.data('selectedMedData', medData);
         // Store the value we just set so we can detect manual changes later
         targetInput.data('_lastSetInputValue', nameToSet);
         autoSelectFormAndUnits(medData, targetInput);
         targetInput.closest('.medication-entry-row').find('.sig-quantity').focus();
         $('#medicationSuggestionBox').hide();
         targetInput.attr('aria-expanded', 'false').attr('aria-activedescendant', '');
     }


    // ---------------------------------------------------------
    // Autocomplete - MODIFIED (Blur handling, manual entry click)
    // ---------------------------------------------------------
    function attachMedAutocomplete($input) {
        if (compiledDrugData.length === 0 && !$input.prop('disabled')) {
           console.warn("Autocomplete attachment skipped: Data not loaded."); return;
        }
        const $box = $('#medicationSuggestionBox'); const inputId = $input.attr('id');
        let suggestions = [], dataArr = [], idx = -1, debounce;
        let boxHasMouse = false; // Flag for blur handling

        $box.on('mouseenter', function() { boxHasMouse = true; }).on('mouseleave', function() { boxHasMouse = false; });

        function positionBox() { const inputRect = $input[0].getBoundingClientRect(); const scrollTop = $(window).scrollTop(); const scrollLeft = $(window).scrollLeft(); const inputWidth = $input.outerWidth(); $box.css({ top: (inputRect.bottom + scrollTop) + "px", left: (inputRect.left + scrollLeft) + "px", minWidth: inputWidth + "px" }).show(); $input.attr('aria-expanded', 'true'); }

        // --- Displays the suggestion list (with ARIA) --- (Unchanged from previous full script)
        function displaySuggestions(results) {
            $box.empty(); suggestions = []; dataArr = []; idx = -1; $input.attr('aria-activedescendant', '');
            if (!results || results.length === 0) { $box.html('<div class="no-results" role="option">No eligible meds found.</div>'); positionBox(); return; }
            function normalizeStrength(strength, unit) { if (strength === undefined || strength === null) return ''; let strVal = String(strength).trim(); if (strVal.startsWith('.')) strVal = '0' + strVal; const numVal = parseFloat(strVal); return isNaN(numVal) ? strVal : numVal + (unit || ''); }
            const map = new Map();
            results.forEach(item => {
                const ingKey = (item.active_ingredients || []).map(ing => `${ing.name.toLowerCase()}:${normalizeStrength(ing.strength, ing.unit)}`).sort().join('|');
                const firstForm = ((item.forms || [])[0] || '').toLowerCase(); const key = `${ingKey}::${firstForm}`;
                if (!map.has(key)) {
                    const allBrandsForCombo = results.filter(fItem => { const fIngKey = (fItem.active_ingredients || []).map(ing => `${ing.name.toLowerCase()}:${normalizeStrength(ing.strength, ing.unit)}`).sort().join('|'); const fFirstForm = ((fItem.forms || [])[0] || '').toLowerCase(); return `${fIngKey}::${fFirstForm}` === key; }).map(fItem => fItem.brand_name).filter(brand => brand && brand.trim() !== '');
                     if (allBrandsForCombo.length === 0 && Array.isArray(item.active_ingredients) && item.active_ingredients.length > 0) { const genericNameAsBrand = item.active_ingredients.map(ing => ing.name).join(' / '); if (genericNameAsBrand && !allBrandsForCombo.includes(genericNameAsBrand)) { allBrandsForCombo.push(genericNameAsBrand); } }
                    map.set(key, { representativeItem: item, brands: [...new Set(allBrandsForCombo)] });
                }
            });
            const list = Array.from(map.values()).slice(0, MAX_SUGGESTIONS);
            list.forEach((group, i) => {
                const item = group.representativeItem; const brands = group.brands; let mainText = '';
                if (Array.isArray(item.active_ingredients) && item.active_ingredients.length > 0) { mainText = item.active_ingredients.map(ing => `${ing.name}${ing.strength ? ' ' + ing.strength + (ing.unit || '') : ''}`).join(' / '); } else { mainText = item.brand_name || item.drug || 'Unknown'; } // Added brand_name as fallback
                const firstForm = (item.forms || [])[0]; if (firstForm) mainText += ` (${firstForm})`;
                const suggestionId = `${inputId}-suggestion-${i}`;
                const $opt = $('<div class="suggestion-item" role="option">').attr('id', suggestionId).data('medData', item).data('allBrands', brands);
                const isCombo = (item.active_ingredients || []).length > 1; if (isCombo) $opt.addClass('combination-medication');
                const $nameSpan = $('<span class="suggestion-med-name">').text(mainText); if (isCombo) $nameSpan.append($('<span class="combo-badge">').text('Combo')); // Use specific class from CSS
                if (item.is_restricted) $nameSpan.append($('<span class="restricted-badge">').text('Restricted'));
                $opt.append($nameSpan);
                 if (brands.length > 0) {
                     const displayableBrands = brands.filter(b => b !== mainText); const limitedBrands = displayableBrands.slice(0, MAX_BRANDS_DISPLAY);
                     if (limitedBrands.length > 0) { let brandHtml = 'Brands: ' + limitedBrands.join(', '); if (displayableBrands.length > MAX_BRANDS_DISPLAY) { brandHtml += `<span class="more-brands-link" data-group-index="${i}">(+${displayableBrands.length - MAX_BRANDS_DISPLAY} more)</span>`; } $opt.append($('<span class="suggestion-brands">').html(brandHtml)); }
                 }
                $opt.on('mousedown', (ev) => { if ($(ev.target).hasClass('more-brands-link')) return; ev.preventDefault(); boxHasMouse = true; selectSuggestion($(ev.currentTarget).data('medData'), $input, mainText); setTimeout(()=>{boxHasMouse = false;}, 100); }); // Prevent blur, set flag
                $opt.on('mouseenter', () => { $box.find('.suggestion-item').removeClass('selected').attr('aria-selected', 'false'); $opt.addClass('selected').attr('aria-selected', 'true'); idx = $box.find('.suggestion-item:not(.additional-brand-item)').index($opt); $input.attr('aria-activedescendant', suggestionId); });
                $box.append($opt); suggestions.push($opt); dataArr.push(item);
            });
            $box.append('<div class="suggestion-item manual-entry" role="option" id="' + inputId + '-manual-entry">Can\'t find it? <strong>Enter manually</strong></div>');
            positionBox();
        }

        // --- 'More Brands' Mousedown Handler - MODIFIED (blur flag) ----
        $(document).off('mousedown.morebrands').on('mousedown.morebrands', '.more-brands-link', function(e) {
             e.preventDefault(); e.stopPropagation(); boxHasMouse = true; // <<< Set Flag
             const $link = $(this); const $currentItem = $link.closest('.suggestion-item'); const allBrands = $currentItem.data('allBrands'); const medData = $currentItem.data('medData');
             let $additionalContainer = $currentItem.next('.additional-brands-container');
             if ($additionalContainer.length) {
                $additionalContainer.slideToggle(150, function() { if (!$additionalContainer.is(':visible')) boxHasMouse = false; }); // <<< Reset Flag if closing
                return;
             }
             $additionalContainer = $('<div class="additional-brands-container">').hide().insertAfter($currentItem);
             const mainText = $currentItem.find('.suggestion-med-name').text(); const displayableBrands = allBrands.filter(b => b !== mainText); const additionalBrands = displayableBrands.slice(MAX_BRANDS_DISPLAY);
             if (additionalBrands.length == 0) { $additionalContainer.remove(); boxHasMouse = false; return; } // <<< Reset Flag if nothing shown

             additionalBrands.forEach(brand => {
                  let brandDisplayName = brand; let mainNameForDisplay = 'Unknown Generic';
                  if (medData && Array.isArray(medData.active_ingredients) && medData.active_ingredients.length > 0) { mainNameForDisplay = medData.active_ingredients.map(ing => ing.name).join(' / '); }
                  const $brandItem = $('<div class="suggestion-item additional-brand-item" role="option">'); // Role added
                  $brandItem.data('medData', medData).data('brandName', brand)
                           .append($('<span class="suggestion-brands">').text(brandDisplayName))
                           .append($('<span class="suggestion-med-name" style="font-style: italic; color: #555;">').text(mainNameForDisplay));
                  if (medData && medData.is_restricted) { $brandItem.find('.suggestion-brands').append($('<span class="restricted-badge">').text('Restricted')); }
                  $brandItem.on('mousedown', function(evt) { // <<< Mousedown for brand item selection
                      evt.preventDefault(); evt.stopPropagation(); boxHasMouse = true; // Keep flag
                      const brandToSet = $(this).data('brandName'); const itemData = $(this).data('medData');
                      let inputBrandName = brandToSet; const firstForm = (itemData.forms || [])[0]; if (firstForm) inputBrandName += ` (${firstForm})`;
                      selectSuggestion(itemData, $input, inputBrandName); // This hides the box
                      setTimeout(() => { boxHasMouse = false; }, 100); // <<< Reset flag after selection
                  });
                 $additionalContainer.append($brandItem);
             });
             $link.parent().slideUp(100);
             $additionalContainer.slideDown(200); // Let mouseleave on the main box handle flag reset eventually
        });

         // --- FindMatching Function (Unchanged) ---
         function findMatching(query) { const terms = query.toLowerCase().split(/\s+/).filter(Boolean); if (terms.length === 0) { displaySuggestions([]); return; } console.time("Filtering Time"); const eligibleDrugs = compiledDrugData.filter(item => item.is_restricted !== true); const results = eligibleDrugs.filter(item => { if (!item._search_string) { const ingredientsText = (item.active_ingredients || []).map(ing => ing.name).join(' ').toLowerCase(); const formsText = (item.forms || []).join(' ').toLowerCase(); item._search_string = `${item.brand_name || ''} ${ingredientsText} ${formsText}`.toLowerCase(); } return terms.every(term => item._search_string.includes(term)); }); console.timeEnd("Filtering Time"); const limitedResults = results.slice(0, 50); displaySuggestions(limitedResults); }

        // --- Input field event handlers ---
        $input.on('input', () => { clearTimeout(debounce); const value = $input.val().trim(); const selectedData = $input.data('selectedMedData'); const currentDisplayValue = $input.val(); const lastSetValue = $input.data('_lastSetInputValue'); if (selectedData && currentDisplayValue !== lastSetValue) { $input.data('selectedMedData', null); $input.removeData('_lastSetInputValue'); console.log("Input changed post-select, clearing data."); } if (value.length < 3) { $box.hide(); $input.attr('aria-expanded', 'false').attr('aria-activedescendant', ''); return; } debounce = setTimeout(() => findMatching(value), 150); });

        // --- Keydown handler with ARIA (Complete)---
        $input.on('keydown', (e) => {
            if (!$box.is(':visible')) return;
            const $items = $box.find('.suggestion-item:not(.additional-brand-item)'); // Get selectable items
            if ($items.length === 0) return;

            if (['ArrowDown', 'ArrowUp', 'Enter', 'Escape', 'Tab'].includes(e.key)) {
                e.preventDefault(); // Prevent default browser action for these keys

                if (e.key === 'Escape' || e.key === 'Tab') {
                    $box.hide();
                    $input.attr('aria-expanded', 'false').attr('aria-activedescendant', '');
                    return;
                }

                if (e.key === 'Enter') {
                    const $selectedItem = $items.filter('.selected');
                    if ($selectedItem.length) {
                        if ($selectedItem.hasClass('manual-entry')) {
                            // Trigger the mousedown handler for manual entry
                            $('.manual-entry').trigger('mousedown');
                        } else {
                            // Trigger the mousedown handler for regular suggestions
                            $selectedItem.trigger('mousedown');
                        }
                    }
                    // Box hiding is handled by the mousedown/selectSuggestion handlers now
                    return; // Let the mousedown handlers manage hiding
                }

                // Arrow navigation
                let currentIdx = $items.index($items.filter('.selected'));
                let newIdx = currentIdx;
                if (e.key === 'ArrowDown') newIdx = (currentIdx + 1) % $items.length;
                else if (e.key === 'ArrowUp') newIdx = (currentIdx - 1 + $items.length) % $items.length;

                if (newIdx !== currentIdx) {
                    $items.removeClass('selected').attr('aria-selected', 'false');
                    const $newItem = $($items[newIdx]);
                    $newItem.addClass('selected').attr('aria-selected', 'true');
                    const newItemId = $newItem.attr('id');
                    if (newItemId) $input.attr('aria-activedescendant', newItemId); // Update active descendant

                    // Scroll into view if needed
                    const boxNode = $box[0];
                    const itemNode = $newItem[0];
                    if (itemNode.offsetTop < boxNode.scrollTop || itemNode.offsetTop + itemNode.offsetHeight > boxNode.scrollTop + boxNode.clientHeight) {
                        itemNode.scrollIntoView({ block: 'nearest', inline: 'nearest' });
                    }
                    idx = newIdx; // Update internal index tracker
                }
            }
        }); // End keydown handler

        // --- Focus/Blur handlers - MODIFIED (blur logic uses flag) ---
        $input.on('focus', () => {
            $('.medication-drug-input').data('has-focus', false);
            $input.data('has-focus', true);
            const value = $input.val().trim();
             if (value.length >= 3) {
                  if (!$box.is(':visible')) { // Only find if box isn't already shown
                     findMatching(value);
                  }
             }
        });
        $input.on('blur', () => {
             // Use flag set by mouseenter/mouseleave on box and mousedown on items
            setTimeout(() => {
                 const activeElement = document.activeElement;
                 // Hide if mouse is not over box AND focus is not on input AND focus is not within the box
                 if (!boxHasMouse && activeElement !== $input[0] && !$box[0].contains(activeElement)) {
                     $box.hide();
                     $input.attr('aria-expanded', 'false');
                 }
                // Always clear has-focus if blurred away from input
                 if (activeElement !== $input[0]) { $input.data('has-focus', false); }
            }, 300); // Slightly longer delay to allow click/mousedown events to register flags
        });

        // --- Manual Entry click - MODIFIED (no prompt)---
        $(document).off('mousedown.manualentry').on('mousedown.manualentry', '.manual-entry', function(e) {
            e.preventDefault(); e.stopPropagation(); boxHasMouse = true; // Prevent blur hide
            $box.hide(); $input.attr('aria-expanded', 'false').attr('aria-activedescendant', '');
            $input.focus(); // Ensure focus is on the main input
            $input.data('selectedMedData', null); // Clear selection data
            console.log("Manual entry selected. Type full name in the medication field.");
            setTimeout(() => { boxHasMouse = false; }, 100); // Reset flag after handled
         });

    } // End of attachMedAutocomplete

    // ---------------------------------------------------------
    // Keyboard Nav within Form Row (Unchanged)
    // ---------------------------------------------------------
    function setupKeyboardNavigation() {
           $('#medicationEntryArea').on('keydown', '.medication-drug-input, .medication-dosage-form, .sig-quantity, .sig-unit, .sig-frequency, .sig-additional, .add-current-med-button', function(e) {
                if (!['ArrowRight', 'ArrowLeft', 'Enter'].includes(e.key)) return;
                if ($(this).hasClass('medication-drug-input') && $('#medicationSuggestionBox').is(':visible')) { if (e.key === 'Enter') return; if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') { e.preventDefault(); return; } }
               const $row = $(this).closest('.medication-entry-row');
               const fields = [ $row.find('.medication-drug-input'), $row.find('.medication-dosage-form'), $row.find('.sig-quantity'), $row.find('.sig-unit'), $row.find('.sig-frequency'), $row.find('.sig-additional'), $row.find('.add-current-med-button') ];
               const currentIndex = fields.findIndex($el => $el.is(this)); let targetIndex = -1;
               if (e.key === 'ArrowRight') { if (currentIndex < fields.length - 1) { e.preventDefault(); for (let i = currentIndex + 1; i < fields.length; i++) { if (fields[i].length && fields[i].is(':visible') && !fields[i].prop('disabled')) { targetIndex = i; break; } } } }
               else if (e.key === 'ArrowLeft') { if (currentIndex > 0) { e.preventDefault(); for (let i = currentIndex - 1; i >= 0; i--) { if (fields[i].length && fields[i].is(':visible') && !fields[i].prop('disabled')) { targetIndex = i; break; } } } }
               else if (e.key === 'Enter') {
                    if ($(this).is('.add-current-med-button')) return; // Allow default button action
                     if ($(this).is('.sig-frequency, .sig-additional')) { e.preventDefault(); $row.find('.add-current-med-button').trigger('click'); return; } // Trigger add/update
                     // Optional: Move to next field from text inputs on Enter
                     if ($(this).is('input[type="text"], input[type="number"]') && currentIndex < fields.length -1) { e.preventDefault(); for (let i = currentIndex + 1; i < fields.length; i++) { if (fields[i].length && fields[i].is(':visible') && !fields[i].prop('disabled')) { targetIndex = i; break; } } }
               }
               if (targetIndex !== -1 && targetIndex < fields.length) { fields[targetIndex].focus().select(); }
           });
      }


    // ---------------------------------------------------------
    // Document Ready - Main Initialization - MODIFIED (Event Handlers)
    // ---------------------------------------------------------
    $(document).ready(() => {
        setupKeyboardNavigation();
        $('#dob').on('change', function() { /* ... Age calc + loadHistoryList ... */
             const dob = new Date(this.value); const today = new Date();
             if (!isNaN(dob) && dob < today) { let age = today.getFullYear() - dob.getFullYear(); const m = today.getMonth() - dob.getMonth(); if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) age--; $('#age').val(age >= 0 ? age : ''); } else { $('#age').val(''); }
             loadHistoryList();
         }).trigger('change');

        loadCompiledDrugData()
            .then(data => {
                compiledDrugData = data;
                if (compiledDrugData.length > 0) { attachMedAutocomplete($('#medicationDrugField_0')); }
                else { console.error("Autocomplete not attached: Data empty/load failed."); }
            })
            .catch(error => { console.error("Critical error during data loading sequence:", error); $('#errorMessage').text('Critical setup error. Please refresh.').show(); $('.medication-drug-input').prop('disabled', true).attr('placeholder', 'Setup Error'); });

        $('#medicationEntryArea').on('change', '.medication-dosage-form', function() { populateUnitOptions($(this)); const $row = $(this).closest('.medication-entry-row'); $row.find('.sig-unit').prop('selectedIndex', 0); setDefaultUnit($row, $(this).val()?.toLowerCase()); });

        // MODIFIED: Add/Update button click delegates to unified function
        $('#medicationEntryArea').on('click', '.add-current-med-button', function() {
            const $row = $(this).closest('.medication-entry-row');
            const medData = {
                drug: $row.find('.medication-drug-input').val(),
                // dosageForm is set within addOrUpdateMedication from dropdown
                sig_structured: { quantity: $row.find('.sig-quantity').val(), unit: $row.find('.sig-unit').val(), frequency: $row.find('.sig-frequency').val(), additional: $row.find('.sig-additional').val() }
                // selectedData (if from suggestion) is retrieved inside addOrUpdateMedication
            };
            addOrUpdateMedication(medData, $row); // Call the unified Add/Update function
        });

        // MODIFIED: Form submission handles editing state
        $('#patientForm').on('submit', e => {
            e.preventDefault();
            if (!$('#firstName').val().trim() || !$('#lastName').val().trim() || !$('#dob').val()) { alert("Please fill patient info."); $('#firstName, #lastName, #dob').filter((_, el) => !$.trim(el.value)).first().focus(); return; }
            // Check if currently editing - prompt user
            if (editingMedBaseName) {
                if(!confirm("You are currently editing '" + editingMedBaseName + "'. Submit the request without saving the update?")) {
                     $('#medicationRow_0 .add-current-med-button').focus(); // Focus Update button
                     return; // Stop submission
                }
                // If user confirms to submit *without* saving, cancel the edit state
                editingMedBaseName = null;
                $('#medicationEntryArea .add-current-med-button').text('Add Medication').css('background-color', '');
            }
            // Check if list is empty
            if (currentMedications.length === 0) { alert("Please add at least one medication."); $('#medicationDrugField_0').focus(); return; }
            // Check for unsaved data in entry row (ignore if editing, as that case was handled above)
            const $row = $('#medicationRow_0');
            const drugInput = $.trim($row.find('.medication-drug-input').val()); const qtyInput = $.trim($row.find('.sig-quantity').val()); const unitSel = $row.find('.sig-unit').val(); const freqSel = $row.find('.sig-frequency').val(); const addInput = $.trim($row.find('.sig-additional').val());
             if (!editingMedBaseName && (drugInput || qtyInput || unitSel || freqSel || addInput)) {
                  if(!confirm("The current medication entry fields have unsaved data. Submit request anyway?")) {
                      $row.find('.add-current-med-button').focus(); // Focus Add button
                      return; // Stop submission
                  }
             }

            // Build payload (structure remains the same)
            const payload = { firstName: $('#firstName').val().trim(), lastName: $('#lastName').val().trim(), dob: $('#dob').val(), age: $('#age').val(), medications: currentMedications, requestTimestamp: new Date().toISOString() };
            // --- SIMULATE SUBMISSION ---
            console.log("Submitting Payload:", JSON.stringify(payload, null, 2)); // LOG PAYLOAD
            savePreviousRequest();
            $('#successMessage').text(`Request for ${payload.firstName} ${payload.lastName} submitted.`).fadeIn().delay(4000).fadeOut();
            // --- END SIMULATION ---
            currentMedications = []; // Clear internal list
            renderMedicationList(); // Update UI list
            clearMedicationEntryForm($('#medicationRow_0')); // Clears form and resets edit state
            loadHistoryList(); // Refresh history section
            $('#firstName').focus(); // Focus back to start
        });

        // --- Other initial setup ---
        $('#firstName, #lastName').on('change', loadHistoryList); // DOB change also calls it
        renderMedicationList(); // Initial render (likely empty)
        loadHistoryList(); // Load history if patient info pre-filled
        $('#firstName').focus(); // Focus on first name initially
    }); // End document ready

    })(jQuery); // End IIFE
</script>
</body>
</html>
