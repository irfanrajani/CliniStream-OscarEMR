<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Patient & Medication Entry</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        /* --- Core Styles --- */
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        h1, h2 { color: #333; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 800px; margin: auto; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input[type="text"], input[type="date"], input[type="number"], select, button { padding: 10px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; width: 100%; }
        button { cursor: pointer; background-color: #007bff; color: white; border: none; margin-top: 10px; }
        button:hover { background-color: #0056b3; }
        input[readonly] { background-color: #e9ecef; cursor: not-allowed; }
        hr { border: 0; height: 1px; background-color: #ddd; margin: 25px 0; }
        .medication-entry-row { border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; background-color: #f9f9f9; border-radius: 5px; }
        .medication-fields-grid { display: grid; grid-template-columns: 3fr 2fr; gap: 20px; margin-bottom: 15px; }
        .sig-structured-area { border-top: 1px dashed #ccc; margin-top: 15px; padding-top: 15px; }
        .sig-structured-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; align-items: end; margin-bottom: 10px; }
        .sig-structured-grid label { margin-bottom: 3px; font-size: 0.9em; }
        .sig-structured-grid input[type="number"] { max-width: 100px; } /* Existing max-width */
        .sig-additional-info { margin-top: 10px; }

        /* --- Suggestion Box --- */
        .suggestion-box { position: absolute; background: #fff; border: 1px solid #aaa; z-index: 9999; max-height: 300px; overflow-y: auto; min-width: 300px; max-width: 500px; display: none; border-radius: 4px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); font-family: sans-serif; font-size: 14px; }
        .suggestion-item { padding: 6px 12px; cursor: pointer; border-bottom: 1px solid #eee; line-height: 1.4; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover, .suggestion-item.selected { background-color: #e9ecef; }
        .suggestion-item.selected { background-color: #007bff; color: white; }
        .suggestion-item.selected .suggestion-brands { color: #eee; } /* Ensure contrast for selected brands */
        .suggestion-med-name { display: block; font-weight: 500; white-space: normal; word-wrap: break-word; }
        .suggestion-brands { display: block; font-size: 0.9em; color: #555; font-style: italic; padding-left: 5px; margin-top: 2px; white-space: normal; word-wrap: break-word; }
        .suggestion-brands .more-brands-link { cursor: pointer; text-decoration: underline; color: #0056b3; margin-left: 5px; font-weight: normal; font-style: normal; }
        .suggestion-box .no-results { padding: 8px 12px; color:#666; font-style: italic; cursor: default; }
        .suggestion-item.manual-entry { border-top: 1px dashed #ccc; font-style: italic; }
        .suggestion-item.manual-entry strong { color: #0056b3; font-style: normal; }
        .suggestion-item.manual-entry:hover { background-color: #e9ecef; }

        /* --- Medication List Styling --- */
        #medicationsListContainer { margin-top: 20px; border-top: 2px solid #007bff; padding-top: 15px; }
        .added-medication-item { border: 1px solid #ddd; /* Default border */ padding: 10px 15px; margin-bottom: 8px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
        /* ** UPDATED/VERIFIED ** Color coding for single vs combo */
        .added-medication-item.single-med { background-color: #e6f7ff; border-color: #b3e0ff;}
        .added-medication-item.combination-med { background-color: #fff3cd; border-color: #ffeeba;}
        /* Explicit span for text to separate from badge */
        .added-medication-item span.med-display-text { flex-grow: 1; margin-right: 10px; word-break: break-word; }
        .added-medication-item button { padding: 4px 8px; font-size: 12px; background-color: #dc3545; width: auto; margin-top: 0; flex-shrink: 0; }
        .added-medication-item button:hover { background-color: #c82333; }
        /* ** UPDATED/VERIFIED ** Combo Badge Style */
        .badge.combo { display: inline-block; background: #ffc107; color: #212529; padding: 2px 6px; margin-right: 8px; font-size: 0.75em; border-radius: 3px; vertical-align: middle; flex-shrink: 0; /* Prevent badge from shrinking */ }

        /* --- Messages --- */
        #loadingMessage, #errorMessage { padding: 15px; border-radius: 4px; margin-bottom: 20px; text-align: center; display: none; }
        #loadingMessage { background-color: #ffc107; border: 1px solid #dda700; }
        #errorMessage { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }

        /* --- History Area Styling --- */
        #historyContainer { margin-bottom: 20px; padding: 10px; background-color: #e9ecef; border-radius: 4px; border: 1px solid #ced4da; }
        #historyContainer h3 { margin-top: 0; margin-bottom: 8px; font-size: 1em; color: #333; font-weight: bold; }
        #historyContainer .history-buttons-wrapper { display: flex; flex-wrap: wrap; gap: 5px; }
        #historyContainer .history-btn { padding: 5px 10px; font-size: 0.9em; background-color: #6c757d; color: white; width: auto; margin-top: 0; border: none; border-radius: 4px; cursor: pointer; }
        #historyContainer .history-btn:hover { background-color: #5a6268; }
        #historyContainer .no-history { font-style: italic; color: #666; margin-top: 5px; display: block;}

    </style>
</head>
<body>
<div class="container">
    <!-- Loading/Error Message Area -->
    <div id="loadingMessage">Loading drug data... Please wait.</div>
    <div id="errorMessage">Error loading drug data. Autocomplete disabled. See console.</div>

    <h1>Patient Demographics</h1>
    <form id="patientForm">
        <div class="form-group">
            <label for="firstName">First Name:</label>
            <input type="text" id="firstName" name="firstName">
        </div>
        <div class="form-group">
            <label for="lastName">Last Name:</label>
            <input type="text" id="lastName" name="lastName">
        </div>
        <div class="form-group">
            <label for="dob">Date of Birth:</label>
            <input type="date" id="dob" name="dob">
        </div>
        <div class="form-group">
            <label for="age">Age:</label>
            <input type="number" id="age" name="age" readonly>
        </div>

        <h2>Medication Entry</h2>

        <!-- Recently Used History Area -->
        <div id="historyContainer">
             <h3>Your Recently Used Medications (This Browser Only)</h3> <!-- Clarified scope -->
             <div class="history-buttons-wrapper">
                  <!-- Buttons will be added here by loadHistoryList() -->
             </div>
             <span class="no-history" style="display: none;">No recently used medications found for this patient in this browser.</span>
        </div>

        <div id="medicationEntryArea">
            <div class="medication-entry-row" id="medicationRow_0">
                <div class="medication-fields-grid">
                    <div style="position: relative;">
                        <label for="medicationDrugField_0">Medication:</label>
                        <input type="text" id="medicationDrugField_0" name="medicationDrugField"
                               class="medication-drug-input" autocomplete="off"
                               placeholder="Loading drug data..." disabled>
                    </div>
                    <div style="position: relative;">
                        <label for="medicationDosageForm_0">Dosage Form:</label>
                        <select id="medicationDosageForm_0" name="medicationDosageForm"
                                class="medication-dosage-form">
                            <option value="" disabled selected>-- Select Form --</option>
                            <option value="tablet">Tablet</option>
                            <option value="capsule">Capsule</option>
                            <option value="liquid">Liquid/Syrup</option>
                            <option value="suspension">Suspension</option>
                            <option value="injection">Injection (SC/IM/IV)</option>
                            <option value="inhaler">Inhaler</option>
                            <option value="topical">Topical Cream/Ointment/Gel</option>
                            <option value="patch">Patch</option>
                            <option value="suppository">Suppository</option>
                            <option value="eye drop">Eye Drop</option>
                            <option value="ear drop">Ear Drop</option>
                            <option value="nasal spray">Nasal Spray</option>
                        </select>
                    </div>
                </div>
                <div class="sig-structured-area">
                    <label style="font-weight: normal; margin-bottom: 10px; display: block;">
                        Directions / SIG:
                    </label>
                    <div class="sig-structured-grid">
                        <div>
                            <label for="sigQuantity_0">Quantity</label>
                            <input type="number" id="sigQuantity_0" class="sig-quantity"
                                   min="0" step="any" placeholder="e.g., 1">
                        </div>
                        <div>
                            <label for="sigUnit_0">Unit</label>
                            <select id="sigUnit_0" class="sig-unit" disabled>
                                <option value="">-- Select Form First --</option>
                            </select>
                        </div>
                        <div>
                            <label for="sigFrequency_0">Frequency</label>
                            <select id="sigFrequency_0" class="sig-frequency">
                                <option value="" disabled selected>-- Select --</option>
                                <option value="once daily">Once daily (QD)</option>
                                <option value="twice daily">Twice daily (BID)</option>
                                <option value="three times daily">Three times daily (TID)</option>
                                <option value="four times daily">Four times daily (QID)</option>
                                <option value="every morning">Every morning (QAM)</option>
                                <option value="every evening">Every evening (QPM)</option>
                                <option value="at bedtime">At bedtime (QHS)</option>
                                <option value="every 4 hours">Every 4 hours</option>
                                <option value="every 6 hours">Every 6 hours</option>
                                <option value="every 8 hours">Every 8 hours</option>
                                <option value="every 12 hours">Every 12 hours</option>
                                <option value="every other day">Every other day</option>
                                <option value="once weekly">Once weekly</option>
                                <option value="as needed">As needed (PRN)</option>
                                <option value="other">Other (Specify Below)</option>
                            </select>
                        </div>
                    </div>
                    <div class="sig-additional-info">
                        <label for="sigAdditional_0">Additional Info / Frequency Detail</label>
                        <input type="text" id="sigAdditional_0" class="sig-additional"
                               placeholder="e.g., for pain, with food, for 7 days, or specify 'Other'">
                    </div>
                </div>
                <button type="button" class="add-current-med-button">
                    Add This Medication to List
                </button>
            </div>
             <div class="suggestion-box" id="medicationSuggestionBox"></div>
        </div>

        <h2>Current Medication List</h2>
        <div id="medicationsListContainer">
            <p>No medications added yet.</p>
        </div>
        <hr>
        <button type="submit">Submit Patient Data & Medications</button>
    </form>

</div><!-- /.container -->

<script>
    // ======================================================================
    //                    Configuration & Globals
    // ======================================================================
    const COMPILED_DATA_URL = 'compiled_drug_data.json';
    const MAX_SUGGESTIONS = 10;
    const MAX_BRANDS_DISPLAY = 3;
    let compiledDrugData = [];
    let currentMedications = [];
    const dosageFormUnits = {
        tablet: ['tablet(s)'], capsule: ['capsule(s)'], liquid: ['mL','tsp (5mL)','tbsp (15mL)'],
        suspension: ['mL','tsp (5mL)','tbsp (15mL)'], injection: ['mL','unit(s)'], inhaler: ['puff(s)','inhalation(s)'],
        topical: ['application(s)','gram(s)'], patch: ['patch(es)'], suppository: ['suppository(ies)'],
        'eye drop': ['drop(s) in eye(s)','drop(s) in left eye','drop(s) in right eye'],
        'ear drop': ['drop(s) in ear(s)','drop(s) in left ear','drop(s) in right ear'],
        'nasal spray': ['spray(s) in nostril(s)','spray(s) in left nostril','spray(s) in right nostril']
    };
    let currentSelectionData = null; // ** NEW: Store data of the selected suggestion temporarily


    // ======================================================================
    //                    History (Recently Used - LocalStorage)
    // ======================================================================
    function getHistoryKey() {
        const first = $('#firstName').val().trim().toLowerCase() || 'anon';
        const dob = $('#dob').val() || 'nodob';
        const normalizedFirst = first.replace(/[^a-z0-9]/g, '');
        return `medHistory_v2:${normalizedFirst}_${dob}`; // Added v2 to key namespace if structure changes
    }

    function saveToHistory(medicationObject) { // Accept the whole object
        const key = getHistoryKey();
        let history = JSON.parse(localStorage.getItem(key) || '[]');
        // Use a simplified object for history storage
        const historyEntry = {
             drug: medicationObject.drug,
             dosageForm: medicationObject.dosageForm,
             // Store structured SIG, ingredients, and manual flag if needed for pre-fill
             sig: medicationObject.sig_structured,
             ingredients: medicationObject.ingredients, // Store ingredients
             manualEntry: medicationObject.manualEntry
         };

        // Prevent duplicates based on drug name AND form (simple check)
        history = history.filter(item =>
            !(item.drug.toLowerCase() === historyEntry.drug.toLowerCase() &&
              item.dosageForm === historyEntry.dosageForm)
        );
        history.unshift(historyEntry);
        history = history.slice(0, 10);
        localStorage.setItem(key, JSON.stringify(history));
    }

    function loadHistoryList() {
        const key = getHistoryKey();
        const history = JSON.parse(localStorage.getItem(key) || '[]');
        const $container = $('#historyContainer');
        const $buttonWrapper = $container.find('.history-buttons-wrapper').empty();
        const $noHistory = $container.find('.no-history');

        if (!history.length) {
             $noHistory.show();
             $buttonWrapper.hide();
             $container.find('h3').hide(); // Hide header if no history
             return;
         }

        $noHistory.hide();
        $buttonWrapper.show();
        $container.find('h3').show(); // Show header

        history.forEach(entry => {
            const $btn = $('<button type="button" class="history-btn">').text(entry.drug);
            $btn.on('click', () => {
                const $row = $('#medicationRow_0');
                $row.find('.medication-drug-input').val(entry.drug)
                    .data('selectedIngredients', entry.ingredients || null)  // ** Restore ingredients data **
                    .data('manualEntry', entry.manualEntry || false); // Restore manual flag

                $row.find('.medication-dosage-form').val(entry.dosageForm);
                populateUnitOptions($row.find('.medication-dosage-form'));

                if (entry.sig) { // Check if sig data exists in history entry
                    $row.find('.sig-quantity').val(entry.sig.quantity);
                    $row.find('.sig-unit').val(entry.sig.unit);
                    $row.find('.sig-frequency').val(entry.sig.frequency);
                    $row.find('.sig-additional').val(entry.sig.additional);
                } else { // Clear SIG if not in history
                    $row.find('.sig-quantity, .sig-additional').val('');
                    $row.find('.sig-unit').prop('selectedIndex', 0); // Reset unit to placeholder
                    $row.find('.sig-frequency').prop('selectedIndex', 0); // Reset freq to placeholder
                }
                $row.find('.medication-drug-input').focus();
                 $('#medicationSuggestionBox').hide().empty();
                 currentSelectionData = null; // Clear temporary selection data
            });
            $buttonWrapper.append($btn);
        });
    }


    // ======================================================================
    //                    UI Interaction Functions
    // ======================================================================
    function populateUnitOptions($dosageSelect) {
        const selectedForm = $dosageSelect.val();
        const $row = $dosageSelect.closest('.medication-entry-row');
        const $unitSelect = $row.find('.sig-unit');
        const currentUnitValue = $unitSelect.val();

        $unitSelect.empty().prop('disabled', true);

        if (selectedForm && dosageFormUnits[selectedForm]) {
            $unitSelect.append('<option value="" disabled selected>-- Select Unit --</option>');
            dosageFormUnits[selectedForm].forEach(unit => {
                $unitSelect.append($('<option>').val(unit).text(unit));
            });
            $unitSelect.prop('disabled', false);

            if (currentUnitValue && dosageFormUnits[selectedForm].includes(currentUnitValue)) {
                 $unitSelect.val(currentUnitValue);
            } else {
                 const firstUnit = $unitSelect.find('option').not(':disabled').eq(0).val(); // Select the *actual* first unit
                 if(firstUnit){ $unitSelect.val(firstUnit); } // Make sure it exists before setting
             }
        } else {
            $unitSelect.append('<option value="">-- Select Form First --</option>');
        }
    }

    function attachMedAutocomplete($input) {
        if (!$input.length) return console.error("Input element not found for autocomplete.");
        if (!compiledDrugData || compiledDrugData.length === 0) {
             console.warn("Autocomplete attached, but drug data is not ready."); return;
         }
        const $box = $('#medicationSuggestionBox');
        let debounceTimer, suggestions = [], currentIndex = -1;

        function positionBox() { /* ... position logic ... */
           const inputRect = $input[0].getBoundingClientRect(), scrollTop = $(window).scrollTop(), scrollLeft = $(window).scrollLeft();
           $box.css({ top: (inputRect.bottom + scrollTop) + "px", left: (inputRect.left + scrollLeft) + "px", minWidth: $input.outerWidth() + "px", display: 'block'}); }
        function displaySuggestions(results) { /* ... display logic ... */
           $box.empty().hide(); suggestions = []; currentIndex = -1; currentSelectionData = null; // Clear temp data
           const nonRestricted = results.filter(item => !(item.availability && item.availability.is_restricted));
           if (nonRestricted.length === 0) { $box.html('<div class="no-results">No matching medications found.</div>'); positionBox(); return; }
           const groupedResults = new Map();
           nonRestricted.forEach(item => {
               const ingredientsKey = (item.ingredients || []).sort().join('|'); const strengthKey = item.strength || ''; const formKey = item.dosage_form || '';
               const key = `${ingredientsKey}|${strengthKey}|${formKey}`; const brandName = (item.brand_name || '').trim();
               if (!groupedResults.has(key)) { groupedResults.set(key, { primary: item, brands: brandName ? [brandName] : [] }); }
               else { const entry = groupedResults.get(key); if (brandName && !entry.brands.includes(brandName)) entry.brands.push(brandName); }
            });
           let finalSuggestions = Array.from(groupedResults.values()).slice(0, MAX_SUGGESTIONS);
           finalSuggestions.forEach((entry, index) => {
               const itemData = entry.primary;
               const ingredientsDisplay = (itemData.ingredients || []).join(' / '); const formDisplay = itemData.dosage_form || ''; const strengthDisplay = itemData.strength || '';
               const mainText = `${ingredientsDisplay} ${strengthDisplay}${formDisplay ? ` (${formDisplay})` : ''}`.trim();
               const displayedBrands = entry.brands.slice(0, MAX_BRANDS_DISPLAY); const remainingBrandsCount = entry.brands.length - displayedBrands.length;
               const $suggestionDiv = $('<div class="suggestion-item">').data('rawMedData', itemData); // Store raw data
               $suggestionDiv.append($('<span class="suggestion-med-name">').text(mainText));
               if (displayedBrands.length > 0) {
                    let brandText = 'Brands: ' + displayedBrands.join(' / '); if (remainingBrandsCount > 0) brandText += ` (+${remainingBrandsCount} more)`;
                    $suggestionDiv.append($('<span class="suggestion-brands">').html(brandText)); }
               $suggestionDiv.on('mousedown', (event) => { // Use mousedown to prevent input blur before click registers
                   event.preventDefault(); // Crucial to prevent blur
                   const selectedData = $suggestionDiv.data('rawMedData');
                   currentSelectionData = selectedData; // ** Store selected data globally temporarily **
                   const inputText = `${(selectedData.ingredients || []).join(' / ')} ${selectedData.strength || ''}${selectedData.dosage_form ? ` (${selectedData.dosage_form})` : ''}`.trim();
                   $input.val(inputText).trigger('change'); // Update input
                   $input.data('selectedIngredients', selectedData.ingredients || null); // ** Store ingredients **
                   $input.data('manualEntry', false); // Mark as NOT manual

                   const $row = $input.closest('.medication-entry-row'); const $formSelect = $row.find('.medication-dosage-form');
                   const normalizedForm = (selectedData.dosage_form || '').toLowerCase(); let formMatched = false;
                   $formSelect.find('option').each(function() { const optionValue = $(this).val().toLowerCase();
                       if(optionValue && (normalizedForm.includes(optionValue) || optionValue.includes(normalizedForm))) { $formSelect.val($(this).val()); formMatched = true; return false; } });
                   populateUnitOptions($formSelect);
                   $row.find('.sig-quantity').focus();
                   $box.empty().hide();
               });
               $suggestionDiv.on('mouseenter', () => { $box.find('.suggestion-item').removeClass('selected'); $suggestionDiv.addClass('selected'); currentIndex = $suggestionDiv.index('.suggestion-item:not(.manual-entry)'); }); // Index only selectable items
               $box.append($suggestionDiv); suggestions.push($suggestionDiv);
            });
           $box.append('<div class="suggestion-item manual-entry">Can’t find your med? <strong>Enter manually</strong></div>');
           positionBox(); }
        function findMatchingDrugs(query) { /* ... search logic ... */
           const terms = query.toLowerCase().split(/\s+/).filter(Boolean); if (!terms.length) { displaySuggestions([]); return; }
           const matches = compiledDrugData.filter(item => {
                const searchBrand = (item._search_brand || item.brand_name || '').toLowerCase(); const searchIngredients = (item._search_ingredients || (item.ingredients || []).join(' ')).toLowerCase();
                const searchStrength = (item.strength || '').toLowerCase(); const searchableText = `${searchBrand} ${searchIngredients} ${searchStrength}`;
                return terms.every(term => searchableText.includes(term)); });
           displaySuggestions(matches); }

        // INPUT EVENT LISTENERS
        $input.on('input', () => { clearTimeout(debounceTimer); const query = $input.val().trim();
             // ** Clear stored selection data if user types **
             currentSelectionData = null; $input.removeData('selectedIngredients'); $input.removeData('manualEntry');
             if (query.length < 2) { $box.empty().hide(); return; }
             debounceTimer = setTimeout(() => { findMatchingDrugs(query); }, 250); });

        $input.on('keydown', (e) => { // ** REVISED Enter Key Handling **
            if (!$box.is(':visible')) return;

            const $selectableItems = $box.find('.suggestion-item:not(.manual-entry)'); // Exclude manual entry from keyboard nav
            const numItems = $selectableItems.length;

             if (numItems > 0) M { // Check if there are actual medication suggestions
                 if (e.key === 'ArrowDown') {
                     e.preventDefault();
                     currentIndex = (currentIndex + 1) % numItems;
                     $selectableItems.removeClass('selected').eq(currentIndex).addClass('selected')[0]?.scrollIntoView({ block: 'nearest' });
                 } else if (e.key === 'ArrowUp') {
                     e.preventDefault();
                     currentIndex = (currentIndex - 1 + numItems) % numItems;
                     $selectableItems.removeClass('selected').eq(currentIndex).addClass('selected')[0]?.scrollIntoView({ block: 'nearest' });
                 } else if (e.key === 'Enter') {
                     e.preventDefault(); // ** PREVENT FORM SUBMIT **
                     if (currentIndex >= 0 && currentIndex < numItems) {
                         // Simulate click ONLY on the selected medication item
                         $selectableItems.eq(currentIndex).trigger('mousedown');
                         console.log("Enter selected item:", currentIndex);
                     } else {
                         // Enter pressed, but no item selected - maybe just close the box?
                         console.log("Enter pressed with no selection");
                         $box.empty().hide();
                     }
                 } else if (e.key === 'Tab') {
                     // Allow tab to potentially move focus away, hide box if item selected
                     if (currentIndex >= 0 && currentIndex < numItems) {
                       $selectableItems.eq(currentIndex).trigger('mousedown'); // Select item before tabbing away
                       // Don't prevent default for tab
                     }
                     $box.empty().hide(); // Hide on tab out
                 } else if (e.key === 'Escape') {
                     e.preventDefault();
                     $box.empty().hide();
                     currentSelectionData = null; // Clear selection on escape
                 }
             } else if(e.key === 'Enter'){
                // Box is visible, but no suggestions (only "No results" or manual entry)
                e.preventDefault(); // Still prevent submission
                $box.empty().hide(); // Just close the box
            }
        });

         $input.on('focus', () => { const currentValue = $input.val().trim(); if (currentValue.length >= 2) findMatchingDrugs(currentValue); });
         $input.on('blur', () => { setTimeout(() => { if (!$box.is(':hover')) { $box.empty().hide();}}, 200); });
         // Manual entry delegated handler
         $(document).on('mousedown', '.suggestion-item.manual-entry', function(event) {
              event.preventDefault(); const customMed = prompt("Enter the full medication name and strength:");
              if (customMed && customMed.trim() !== '') {
                   const $targetInput = $('#medicationDrugField_0'); $targetInput.val(customMed.trim()).trigger('change');
                   const $row = $targetInput.closest('.medication-entry-row'); $row.find('.medication-dosage-form').prop('selectedIndex', 0);
                   $row.find('.sig-unit').empty().append('<option value="">-- Select Form First --</option>').prop('disabled', true);
                   $targetInput.data('manualEntry', true); // Flag as manual
                   $targetInput.removeData('selectedIngredients'); // Clear ingredient data
                   currentSelectionData = null; // Clear temp global data
                   $row.find('.medication-dosage-form').focus(); }
               $('#medicationSuggestionBox').empty().hide(); });
    }


    // ======================================================================
    //             Medication List & SIG Management
    // ======================================================================
    function renderMedicationList() { // ** UPDATED for Combo **
        const $container = $('#medicationsListContainer').empty();
        if (!currentMedications.length) { $container.html('<p>No medications added yet.</p>'); return; }

        currentMedications.forEach((medication, index) => {
            // ** Combo Check Logic (Uses stored ingredients) **
            const hasSlash = medication.drug.includes('/');
            const hasMultipleIngredients = medication.ingredients && Array.isArray(medication.ingredients) && medication.ingredients.length > 1;
            const isCombination = hasSlash || hasMultipleIngredients;
            const itemClass = isCombination ? 'combination-med' : 'single-med';

            const $itemDiv = $(`<div class="added-medication-item ${itemClass}">`).attr('data-index', index);
            if (isCombination) { $itemDiv.append('<span class="badge combo">Combo</span>'); }
            const sigString = medication.sig_string || 'SIG missing';
            const displayText = `${medication.drug} – SIG: ${sigString}`;
            // ** Use specific class for text span **
             $itemDiv.append($('<span class="med-display-text">').text(displayText));
             const $removeButton = $('<button type="button">Remove</button>').on('click', () => { removeMedication(index); });
            $itemDiv.append($removeButton);
            $container.append($itemDiv);
        });
    }

    function addMedicationToList() { // ** UPDATED for Combo **
        const $row = $('#medicationRow_0');
        const $drugInput = $row.find('.medication-drug-input');
        const drugName = $drugInput.val().trim();
        const dosageForm = $row.find('.medication-dosage-form').val();
        const sigData = { quantity: $row.find('.sig-quantity').val(), unit: $row.find('.sig-unit').val(), frequency: $row.find('.sig-frequency').val(), additional: $row.find('.sig-additional').val().trim() };

        // --- Validations ---
        if (!drugName) { alert("Please enter or select a medication name."); $drugInput.focus(); return false; }
        if (!dosageForm) { alert("Please select a dosage form."); $row.find('.medication-dosage-form').focus(); return false; }
        if (!sigData.quantity || !sigData.unit || !sigData.frequency) { alert("Please fill in Quantity, Unit, and Frequency for the SIG."); /* focus logic */ return false; }
        if (sigData.frequency === 'other' && !sigData.additional) { alert("Please specify the frequency details..."); $row.find('.sig-additional').focus(); return false; }
        if (parseFloat(sigData.quantity) > 4 && sigData.unit && (sigData.unit.toLowerCase().includes('tablet') || sigData.unit.toLowerCase().includes('capsule'))) {
            if (!confirm(`⚠️ You entered ${sigData.quantity} ${sigData.unit}. Is this correct?`)) { $row.find('.sig-quantity').focus(); return false; } }

        // --- Build SIG string ---
        let action = "Take"; const formLower = (dosageForm || '').toLowerCase();
        if (formLower.includes('topical') || formLower.includes('patch')) action = "Apply"; else if (formLower.includes('drop')) action = "Instill"; else if (formLower.includes('inhaler') || formLower.includes('spray')) action = "Use"; else if (formLower.includes('injection')) action = "Inject"; else if (formLower.includes('suppository')) action = "Insert";
        let sigString = `${action} ${sigData.quantity} ${sigData.unit}`;
        if (sigData.frequency === 'other') { sigString += ` ${sigData.additional || 'as directed'}`; }
        else { sigString += ` ${sigData.frequency}`; if (sigData.additional) sigString += ` ${sigData.additional}`; }
        sigString = sigString.trim().replace(/\s+/g, ' ');

        // --- Prepare medication object ---
         // ** Get ingredients from stored data if available **
        let ingredients = $drugInput.data('selectedIngredients') || null;
        // Double check if names match the temporary global selection (more robust)
//        if (currentSelectionData && currentSelectionData.drug === drugName) { // Might be too complex if user edits name
//           ingredients = currentSelectionData.ingredients;
//        }
         const medication = {
             drug: drugName,
             dosageForm: dosageForm,
             sig_structured: sigData,
             sig_string: sigString,
             manualEntry: $drugInput.data('manualEntry') || false,
             ingredients: ingredients // ** Include ingredients for combo check **
          };

        currentMedications.push(medication);
        saveToHistory(medication); // Pass the whole object to save
        loadHistoryList();
        renderMedicationList();

        // --- Clear fields ---
        $drugInput.val('').removeData('manualEntry').removeData('selectedIngredients').focus();
        currentSelectionData = null; // Clear temp global data
        $row.find('.medication-dosage-form').prop('selectedIndex', 0);
        $row.find('.sig-quantity, .sig-additional').val('');
        $row.find('.sig-unit').empty().append('<option value="">-- Select Form First --</option>').prop('disabled', true);
        $row.find('.sig-frequency').prop('selectedIndex', 0);

        return true;
    }

    function removeMedication(index) { if (index >= 0 && index < currentMedications.length) { currentMedications.splice(index, 1); renderMedicationList(); } }

    // ======================================================================
    //                       Document Ready
    // ======================================================================
    $(document).ready(function(){
        $('#firstName, #dob').on('change', loadHistoryList);
        $('#loadingMessage').show();
        $.getJSON(COMPILED_DATA_URL) /* ... .done() ... */
         .done(function(data){ $('#loadingMessage').hide(); if (!Array.isArray(data) || data.length === 0) { console.error("Loaded drug data invalid."); $('#errorMessage').text("Error: Could not load medication list.").show(); return; }
             console.log(`Loaded ${data.length} drug records.`); compiledDrugData = data;
             $('#medicationDrugField_0').prop('disabled', false).attr('placeholder', 'Start typing medication name...'); attachMedAutocomplete($('#medicationDrugField_0')); })
         .fail(function(jqXHR, textStatus, errorThrown){ $('#loadingMessage').hide(); $('#errorMessage').text(`Error loading medication data: ${textStatus}. Please try refreshing.`).show(); console.error("Failed to load drug data:", textStatus, errorThrown); });
        $('#dob').on('change', function(){ /* ... age calc ... */
            const dobValue = $(this).val();if (!dobValue) { $('#age').val(''); return; } const dob = new Date(dobValue); const today = new Date(); if (isNaN(dob.getTime()) || dob > today) { $('#age').val(''); return; }
            let age = today.getFullYear() - dob.getFullYear(); const monthDiff = today.getMonth() - dob.getMonth(); if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) { age--; } $('#age').val(age >= 0 ? age : '');
         }).trigger('change');
        $('#medicationEntryArea').on('change', '.medication-dosage-form', function(){ populateUnitOptions($(this)); });
        $('#medicationEntryArea').on('keydown', '.sig-quantity', function(e) { if (e.key === 'Enter') { e.preventDefault(); $(this).closest('.medication-entry-row').find('.add-current-med-button').focus(); } });
        $('#medicationEntryArea').on('click', '.add-current-med-button', function(){ addMedicationToList(); });
        $('#patientForm').submit(function(e){ e.preventDefault(); /* ... gather data ... */
            const formData = { patient: { firstName: $('#firstName').val().trim(), lastName: $('#lastName').val().trim(), dob: $('#dob').val(), age: $('#age').val() },
             medications: currentMedications.map(med => ({ drug: med.drug, dosageForm: med.dosageForm, sig_string: med.sig_string, manualEntry: med.manualEntry, /* Optionally add ingredients: med.ingredients */ })) };
             if (!formData.patient.firstName || !formData.patient.dob) { alert("Please enter patient's First Name and Date of Birth."); return; } if(formData.medications.length===0){ alert("Please add at least one medication."); return; }
             console.log("SUBMITTING FORM DATA:", JSON.stringify(formData, null, 2)); alert("Form data ready (see console log). Implement AJAX submission."); /* TODO: AJAX Call Here */ });
        renderMedicationList(); loadHistoryList();
    });
</script>
</body>
</html>
