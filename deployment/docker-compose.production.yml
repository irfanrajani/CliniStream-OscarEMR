# NextScript OSCAR EMR Deployment - Production (Pre-built Images)
# Uses pre-built images from GitHub Container Registry - NO LOCAL BUILD REQUIRED

services:
  # MariaDB Database
  db:
    image: mariadb:10.5
    container_name: nextscript-db
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: oscar_nextscript
      MYSQL_USER: oscar
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      TZ: America/Vancouver
    volumes:
      - db-data:/var/lib/mysql
      - ./init-db:/docker-entrypoint-initdb.d
    networks:
      - oscar-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 30s
      timeout: 10s
      retries: 5

  # OSCAR EMR Application (PRE-BUILT IMAGE - NO BUILD TIME!)
  oscar:
    image: ghcr.io/irfanrajani/clinistream-oscaremr/oscar-emr:latest
    container_name: nextscript-oscar
    pull_policy: always
    environment:
      TZ: America/Vancouver
      MYSQL_HOST: db
      MYSQL_DATABASE: oscar_nextscript
      MYSQL_USER: oscar
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      CLINIC_NAME: ${CLINIC_NAME:-NextScript}
      FIRST_RUN: ${FIRST_RUN:-true}
      TRUST_PROXY: "true"
      CLOUDFLARE_PROXY: "true"
    volumes:
      - oscar-documents:/var/lib/OscarDocument
      - oscar-config:/etc/oscar
      - ./config:/config
    ports:
      - "8567:8080"
    networks:
      - oscar-network
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/oscar/"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 120s

  # First-Run Setup Wizard
  setup-wizard:
    image: ghcr.io/irfanrajani/clinistream-oscaremr/setup-wizard:latest
    container_name: nextscript-setup
    pull_policy: always
    environment:
      OSCAR_API_URL: http://oscar:8080/oscar
      DB_HOST: db
      DB_DATABASE: oscar_nextscript
      DB_USER: oscar
      DB_PASSWORD: ${MYSQL_PASSWORD}
    ports:
      - "8568:3000"
    networks:
      - oscar-network
    depends_on:
      - db
      - oscar
    restart: unless-stopped
    profiles:
      - setup

  # Integration Services
  integrations:
    image: ghcr.io/irfanrajani/clinistream-oscaremr/integrations:latest
    container_name: nextscript-integrations
    pull_policy: always
    environment:
      OSCAR_API_URL: http://oscar:8080/oscar
      DB_HOST: db
      DB_DATABASE: oscar_nextscript
      DB_USER: oscar
      DB_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - integration-logs:/var/log/integrations
      - oscar-documents:/var/lib/OscarDocument:rw
    networks:
      - oscar-network
    depends_on:
      - oscar
    restart: unless-stopped

  # Backup Service
  backup:
    image: ghcr.io/irfanrajani/clinistream-oscaremr/backup:latest
    container_name: nextscript-backup
    pull_policy: always
    environment:
      MYSQL_HOST: db
      MYSQL_DATABASE: oscar_nextscript
      MYSQL_USER: root
      MYSQL_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      BACKUP_SCHEDULE: ${BACKUP_SCHEDULE:-0 2 * * *}
      BACKUP_DIR: /backups
      DOCUMENT_DIR: /var/lib/OscarDocument
      BACKUP_RETENTION_DAYS: ${BACKUP_RETENTION_DAYS:-30}
      S3_BACKUP_ENABLED: ${S3_BACKUP_ENABLED:-false}
      S3_BUCKET: ${S3_BACKUP_BUCKET:-}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      AWS_REGION: ${AWS_REGION:-us-west-2}
    volumes:
      - backup-data:/backups
      - oscar-documents:/var/lib/OscarDocument:ro
    networks:
      - oscar-network
    depends_on:
      - db
    restart: unless-stopped

networks:
  oscar-network:
    driver: bridge

volumes:
  db-data:
    driver: local
  oscar-documents:
    driver: local
  oscar-config:
    driver: local
  integration-logs:
    driver: local
  backup-data:
    driver: local
